<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #e2e8f0);
            padding-bottom: 120px; /* Space for the fixed bottom nav */
        }
        .card {
            min-height: 180px;
            cursor: pointer;
            transition: transform 0.6s ease, box-shadow 0.3s ease;
            transform-style: preserve-3d;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card.flipped {
            transform: rotateY(180deg);
        }
        .card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 24px;
            border-radius: 20px;
            background-color: #ffffff;
            color: #1f2937;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }

        .fixed-bottom-nav-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 50;
        }
        .fixed-bottom-nav {
            background-color: #1f2937;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .nav-btn {
            background-color: transparent;
            color: #ffffff;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 50%;
        }
        .nav-btn.active {
            background-color: #3b82f6;
        }
        .nav-btn:hover {
            color: #d1d5db;
        }
        .nav-btn:active {
            transform: scale(0.9);
        }
        .nav-btn.center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%) translateY(-90%);
            width: 72px;
            height: 72px;
            background-color: #3b82f6;
            border-radius: 50%;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            transition: transform 0.3s ease;
        }
        .nav-btn.center:hover {
            transform: translateX(-50%) translateY(-95%) scale(1.05);
        }
        .nav-btn.center:active {
            transform: translateX(-50%) translateY(-90%) scale(0.9);
        }
        .review-button-group .icon-button {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            transition: all 0.2s ease-in-out;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .review-button-group .icon-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .review-button-group .icon-button:active {
            transform: scale(0.9);
        }
        
        .review-button-group .icon-button.green {
            background-color: #22c55e;
        }
        
        .review-button-group .icon-button.red {
            background-color: #ef4444;
        }

        .daily-list-item {
            display: flex;
            flex-direction: column;
            background-color: #f1f5f9;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .daily-list-item:hover {
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-slide-up {
            animation: fadeInSlideUp 0.5s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes fadeOutScale {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.8); /* Made the pop-out more dramatic */
            }
        }
        
        .modal-content, .settings-modal-content {
            animation: fadeInScale 0.3s ease-out forwards;
        }
        
        .modal-content.animate-out, .settings-modal-content.animate-out {
            animation: fadeOutScale 0.3s ease-in forwards;
        }
        
        .generic-btn {
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        
        .generic-btn:active {
            transform: scale(0.98);
        }

        .lesson-card {
            transition: transform 0.2s ease;
            position: relative;
        }

        .lesson-card:active {
            transform: scale(0.98);
        }

        .lesson-actions {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .lesson-card.active .lesson-actions {
            visibility: visible;
            opacity: 1;
        }

        .action-button {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            padding: 8px;
            transition: background-color 0.2s;
        }
        .action-button:hover {
            background: rgba(255, 255, 255, 1);
        }
        .action-button:active {
            transform: scale(0.9);
        }

        .settings-button-v2 {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
            padding: 1rem 1.5rem;
            min-height: 80px;
            border-radius: 3rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .settings-button-v2:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .settings-button-v2:active {
            transform: scale(0.98);
        }

        .icon-large {
            width: 32px;
            height: 32px;
            margin-right: 1rem;
        }

        /* New styles for the settings modals */
        .settings-option {
            background-color: #f1f5f9;
            border-radius: 20px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .settings-option:hover {
            background-color: #e2e8f0;
        }
        .settings-option.selected {
            background-color: #d1e1f5;
            border: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl p-6 md:p-10 mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">Flashcard App</h1>
        
        <!-- Main Content Sections -->
        
        <!-- Daily Suggestions Section -->
        <div id="daily-section" class="section active">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700">Today's Suggestions</h2>
                <button id="toggle-daily-btn" class="generic-btn px-4 py-2 bg-gray-200 rounded-full font-bold text-sm hover:bg-gray-300 transition-colors">Hide Cards</button>
            </div>
            <div id="daily-content-wrapper">
                <div id="daily-loading" class="text-center text-gray-500 font-semibold text-lg">Loading cards...</div>
                <div id="daily-empty-message" class="hidden text-center text-gray-600 p-6 rounded-lg bg-blue-50 border-2 border-dashed border-blue-200">
                    <p class="font-bold text-lg mb-2">No suggestions available!</p>
                    <p>To get started, please add your first flashcard by navigating to the <strong class="text-blue-600">Add</strong> tab at the bottom of the screen.</p>
                </div>
                <div id="daily-card-list" class="flex flex-col gap-4">
                    <!-- Flashcards will be rendered here as a list -->
                </div>
                <!-- Load more button -->
                <button id="load-more-btn" class="hidden generic-btn w-full mt-6 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full font-bold shadow-md hover:from-blue-600 hover:to-blue-700 transition-all flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw"><path d="M21 12a9 9 0 1 1-9-9c2.87 0 5.42 1.15 7.37 3L21 6"/><path d="M21 3v3h-3"/></svg>
                    <span>Load more</span>
                </button>
            </div>
        </div>

        <!-- My Lessons Section -->
        <div id="lessons-section" class="section">
            <!-- This container shows the list of all lessons -->
            <div id="lessons-list-view">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">My Lessons</h2>
                <div id="lessons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Lessons will be rendered here -->
                </div>
            </div>

            <!-- This container shows cards for a specific lesson -->
            <div id="lesson-cards-view" class="hidden">
                <h2 id="lesson-title" class="text-2xl font-bold text-gray-700 mb-4"></h2>
                <button id="back-to-lessons-btn" class="generic-btn mb-6 px-6 py-2 bg-gray-200 rounded-full font-bold hover:bg-gray-300 transition-colors">← Back to All Lessons</button>
                <div id="lesson-card-container" class="grid grid-cols-1 gap-4">
                    <!-- Cards for the selected lesson will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Add New Section -->
        <div id="add-section" class="section">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Add a New Flashcard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add New Lesson Card -->
                <div class="bg-gray-100 p-6 md:p-8 rounded-2xl shadow-inner">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Add a New Lesson</h3>
                    <form id="add-lesson-form">
                        <div class="mb-4">
                            <label for="new-lesson-name" class="block text-gray-700 font-bold mb-2">New Lesson Name:</label>
                            <input type="text" id="new-lesson-name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" placeholder="Enter lesson name here" required>
                        </div>
                        <button type="submit" class="generic-btn w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full font-bold shadow-md hover:from-blue-600 hover:to-blue-700 transition-all">Create Lesson</button>
                    </form>
                </div>

                <!-- Add Card to Lesson Card -->
                <div class="bg-gray-100 p-6 md:p-8 rounded-2xl shadow-inner">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Add a Flashcard to a Lesson</h3>
                    <form id="add-card-form">
                        <div class="mb-4">
                            <label for="lesson-select" class="block text-gray-700 font-bold mb-2">Select a Lesson:</label>
                            <select id="lesson-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" required>
                                <option value="">Select a lesson</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="card-question" class="block text-gray-700 font-bold mb-2">Question (Front):</label>
                            <textarea id="card-question" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" rows="2" placeholder="Enter question here" required></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="card-answer" class="block text-gray-700 font-bold mb-2">Answer (Back):</label>
                            <textarea id="card-answer" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" rows="4" placeholder="Enter answer here" required></textarea>
                        </div>
                        <button type="submit" class="generic-btn w-full px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-full font-bold shadow-md hover:from-green-600 hover:to-green-700 transition-all">Add Flashcard</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="history-section" class="section">
            <h2 class="text-2xl font-bold text-gray-700 text-center mb-6">Review History</h2>
            <div id="history-list" class="flex flex-col space-y-4">
                <!-- History items will be rendered here -->
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="section">
            <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Settings</h2>

            <!-- Main settings buttons -->
            <div id="main-settings-view">
                <div class="flex flex-col gap-4">
                    <button id="settings-backup-import-btn" class="settings-button-v2 bg-blue-500 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive icon-large"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><polyline points="10 12 12 14 14 12"/></svg>
                        <span class="font-bold text-lg">Backup & Import</span>
                    </button>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="settings-theme-btn" class="settings-button-v2 bg-purple-500 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-palette icon-large"><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><path d="M4.6 20.4a1.5 1.5 0 0 0 2.7.2c.3-.4.7-.7 1.2-1a4 4 0 0 1 3.2-3c.4-.1.8-.2 1.3-.2a.7.7 0 0 1 .5.2c.3.3.6.4 1.1.4A4.5 4.5 0 0 0 18 16.5c.3-1 .8-1.7 1.6-2.3a1.5 1.5 0 0 0 .2-2.7c-.4-.3-.7-.7-1-1.2a4 4 0 0 1-3-3.2c-.1-.4-.2-.8-.2-1.3a.7.7 0 0 1-.2-.5c-.3-.3-.4-.6-.4-1.1A4.5 4.5 0 0 0 6 6.5c-1 0-1.7.3-2.3.8a1.5 1.5 0 0 0-2.7-.2c.3.4.7.7 1.2 1a4 4 0 0 1 3.2 3c.4.1.8.2 1.3.2a.7.7 0 0 1 .5-.2c.3-.3.6-.4 1.1-.4A4.5 4.5 0 0 0 18 7.5c1 0 1.7-.3 2.3-.8a1.5 1.5 0 0 0 .2 2.7c-.4.3-.7.7-1 1.2a4 4 0 0 1-3 3.2c-.4.1-.8.2-1.3.2a.7.7 0 0 1-.5.2c-.3.3-.6.4-1.1.4A4.5 4.5 0 0 0 6 17.5c-1 0-1.7-.3-2.3-.8a1.5 1.5 0 0 0-.2 2.7Z"/></svg>
                            <span class="font-bold text-lg">Theme</span>
                        </button>
                        <button id="settings-language-btn" class="settings-button-v2 bg-green-500 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe icon-large"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                            <span class="font-bold text-lg">Language</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Alert Modal -->
        <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
            <div id="modal-content" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm text-center transform transition-transform duration-300">
                <p id="modal-message" class="text-lg md:text-xl text-gray-800 mb-6"></p>
                <button id="modal-close-btn" class="generic-btn px-8 py-3 bg-blue-500 text-white rounded-full font-bold shadow-md hover:bg-blue-600 transition-colors">OK</button>
            </div>
        </div>

        <!-- Backup & Import Modal -->
        <div id="backup-import-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
            <div id="backup-import-modal-content" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md text-center transform transition-transform duration-300">
                <h3 class="text-2xl font-bold mb-6">Backup & Import</h3>
                <div class="flex flex-col gap-6">
                    <div class="bg-gray-100 p-6 rounded-2xl shadow-inner">
                        <h4 class="text-xl font-bold text-gray-700 mb-4">Backup Data</h4>
                        <p class="text-gray-600 text-sm mb-4">Save all your flashcards and lessons to a local JSON file.</p>
                        <button id="backup-btn" class="generic-btn w-full px-6 py-3 bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-full font-bold shadow-md hover:from-teal-600 hover:to-teal-700 transition-all">Backup Data</button>
                    </div>
                    
                    <div class="bg-gray-100 p-6 rounded-2xl shadow-inner">
                        <h4 class="text-xl font-bold text-gray-700 mb-4">Import Data</h4>
                        <p class="text-gray-600 text-sm mb-4">Select a JSON file to import lessons and cards.</p>
                        <input type="file" id="import-file-input" accept=".json" class="w-full mb-4 text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <button id="import-btn" class="generic-btn w-full px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full font-bold shadow-md hover:from-purple-600 hover:to-purple-700 transition-all">Import Data</button>
                    </div>
                </div>
                <button id="back-from-backup-btn" class="generic-btn mt-6 px-6 py-2 bg-gray-200 rounded-full font-bold hover:bg-gray-300 transition-colors">← Back</button>
            </div>
        </div>

        <!-- Theme Modal -->
        <div id="theme-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
            <div id="theme-modal-content" class="settings-modal-content bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm transform transition-transform duration-300">
                <h3 class="text-2xl font-bold mb-6 text-center">Theme</h3>
                <div class="flex flex-col gap-4">
                    <div class="settings-option selected">
                        <span class="font-medium text-gray-800">System Default</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-blue-500"><path d="M20 6 9 17l-5-5"/></svg>
                    </div>
                    <div class="settings-option">
                        <span class="font-medium text-gray-800">Light</span>
                    </div>
                    <div class="settings-option">
                        <span class="font-medium text-gray-800">Dark</span>
                    </div>
                </div>
                <button id="back-from-theme-btn" class="generic-btn mt-6 w-full px-6 py-3 bg-gray-200 rounded-full font-bold hover:bg-gray-300 transition-colors">Done</button>
            </div>
        </div>

        <!-- Language Modal -->
        <div id="language-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
            <div id="language-modal-content" class="settings-modal-content bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm transform transition-transform duration-300">
                <h3 class="text-2xl font-bold mb-6 text-center">Language</h3>
                <div class="flex flex-col gap-4">
                    <div class="settings-option selected">
                        <span class="font-medium text-gray-800">English</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-blue-500"><path d="M20 6 9 17l-5-5"/></svg>
                    </div>
                    <div class="settings-option">
                        <span class="font-medium text-gray-800">Español</span>
                    </div>
                    <div class="settings-option">
                        <span class="font-medium text-gray-800">Français</span>
                    </div>
                </div>
                <button id="back-from-language-btn" class="generic-btn mt-6 w-full px-6 py-3 bg-gray-200 rounded-full font-bold hover:bg-gray-300 transition-colors">Done</button>
            </div>
        </div>

        <!-- Edit Lesson Name Modal -->
        <div id="edit-lesson-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
            <div id="edit-lesson-modal-content" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm text-center transform transition-transform duration-300">
                <h3 class="text-2xl font-bold mb-4">Edit Lesson Name</h3>
                <form id="edit-lesson-form">
                    <div class="mb-6">
                        <label for="edit-lesson-name-input" class="block text-gray-700 font-bold mb-2">New Lesson Name:</label>
                        <input type="text" id="edit-lesson-name-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" placeholder="Enter new name" required>
                    </div>
                    <div class="flex justify-around space-x-4">
                        <button type="button" id="edit-cancel-btn" class="generic-btn flex-1 px-6 py-3 bg-gray-200 text-gray-800 rounded-full font-bold shadow-md hover:bg-gray-300 transition-colors">Cancel</button>
                        <button type="submit" class="generic-btn flex-1 px-6 py-3 bg-blue-500 text-white rounded-full font-bold shadow-md hover:bg-blue-600 transition-all">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal for Deletion -->
        <div id="confirm-modal-container" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden p-4">
            <div id="confirm-modal-content" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-sm text-center transform transition-transform duration-300">
                <p id="confirm-message" class="text-lg md:text-xl text-gray-800 mb-6">Are you sure you want to delete this lesson and all its cards?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-cancel-btn" class="generic-btn px-8 py-3 bg-gray-200 text-gray-800 rounded-full font-bold shadow-md hover:bg-gray-300 transition-colors">Cancel</button>
                    <button id="confirm-delete-btn" class="generic-btn px-8 py-3 bg-red-500 text-white rounded-full font-bold shadow-md hover:bg-red-600 transition-colors">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Navigation Container -->
    <div class="fixed-bottom-nav-container">
        <div class="fixed-bottom-nav">
            <button id="nav-daily" class="nav-btn active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </button>
            <button id="nav-lessons" class="nav-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </button>
            <div class="w-16 h-12"></div> <!-- Spacer for the central button -->
            <button id="nav-heart" class="nav-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            </button>
            <button id="nav-settings" class="nav-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.39a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.39a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
        <button id="nav-add" class="nav-btn center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navDaily = document.getElementById('nav-daily');
            const navLessons = document.getElementById('nav-lessons');
            const navAdd = document.getElementById('nav-add');
            const navHeart = document.getElementById('nav-heart');
            const navSettings = document.getElementById('nav-settings');
            const dailySection = document.getElementById('daily-section');
            const lessonsSection = document.getElementById('lessons-section');
            const addSection = document.getElementById('add-section');
            const historySection = document.getElementById('history-section');
            const settingsSection = document.getElementById('settings-section');
            const dailyCardList = document.getElementById('daily-card-list');
            const dailyLoading = document.getElementById('daily-loading');
            const dailyEmptyMessage = document.getElementById('daily-empty-message');
            const lessonsList = document.getElementById('lessons-list');
            const historyList = document.getElementById('history-list');
            const loadMoreBtn = document.getElementById('load-more-btn');

            const lessonsListView = document.getElementById('lessons-list-view');
            const lessonCardsView = document.getElementById('lesson-cards-view');
            const lessonTitle = document.getElementById('lesson-title');
            const backToLessonsBtn = document.getElementById('back-to-lessons-btn');
            const lessonCardContainer = document.getElementById('lesson-card-container');

            const addLessonForm = document.getElementById('add-lesson-form');
            const newLessonNameInput = document.getElementById('new-lesson-name');
            const addCardForm = document.getElementById('add-card-form');
            const lessonSelect = document.getElementById('lesson-select');
            const cardQuestionInput = document.getElementById('card-question');
            const cardAnswerInput = document.getElementById('card-answer');

            // New settings buttons
            const mainSettingsView = document.getElementById('main-settings-view');
            const settingsBackupImportBtn = document.getElementById('settings-backup-import-btn');
            const settingsThemeBtn = document.getElementById('settings-theme-btn');
            const settingsLanguageBtn = document.getElementById('settings-language-btn');
            
            // Backup and Import
            const backupImportModalContainer = document.getElementById('backup-import-modal-container');
            const backupImportModalContent = document.getElementById('backup-import-modal-content');
            const backupBtn = document.getElementById('backup-btn');
            const importFileInput = document.getElementById('import-file-input');
            const importBtn = document.getElementById('import-btn');
            const backFromBackupBtn = document.getElementById('back-from-backup-btn');

            // Theme and Language Modals
            const themeModalContainer = document.getElementById('theme-modal-container');
            const themeModalContent = document.getElementById('theme-modal-content');
            const backFromThemeBtn = document.getElementById('back-from-theme-btn');
            const languageModalContainer = document.getElementById('language-modal-container');
            const languageModalContent = document.getElementById('language-modal-content');
            const backFromLanguageBtn = document.getElementById('back-from-language-btn');


            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            const toggleDailyBtn = document.getElementById('toggle-daily-btn');
            const dailyContentWrapper = document.getElementById('daily-content-wrapper');
            
            // New UI Elements for Edit/Delete functionality
            const editLessonModalContainer = document.getElementById('edit-lesson-modal-container');
            const editLessonModalContent = document.getElementById('edit-lesson-modal-content');
            const editLessonNameInput = document.getElementById('edit-lesson-name-input');
            const editLessonForm = document.getElementById('edit-lesson-form');
            const editCancelBtn = document.getElementById('edit-cancel-btn');
            const confirmModalContainer = document.getElementById('confirm-modal-container');
            const confirmModalContent = document.getElementById('confirm-modal-content');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            let allCards = [];
            let lessons = [];
            let dailySuggestions = []; // Cards currently displayed
            let dailyPool = []; // All eligible cards for today
            const DAILY_INITIAL_COUNT = 10;
            const LOAD_MORE_COUNT = 5;
            let currentLessonId;

            const CARD_STORAGE_KEY = 'flashcards_app_cards';
            const LESSON_STORAGE_KEY = 'flashcards_app_lessons';
            const DAILY_STATE_KEY = 'flashcard_daily_state';

            // Utility function to shuffle an array
            const shuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            // Function to show a custom modal with a message
            const showModal = (message) => {
                modalMessage.textContent = message;
                modalContainer.classList.remove('hidden');
                modalContent.classList.remove('animate-out');
                modalContent.classList.add('modal-content');
            };
            
            // Function to show the editing modal
            const showEditModal = () => {
                editLessonModalContainer.classList.remove('hidden');
                editLessonModalContent.classList.remove('animate-out');
                editLessonModalContent.classList.add('modal-content');
            };
            
            // Function to show the confirmation modal
            const showConfirmModal = () => {
                confirmModalContainer.classList.remove('hidden');
                confirmModalContent.classList.remove('animate-out');
                confirmModalContent.classList.add('modal-content');
            };

            // Function to show the backup/import modal
            const showBackupImportModal = () => {
                backupImportModalContainer.classList.remove('hidden');
                backupImportModalContent.classList.remove('animate-out');
                backupImportModalContent.classList.add('modal-content');
            };

            // Function to show the theme modal
            const showThemeModal = () => {
                themeModalContainer.classList.remove('hidden');
                themeModalContent.classList.remove('animate-out');
                themeModalContent.classList.add('settings-modal-content');
            };
            
            // Function to show the language modal
            const showLanguageModal = () => {
                languageModalContainer.classList.remove('hidden');
                languageModalContent.classList.remove('animate-out');
                languageModalContent.classList.add('settings-modal-content');
            };

            // Function to hide the custom modal with animation
            const hideModal = () => {
                modalContent.classList.add('animate-out');
                modalContent.classList.remove('modal-content');
                setTimeout(() => {
                    modalContainer.classList.add('hidden');
                }, 300); // Duration matches CSS animation
            };
            
            // Function to hide the editing modal with animation
            const hideEditModal = () => {
                editLessonModalContent.classList.add('animate-out');
                editLessonModalContent.classList.remove('modal-content');
                setTimeout(() => {
                    editLessonModalContainer.classList.add('hidden');
                }, 300);
            };
            
            // Function to hide the confirmation modal with animation
            const hideConfirmModal = () => {
                confirmModalContent.classList.add('animate-out');
                confirmModalContent.classList.remove('modal-content');
                setTimeout(() => {
                    confirmModalContainer.classList.add('hidden');
                }, 300);
            };

            // Function to hide the backup/import modal
            const hideBackupImportModal = () => {
                backupImportModalContent.classList.add('animate-out');
                backupImportModalContent.classList.remove('modal-content');
                setTimeout(() => {
                    backupImportModalContainer.classList.add('hidden');
                }, 300);
            };

            // Function to hide the theme modal
            const hideThemeModal = () => {
                themeModalContent.classList.add('animate-out');
                themeModalContent.classList.remove('settings-modal-content');
                setTimeout(() => {
                    themeModalContainer.classList.add('hidden');
                }, 300);
            };
            
            // Function to hide the language modal
            const hideLanguageModal = () => {
                languageModalContent.classList.add('animate-out');
                languageModalContent.classList.remove('settings-modal-content');
                setTimeout(() => {
                    languageModalContainer.classList.add('hidden');
                }, 300);
            };
            
            // Close the message modal when clicking on the background
            modalContainer.addEventListener('click', (e) => {
                if (e.target.id === 'modal-container') {
                    hideModal();
                }
            });

            modalCloseBtn.addEventListener('click', hideModal);

            // Save flashcards to Local Storage
            const saveCards = () => {
                localStorage.setItem(CARD_STORAGE_KEY, JSON.stringify(allCards));
            };

            // Save lessons to Local Storage
            const saveLessons = () => {
                localStorage.setItem(LESSON_STORAGE_KEY, JSON.stringify(lessons));
            };

            // Load all data from Local Storage
            const loadData = () => {
                const storedCards = localStorage.getItem(CARD_STORAGE_KEY);
                const storedLessons = localStorage.getItem(LESSON_STORAGE_KEY);
                allCards = storedCards ? JSON.parse(storedCards) : [];
                lessons = storedLessons ? JSON.parse(storedLessons) : [];
                populateLessonSelect();
                initializeDailySuggestions();
            };

            // Initialize or load the daily suggestion pool
            const initializeDailySuggestions = () => {
                const today = new Date().toISOString().split('T')[0];
                const storedDailyState = JSON.parse(localStorage.getItem(DAILY_STATE_KEY));

                if (storedDailyState && storedDailyState.date === today) {
                    // Day hasn't changed, load from saved state
                    const markedIds = storedDailyState.markedCardIds || [];
                    const poolIds = storedDailyState.suggestedCardIds || [];
                    dailyPool = allCards.filter(card => poolIds.includes(card.id));
                    dailySuggestions = dailyPool.filter(card => !markedIds.includes(card.id));
                } else {
                    // New day, generate a new pool
                    const now = new Date();
                    const dueCards = allCards.filter(card => {
                        const reviewDate = card.nextReview ? new Date(card.nextReview) : new Date(0);
                        return reviewDate <= now;
                    });
                    const newCards = allCards.filter(card => !card.reviewHistory || card.reviewHistory.length === 0);
                    
                    const combinedSuggestions = [...shuffle(dueCards), ...shuffle(newCards)];
                    
                    // Create a unique pool of cards
                    dailyPool = [...new Map(combinedSuggestions.map(card => [card.id, card])).values()];
                    dailySuggestions = dailyPool.slice(0, DAILY_INITIAL_COUNT);
                    
                    // Save the new state
                    const newDailyState = {
                        date: today,
                        suggestedCardIds: dailyPool.map(card => card.id),
                        markedCardIds: []
                    };
                    localStorage.setItem(DAILY_STATE_KEY, JSON.stringify(newDailyState));
                }

                renderDailyList();
            };

            // Load more cards from the daily pool
            const loadMoreCards = () => {
                const currentlyDisplayedIds = dailySuggestions.map(card => card.id);
                const remainingCards = dailyPool.filter(card => !currentlyDisplayedIds.includes(card.id));
                
                const newCardsToDisplay = remainingCards.slice(0, LOAD_MORE_COUNT);
                dailySuggestions.push(...newCardsToDisplay);
                renderDailyList();
            };

            loadMoreBtn.addEventListener('click', loadMoreCards);

            // Render the daily suggestions as a list
            const renderDailyList = () => {
                dailyLoading.classList.add('hidden');
                dailyCardList.innerHTML = ''; // Clear previous list
                
                if (dailyPool.length === 0) {
                    dailyEmptyMessage.classList.remove('hidden');
                    loadMoreBtn.classList.add('hidden');
                    return;
                } else {
                    dailyEmptyMessage.classList.add('hidden');
                }

                if (dailySuggestions.length > 0) {
                    dailySuggestions.forEach(card => {
                        const historyCount = (card.reviewHistory?.length || 0);
                        const cardElement = document.createElement('div');
                        cardElement.className = 'daily-list-item';
                        cardElement.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-800 text-lg font-semibold">${card.question}</span>
                                <span class="text-gray-500 text-sm font-medium">Repeated: ${historyCount}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <button class="generic-btn show-definition-btn px-4 py-2 bg-purple-600 text-white rounded-full text-xs font-bold transition-colors hover:bg-purple-700">
                                    Show Definition
                                </button>
                                <div class="review-button-group flex space-x-2">
                                    <button data-card-id="${card.id}" data-status="remembered" class="icon-button green">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>
                                    </button>
                                    <button data-card-id="${card.id}" data-status="forgotten" class="icon-button red">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                    </button>
                                </div>
                            </div>
                            <p class="answer mt-2 text-gray-600 hidden text-sm">${card.answer}</p>
                        `;
                        dailyCardList.appendChild(cardElement);
                    });
                }
                
                // Show/hide the Load More button
                const currentlyDisplayedIds = dailySuggestions.map(card => card.id);
                const remainingInPool = dailyPool.filter(card => !currentlyDisplayedIds.includes(card.id)).length;
                if (remainingInPool > 0) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                    if (dailySuggestions.length === 0 && dailyPool.length > 0) {
                        dailyCardList.innerHTML = `<div class="p-6 text-center text-gray-600">You've completed all available suggestions for today! Check back later or add new cards.</div>`;
                    }
                }
            };

            // Event listener for the daily list using delegation
            dailyCardList.addEventListener('click', (e) => {
                const showDefBtn = e.target.closest('.show-definition-btn');
                const rememberBtn = e.target.closest('[data-status="remembered"]');
                const forgottenBtn = e.target.closest('[data-status="forgotten"]');

                if (showDefBtn) {
                    const answerElement = showDefBtn.closest('.daily-list-item').querySelector('.answer');
                    answerElement.classList.toggle('hidden');
                    showDefBtn.textContent = answerElement.classList.contains('hidden') ? 'Show Definition' : 'Hide Definition';
                }

                if (rememberBtn || forgottenBtn) {
                    const button = rememberBtn || forgottenBtn;
                    const cardId = button.dataset.cardId;
                    const status = button.dataset.status;
                    updateCardStatus(cardId, status);
                }
            });


            // Update a card's review status and move to the next card
            const updateCardStatus = (cardId, status) => {
                const cardIndex = allCards.findIndex(c => c.id === cardId);
                if (cardIndex !== -1) {
                    const now = new Date().toISOString();
                    const cardToUpdate = allCards[cardIndex];
                    
                    if (!cardToUpdate.reviewHistory) {
                        cardToUpdate.reviewHistory = [];
                    }
                    cardToUpdate.reviewHistory.push({ date: now, status: status });
                    cardToUpdate.nextReview = getNextReviewDate(new Date(), status);

                    saveCards();
                    
                    // Remove the card from the local daily suggestions list
                    dailySuggestions = dailySuggestions.filter(card => card.id !== cardId);

                    // Update the persistent state in local storage
                    const storedDailyState = JSON.parse(localStorage.getItem(DAILY_STATE_KEY));
                    if (storedDailyState) {
                        storedDailyState.markedCardIds = [...(storedDailyState.markedCardIds || []), cardId];
                        localStorage.setItem(DAILY_STATE_KEY, JSON.stringify(storedDailyState));
                    }
                    renderDailyList();
                }
            };

            // Show a specific section and activate its navigation button
            const showSection = (sectionId) => {
                const sections = document.querySelectorAll('.section');
                sections.forEach(sec => sec.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');

                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => btn.classList.remove('active'));
                if (sectionId === 'daily-section') navDaily.classList.add('active');
                if (sectionId === 'lessons-section') navLessons.classList.add('active');
                if (sectionId === 'add-section') navAdd.classList.add('active');
                if (sectionId === 'history-section') navHeart.classList.add('active');
                if (sectionId === 'settings-section') navSettings.classList.add('active');
            };

            navDaily.addEventListener('click', () => {
                showSection('daily-section');
                initializeDailySuggestions();
                if (dailyContentWrapper.classList.contains('hidden')) {
                    dailyContentWrapper.classList.remove('hidden');
                    toggleDailyBtn.textContent = 'Hide Cards';
                }
            });
            navLessons.addEventListener('click', () => {
                showSection('lessons-section');
                renderLessons();
            });
            navAdd.addEventListener('click', () => showSection('add-section'));
            navHeart.addEventListener('click', () => {
                showSection('history-section');
                renderHistory();
            });
            navSettings.addEventListener('click', () => {
                showSection('settings-section');
            });

            // Spaced Repetition Logic to determine the next review date
            const getNextReviewDate = (currentDate, status) => {
                const day = 1000 * 60 * 60 * 24;
                switch (status) {
                    case 'remembered':
                        return new Date(currentDate.getTime() + day * 7).toISOString(); // 7 days
                    case 'forgotten':
                        return new Date(currentDate.getTime() + day * 0.1).toISOString(); // 2.4 hours
                    default:
                        return new Date().toISOString();
                }
            };

            // Render the list of lessons
            const renderLessons = () => {
                lessonsListView.classList.remove('hidden');
                lessonCardsView.classList.add('hidden');
                lessonsList.innerHTML = '';
                if (lessons.length === 0) {
                    lessonsList.innerHTML = '<p class="text-gray-500 text-center col-span-full">No lessons added yet.</p>';
                    return;
                }
                lessons.forEach(lesson => {
                    const lessonCard = document.createElement('div');
                    const cardCount = allCards.filter(card => card.lessonId === lesson.id).length;
                    lessonCard.className = 'lesson-card bg-white p-4 rounded-xl shadow-lg cursor-pointer hover:bg-gray-100 transition-colors relative';
                    lessonCard.dataset.lessonId = lesson.id; // Store lesson ID
                    lessonCard.innerHTML = `
                        <h3 class="font-bold text-lg">${lesson.name}</h3>
                        <p class="text-sm text-gray-500">${cardCount} cards</p>
                        <div class="lesson-actions">
                            <button class="action-button edit-lesson-btn" data-id="${lesson.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M21.174 6.873a2.121 2.121 0 0 0-3-3L3.6 17.65a2 2 0 0 0-.583 1.01L2 22l3.34-1.01a2 2 0 0 0 1.01-.583L21.174 6.873Z"/></svg>
                            </button>
                            <button class="action-button delete-lesson-btn" data-id="${lesson.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                    `;
                    lessonsList.appendChild(lessonCard);
                });
            };

            let pressTimer;
            lessonsList.addEventListener('mousedown', (e) => {
                const lessonCard = e.target.closest('.lesson-card');
                if (!lessonCard) return;

                // Clear any existing active classes
                lessonsList.querySelectorAll('.lesson-card.active').forEach(card => card.classList.remove('active'));

                pressTimer = setTimeout(() => {
                    lessonCard.classList.add('active');
                }, 500); // 500ms for long press
            });

            lessonsList.addEventListener('mouseup', (e) => {
                clearTimeout(pressTimer);
            });
            
            lessonsList.addEventListener('mouseleave', (e) => {
                clearTimeout(pressTimer);
            });

            // Handle touch events for mobile long-press
            lessonsList.addEventListener('touchstart', (e) => {
                const lessonCard = e.target.closest('.lesson-card');
                if (!lessonCard) return;

                lessonsList.querySelectorAll('.lesson-card.active').forEach(card => card.classList.remove('active'));

                pressTimer = setTimeout(() => {
                    lessonCard.classList.add('active');
                }, 500); // 500ms for long press
            }, { passive: true });

            lessonsList.addEventListener('touchend', (e) => {
                clearTimeout(pressTimer);
            });

            lessonsList.addEventListener('touchcancel', (e) => {
                clearTimeout(pressTimer);
            });

            // Prevent context menu on long-press
            lessonsList.addEventListener('contextmenu', (e) => {
                const lessonCard = e.target.closest('.lesson-card');
                if (lessonCard) {
                    e.preventDefault();
                }
            });

            lessonsList.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-lesson-btn');
                const deleteButton = e.target.closest('.delete-lesson-btn');
                const lessonCard = e.target.closest('.lesson-card');

                if (editButton) {
                    e.stopPropagation();
                    const lessonId = editButton.dataset.id;
                    currentLessonId = lessonId;
                    const lessonToEdit = lessons.find(l => l.id === currentLessonId);
                    editLessonNameInput.value = lessonToEdit.name;
                    showEditModal();
                } else if (deleteButton) {
                    e.stopPropagation();
                    const lessonId = deleteButton.dataset.id;
                    currentLessonId = lessonId;
                    showConfirmModal();
                } else if (lessonCard) {
                    // If the card is active, a user is clicking to dismiss the buttons, not to navigate
                    if (lessonCard.classList.contains('active')) {
                        lessonCard.classList.remove('active');
                        e.stopPropagation(); // Stop the click from propagating and causing navigation
                    } else {
                        // It's a normal click, so navigate
                        const lessonId = lessonCard.dataset.lessonId;
                        showCardsForLesson(lessonId);
                    }
                }
            });

            // Handle lesson edit form submission
            editLessonForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = editLessonNameInput.value.trim();
                if (newName === '') {
                    showModal('Lesson name cannot be empty.');
                    return;
                }

                // Update the lesson name
                const lessonIndex = lessons.findIndex(l => l.id === currentLessonId);
                if (lessonIndex !== -1) {
                    lessons[lessonIndex].name = newName;
                    
                    // Update the lesson name on all associated cards
                    allCards.forEach(card => {
                        if (card.lessonId === currentLessonId) {
                            card.lessonName = newName;
                        }
                    });

                    saveLessons();
                    saveCards();
                    renderLessons();
                    hideEditModal();
                    showModal('Lesson updated successfully!');
                }
            });

            // Handle lesson deletion confirmation
            confirmCancelBtn.addEventListener('click', () => {
                hideConfirmModal();
            });

            confirmDeleteBtn.addEventListener('click', () => {
                // Delete the lesson and its cards
                lessons = lessons.filter(l => l.id !== currentLessonId);
                allCards = allCards.filter(c => c.lessonId !== currentLessonId);
                
                saveLessons();
                saveCards();
                renderLessons();
                hideConfirmModal();
                showModal('Lesson and all its cards deleted successfully!');
            });
            
            // Close the edit modal
            editCancelBtn.addEventListener('click', () => {
                hideEditModal();
            });
            
            // Prevent closing of editing modals when tapping outside
            editLessonModalContainer.addEventListener('click', (e) => {
                if (e.target.id === 'edit-lesson-modal-container') {
                    e.stopPropagation(); // Do nothing
                }
            });
            
            confirmModalContainer.addEventListener('click', (e) => {
                if (e.target.id === 'confirm-modal-container') {
                    e.stopPropagation(); // Do nothing
                }
            });

            // Show all cards for a specific lesson with an animation
            const showCardsForLesson = (lessonId) => {
                lessonsListView.classList.add('hidden');
                lessonCardsView.classList.remove('hidden');
                
                const lessonCards = allCards.filter(card => card.lessonId === lessonId);
                const lessonName = lessons.find(l => l.id === lessonId)?.name;

                lessonTitle.textContent = lessonName;
                lessonCardContainer.innerHTML = '';
                
                if (lessonCards.length === 0) {
                    lessonCardContainer.innerHTML = `<p class="text-gray-500 text-center">No cards in this lesson.</p>`;
                    return;
                }
                
                lessonCards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'bg-gray-50 p-4 rounded-lg shadow-inner opacity-0 transform translate-y-5'; // Start hidden
                    cardElement.innerHTML = `
                        <p class="font-bold text-lg">${card.question}</p>
                        <p class="text-gray-600 mt-2">${card.answer}</p>
                    `;
                    lessonCardContainer.appendChild(cardElement);

                    // Apply the animation with a delay
                    setTimeout(() => {
                        cardElement.classList.remove('opacity-0', 'translate-y-5');
                        cardElement.classList.add('fade-in-slide-up');
                    }, index * 50); // Stagger the animation by 50ms per card
                });
            };

            // Event listener for the "Back to All Lessons" button
            backToLessonsBtn.addEventListener('click', () => {
                renderLessons();
            });

            // Populate the lesson select dropdown
            const populateLessonSelect = () => {
                lessonSelect.innerHTML = '<option value="">Select a lesson</option>';
                lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.id;
                    option.textContent = lesson.name;
                    lessonSelect.appendChild(option);
                });
            };

            // Add New Lesson Form Submission Handler
            addLessonForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const lessonName = newLessonNameInput.value.trim();
                if (lessonName === '') {
                    showModal('Please enter a name for the new lesson.');
                    return;
                }
                const newLessonId = Date.now().toString();
                lessons.push({ id: newLessonId, name: lessonName });
                saveLessons();
                populateLessonSelect();
                showModal('New lesson added successfully!');
                newLessonNameInput.value = '';
            });

            // Add Card Form Submission Handler
            addCardForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedLessonId = lessonSelect.value;
                if (selectedLessonId === '') {
                    showModal('Please select a lesson.');
                    return;
                }
                const lessonName = lessons.find(l => l.id === selectedLessonId)?.name;
                const newCardId = Date.now().toString() + Math.random().toString(16).substring(2, 8);
                const newCard = {
                    id: newCardId,
                    question: cardQuestionInput.value.trim(),
                    answer: cardAnswerInput.value.trim(),
                    lessonId: selectedLessonId,
                    lessonName: lessonName,
                    nextReview: new Date().toISOString(),
                    reviewHistory: []
                };
                allCards.push(newCard);
                saveCards();
                showModal('Flashcard added successfully!');
                
                // Keep the selected lesson but clear the other fields for the next card
                cardQuestionInput.value = '';
                cardAnswerInput.value = '';

                if (document.getElementById('lessons-section').classList.contains('active')) {
                    renderLessons();
                }
                initializeDailySuggestions();
            });

            // Render the review history
            const renderHistory = () => {
                historyList.innerHTML = '';
                
                const dailyHistory = new Map();
                allCards.forEach(card => {
                    if (card.reviewHistory && card.reviewHistory.length > 0) {
                        card.reviewHistory.forEach(review => {
                            const dateKey = new Date(review.date).toDateString();
                            if (!dailyHistory.has(dateKey)) {
                                dailyHistory.set(dateKey, { total: 0, remembered: 0, forgotten: 0, cards: [] });
                            }
                            const dayData = dailyHistory.get(dateKey);
                            dayData.total++;
                            if (review.status === 'remembered') {
                                dayData.remembered++;
                            } else {
                                dayData.forgotten++;
                            }
                            dayData.cards.push({ question: card.question, status: review.status, id: card.id });
                        });
                    }
                });

                if (dailyHistory.size === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-center">No review history found.</p>';
                    return;
                }
                
                const sortedDates = Array.from(dailyHistory.keys()).sort((a, b) => new Date(b) - new Date(a));

                sortedDates.forEach(dateKey => {
                    const dayData = dailyHistory.get(dateKey);
                    
                    // Calculate repetitions for each card for the current day
                    const cardRepetitions = dayData.cards.reduce((acc, card) => {
                        acc[card.id] = (acc[card.id] || 0) + 1;
                        return acc;
                    }, {});

                    // Create a unique list of cards reviewed that day
                    const reviewedCards = [...new Map(dayData.cards.map(item => [item['id'], item])).values()];

                    const historyItem = document.createElement('div');
                    historyItem.className = 'bg-white p-6 rounded-2xl shadow-lg';
                    historyItem.innerHTML = `
                        <h3 class="font-bold text-xl text-gray-700 mb-2">${dateKey}</h3>
                        <p class="text-gray-600 text-sm mb-4">You reviewed ${dayData.total} card(s) on this day.</p>
                        <ul class="flex justify-between text-sm font-semibold text-gray-700">
                            <li class="flex items-center text-green-600"><span class="w-2 h-2 mr-1 rounded-full bg-green-600"></span>Remembered: ${dayData.remembered}</li>
                            <li class="flex items-center text-red-600"><span class="w-2 h-2 mr-1 rounded-full bg-red-600"></span>Forgotten: ${dayData.forgotten}</li>
                        </ul>
                        <details class="mt-4">
                            <summary class="font-semibold text-blue-500 cursor-pointer">View Details</summary>
                            <ul class="mt-2 text-sm space-y-2">
                                ${reviewedCards.map(card => `
                                    <li class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                        <p class="text-gray-800">${card.question}</p>
                                        <div class="flex items-center space-x-2 text-gray-500">
                                            <span class="font-medium text-xs">Repeated: ${cardRepetitions[card.id]}x</span>
                                            <span class="text-xs font-medium px-2 py-1 rounded-full 
                                                ${card.status === 'remembered' ? 'bg-green-100 text-green-700' : ''}
                                                ${card.status === 'forgotten' ? 'bg-red-100 text-red-700' : ''}">
                                                ${card.status.charAt(0).toUpperCase() + card.status.slice(1)}
                                            </span>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </details>
                    `;
                    historyList.appendChild(historyItem);
                });
            };

            // Event listeners for the new settings buttons
            settingsBackupImportBtn.addEventListener('click', showBackupImportModal);
            settingsThemeBtn.addEventListener('click', showThemeModal);
            settingsLanguageBtn.addEventListener('click', showLanguageModal);

            // Event listeners for the new modal back buttons
            backFromBackupBtn.addEventListener('click', hideBackupImportModal);
            backFromThemeBtn.addEventListener('click', hideThemeModal);
            backFromLanguageBtn.addEventListener('click', hideLanguageModal);

            // Close modals when clicking on the overlay
            themeModalContainer.addEventListener('click', (e) => {
                if (e.target.id === 'theme-modal-container') {
                    hideThemeModal();
                }
            });

            languageModalContainer.addEventListener('click', (e) => {
                if (e.target.id === 'language-modal-container') {
                    hideLanguageModal();
                }
            });

            // Backup Data functionality
            backupBtn.addEventListener('click', () => {
                const dataToBackup = {
                    lessons: lessons,
                    cards: allCards
                };
                const jsonData = JSON.stringify(dataToBackup, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'flashcards_backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showModal('Data backed up successfully!');
            });

            // Import Data functionality
            importBtn.addEventListener('click', () => {
                const file = importFileInput.files[0];
                if (!file) {
                    showModal('Please select a file to import.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.lessons && importedData.cards) {
                            lessons = importedData.lessons;
                            allCards = importedData.cards;
                            saveLessons();
                            saveCards();
                            loadData();
                            showModal('Data imported successfully!');
                            hideBackupImportModal(); // Close modal after successful import
                        } else {
                            showModal('Invalid file format. Please import a valid flashcards backup file.');
                        }
                    } catch (error) {
                        showModal('Error reading file. Please ensure it is a valid JSON format.');
                        console.error('File import error:', error);
                    }
                };
                reader.readAsText(file);
            });

            toggleDailyBtn.addEventListener('click', () => {
                if (dailyContentWrapper.classList.contains('hidden')) {
                    dailyContentWrapper.classList.remove('hidden');
                    toggleDailyBtn.textContent = 'Hide Cards';
                } else {
                    dailyContentWrapper.classList.add('hidden');
                    toggleDailyBtn.textContent = 'Show Cards';
                }
            });

            // Initial load of data when the page loads
            loadData();
        });
    </script>
</body>
</html>
