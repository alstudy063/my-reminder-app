<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Units and Sub Units</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom font for better Sinhala rendering and modern look */
    body {
      font-family: "Inter", "Segoe UI", "Iskoola Pota", sans-serif;
    }
    /* No custom styles for plus/minus icon as it's removed */

    /* Subtopics within the unit are now always hidden as they are shown in a modal */
    .subtopics {
      display: none; /* Hide the original subtopics */
    }

    /* Modal overlay animation styles (fade in/out) */
    #subtopicModal {
      transition: opacity 0.3s ease-out; /* For the background overlay fade */
      opacity: 0; /* Start hidden */
      /* backdrop-filter: blur(5px); Removed blur effect */
    }
    #subtopicModal.is-active {
      opacity: 1; /* Fade in */
    }

    /* Keyframe animations for the modal content */
    @keyframes modal-pop-in {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      75% {
        opacity: 1;
        transform: scale(1.05); /* Slight overshoot for a "pop" effect */
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes modal-pop-out {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      100% {
        opacity: 0;
        transform: scale(0.8);
      }
    }

    /* Modal content animation styles */
    #subtopicModal > div {
      /* Initial state for animation */
      opacity: 0;
      transform: scale(0.8); /* Start smaller */
      transition: none; /* Remove default transition to use keyframes */
    }

    #subtopicModal.is-active > div {
      /* Apply pop-in animation when active */
      animation: modal-pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; /* Custom cubic-bezier for bounce */
    }

    #subtopicModal.is-closing > div {
      /* Apply pop-out animation when closing */
      animation: modal-pop-out 0.3s ease-in forwards;
    }

    /* Styles for the custom tick circle */
    .tick-circle {
      width: 1.5rem; /* 24px */
      height: 1.5rem; /* 24px */
      border-radius: 50%;
      border: 2px solid #cbd5e0; /* Gray border */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
      flex-shrink: 0; /* Prevent it from shrinking */
    }

    .tick-circle.checked {
      background-color: #3b82f6; /* Blue background */
      border-color: #3b82f6; /* Blue border */
      color: #ffffff; /* White tick */
    }

    /* Reminder message styles - POSITIONED RELATIVE TO MODAL CONTENT */
    #reminderMessage {
      position: absolute; /* Relative to its parent, which is the modal content div */
      top: calc(100% + 15px); /* Position below the modal content with some spacing */
      left: 50%;
      transform: translateX(-50%);
      background-color: #ef4444; /* Red-500 */
      color: white;
      padding: 0.75rem 1.5rem; /* Responsive padding using rem */
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001; /* Higher than modal content to ensure visibility */
      opacity: 0;
      /* Changed transition to only apply to opacity for immediate visibility */
      transition: opacity 0.3s ease-in-out;
      visibility: hidden; /* Initially hidden */
      pointer-events: none; /* Not clickable when hidden */
      font-size: 0.875rem; /* Base font size for responsiveness (text-sm in Tailwind) */
      text-align: center; /* Center text */
      max-width: 90%; /* Allow it to take up to 90% of parent width */
      box-sizing: border-box; /* Include padding in width calculation */
    }

    /* Media query for larger screens to increase font size and max-width */
    @media (min-width: 768px) { /* md breakpoint in Tailwind */
      #reminderMessage {
        font-size: 1rem; /* text-base in Tailwind */
        max-width: 300px; /* Max width for larger screens */
      }
    }

    #reminderMessage.show {
      opacity: 1;
      visibility: visible; /* Make immediately visible */
      pointer-events: auto; /* Clickable when shown */
    }

    /* Spinner styles */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 max-w-4xl mx-auto text-gray-800 rounded-lg shadow-lg">

<!-- Loading Spinner -->
<div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
  <div class="spinner"></div>
</div>

<div id="auth-section" class="flex flex-col items-center justify-center min-h-screen p-4 md:p-8 hidden">
    <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-md">
        <h2 class="text-center text-2xl md:text-3xl font-extrabold mb-6 text-blue-800">Sign In / Sign Up</h2>
        <div id="auth-error" class="text-red-500 text-center mb-4 hidden text-sm md:text-base"></div>

        <div class="mb-4">
            <input type="email" id="email-input" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
        </div>
        <div class="mb-6">
            <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm md:text-base">
        </div>

        <button id="signin-email-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 mb-3 text-base md:text-lg">Sign In with Email</button>
        <button id="signup-email-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors duration-200 mb-6 text-base md:text-lg">Sign Up with Email</button>

        <div class="relative flex items-center justify-center mb-6">
            <div class="absolute inset-0 flex items-center">
                <span class="w-full border-t border-gray-300"></span>
            </div>
            <div class="relative bg-white px-4 text-sm text-gray-500">Or</div>
        </div>

        <button id="signin-google-btn" class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition-colors duration-200 flex items-center justify-center space-x-2 text-base md:text-lg">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.0003 4.75C14.0503 4.75 15.8303 5.44 17.2403 6.72L19.9903 3.97C18.1903 2.31 15.8003 1.25 12.0003 1.25C7.79031 1.25 4.10031 3.75 2.37031 7.52L5.61031 9.97C6.41031 7.97 9.03031 4.75 12.0003 4.75Z" fill="#EA4335"></path>
                <path d="M23.4903 12.27C23.4903 11.49 23.4303 10.74 23.3203 10H12.2503V14.52H18.7203C18.4303 15.93 17.5803 17.15 16.4203 17.99L19.6603 20.44C21.5403 18.73 22.9503 16.31 23.4903 12.27Z" fill="#4285F4"></path>
                <path d="M5.61031 14.97C5.35031 14.21 5.21031 13.44 5.21031 12.67C5.21031 11.9 5.35031 11.13 5.61031 10.37L2.37031 7.92C1.41031 9.92 0.870312 12.2 0.870312 14.67C0.870312 17.14 1.41031 19.42 2.37031 21.42L5.61031 18.97C5.35031 18.21 5.21031 17.44 5.21031 16.67C5.21031 15.9 5.35031 15.13 5.61031 14.37L5.61031 14.97Z" fill="#FBBC04"></path>
                <path d="M12.0003 23.75C15.0203 23.75 17.6903 22.72 19.6603 20.44L16.4203 17.99C15.5303 18.61 14.3503 19.06 12.0003 19.06C9.03031 19.06 6.41031 15.84 5.61031 13.84L2.37031 16.29C4.10031 20.06 7.79031 22.56 12.0003 22.56L12.0003 23.75Z" fill="#34A853"></path>
            </svg>
            <span>Sign In with Google</span>
        </button>
    </div>
</div>

<div id="main-content" class="hidden">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 px-4 md:px-0">
        <h2 class="text-2xl md:text-4xl font-extrabold text-blue-800 text-center md:text-left mb-4 md:mb-0">📘 Subject Units and Sub Units</h2>
        <div class="flex items-center space-x-2 md:space-x-4">
            <span id="user-id-display" class="text-gray-600 text-xs md:text-sm"></span>
            <button id="logout-btn" class="bg-gray-300 text-gray-800 p-2 rounded-lg font-semibold hover:bg-gray-400 transition-colors duration-200 text-sm md:text-base">Logout</button>
        </div>
    </div>

    <!-- Subject Selection Buttons -->
    <div class="mb-6 px-4 md:px-0 flex flex-wrap justify-center gap-3">
        <button id="biology-btn" class="subject-button px-5 py-2 rounded-full font-semibold text-lg transition-all duration-200 ease-in-out bg-blue-600 text-white shadow-md hover:bg-blue-700">Biology</button>
        <button id="physics-btn" class="subject-button px-5 py-2 rounded-full font-semibold text-lg transition-all duration-200 ease-in-out bg-gray-200 text-gray-700 shadow-md hover:bg-gray-300">Physics</button>
        <button id="chemistry-btn" class="subject-button px-5 py-2 rounded-full font-semibold text-lg transition-all duration-200 ease-in-out bg-gray-200 text-gray-700 shadow-md hover:bg-gray-300">Chemistry</button>
    </div>

    <!-- Units Container -->
    <div id="units-container">
        <!-- Biology Units (Initially displayed) -->
        <div id="biology-units" class="subject-units">
            <!-- Unit 01: Introduction to Biology -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">01. ජීව විද්‍යාව හඳුන්වා දීම</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(2)</span>
              </div>
              <ul class="subtopics">
                <li>මිනිසා මුහුණ දෙන අභියෝග හා ජීව විද්‍යාවේ ස්වභාවය</li>
                <li>ජෛව ලෝකයේ ස්වභාවය හා සංවිධාන රටා</li>
              </ul>
            </div>

            <!-- Unit 02: Chemical and Cellular Basis of Life -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">02. ජීවයේ රසායනික හා සෛලීය පදනම</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(9)</span>
              </div>
              <ul class="subtopics">
                <li>මූලද්‍රව්‍යමය සංයුතිය</li>
                <li>ජලයේ ගුණ</li>
                <li>කාබනික සංයෝග</li>
                <li>සෛල ව්‍යූහය</li>
                <li>සෛල චක්‍රය</li>
                <li>ශක්ති සම්බන්ධතා</li>
                <li>එන්සයිම</li>
                <li>ප්‍රභාසංශ්ලේෂණය</li>
                <li>සෛලීය ශ්වසනය</li>
              </ul>
            </div>

            <!-- Unit 03: Evolution and Diversity of Organisms -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">03. පරිණාමය හා ජීවීන්ගේ විවිධත්වය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(8)</span>
              </div>
              <ul class="subtopics">
                <li>පරිණාම ක්‍රියාවලිය</li>
                <li>තක්සෝන විද්‍යාව</li>
                <li>බැක්ටීරියා</li>
                <li>ප්‍රෝටිස්ටා</li>
                <li>ශාක රාජධානිය</li>
                <li>දිලීර රාජධානිය</li>
                <li>ඇනිමාලියා</li>
                <li>කෝඩේටා වංශය</li>
              </ul>
            </div>

            <!-- Unit 04: Plant Form and Function -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">04. ශාක ආකාරය හා ක්‍රියාකාරිත්වය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(13)</span>
              </div>
              <ul class="subtopics">
                <li>ශාක වර්ධනය හා විකසනය</li>
                <li>පටක පද්ධති</li>
                <li>ආලෝකය අධිග්‍රහණය</li>
                <li>වායු හුවමාරුව</li>
                <li>ජල හා ඛනිජ අවශ්‍යතා</li>
                <li>ද්‍රව්‍ය පරිවහනය</li>
                <li>ජලය ඉවත් කිරීම</li>
                <li>පෝෂණ ක්‍රියාවලි</li>
                <li>පෝෂණ අවශ්‍යතා</li>
                <li>ජීවන චක්‍රය</li>
                <li>ප්‍රජනනය</li>
                <li>උත්තේජ වලට ප්‍රතිචාර</li>
                <li>ආතති වලට ප්‍රතිචාර</li>
              </ul>
            </div>

            <!-- Unit 05: Animal Form and Function -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">05. සත්ත්ව ආකාරය හා ක්‍රියාකාරිත්වය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(14)</span>
              </div>
              <ul class="subtopics">
                <li>සන්ධාරණය</li>
                <li>ස්නායු පද්ධතිය</li>
                <li>සංවේදක පද්ධතිය</li>
                <li>සම</li>
                <li>අන්තරාසර්ග පද්ධතිය</li>
                <li>අභ්‍යන්තර පරිසරය</li>
                <li>පුරුෂ ප්‍රජනක පද්ධතිය</li>
                <li>ස්ත්‍රී ප්‍රජනක පද්ධතිය</li>
                <li>ප්‍රජනක චක්‍රය</li>
                <li>උපත් පාලන ක්‍රම</li>
                <li>මානව සැකිල්ල</li>
                <li>ගාත්‍රා සැකිල්ල</li>
                <li>කංකාල පේශි</li>
                <li>සංකෝචන යන්ත්‍රණය</li>
              </ul>
            </div>

            <!-- Unit 06: Genetics -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">06. ප්‍රවේණිය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(9)</span>
              </div>
              <ul class="subtopics">
                <li>ප්‍රවේණි වාග්මාලව</li>
                <li>මුහුම</li>
                <li>මෙන්ඩල්ගේ පරීක්ෂණ</li>
                <li>සම්භාවිතා නියම</li>
                <li>මානව ලක්ෂණ</li>
                <li>නොවන ආවේණිය</li>
                <li>බහු ඇලීලතාව</li>
                <li>ගහන ප්‍රවේණිය</li>
                <li>අභිජනනය</li>
              </ul>
            </div>

            <!-- Unit 07: Molecular Biology and Recombinant DNA Technology -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">07. අණුක ජීව විද්‍යාව හා ප්‍රතිසංයෝජිත DNA තාක්ෂණය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(8)</span>
              </div>
              <ul class="subtopics">
                <li>වර්ණදේහවල වව්‍යුහ නිර්මාණය</li>
                <li>DNA ප්‍රතිචලිතය</li>
                <li>ජාන සහ ඒවා ක්‍රියාකරන ආකාරය</li>
                <li>විකෘති</li>
                <li>ජාන තාක්ෂණය</li>
                <li>DNA විශ්ලේෂණය</li>
                <li>කාෂිකර්මාන්තයේ දී GMO වල භාවිතයන්</li>
                <li>ජෛව සුරක්ෂිතතාව පිළිබඳ කාටජිනා ගිවිසුම ශ්‍රී ලංකාවේ ජාතික ජෛව සුරක්ෂිතතා රාමුව</li>
              </ul>
            </div>

            <!-- Unit 08: Environmental Biology -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">08. පාරසරික ජීව විද්‍යාව</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(7)</span>
              </div>
              <ul class="subtopics">
                <li>පාරිසරික ජීව විද්‍යාව යනු කුමක් ද?</li>
                <li>පරිසරයේ සංවිධාන පෙරම්</li>
                <li>බියෝමයක් යනු කුමක් ද ?</li>
                <li>ශ්‍රී ලංකාවේ පරිසර පද්ධති</li>
                <li>ජෛව විවිධත්වය</li>
                <li>භූගෝලීය උණුසුම සහ දේශගුණ විපර්යාසය</li>
                <li>පරිසර සංරක්ෂණයට අදාළ සම්මුති</li>
              </ul>
            </div>

            <!-- Unit 09: Microbiology -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">09. ක්ෂුද්‍ර ජීව විද්‍යාව</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(7)</span>
              </div>
              <ul class="subtopics">
                <li>ක්ෂුද්‍ර ජීවීන්ගේ ස්වභාවය</li>
                <li>ක්ෂුද්‍ර ජීවීන්ගේ ආකාර</li>
                <li>තාක්ෂණික ශිල්ප</li>
                <li>කර්මාන්ත සහ පරිසරය</li>
                <li>පාංශු ක්ෂුද්‍රජීවීන්</li>
                <li>අපජල කළමනාකරණය</li>
                <li>ආහාර හා ක්ෂුද්‍රජීවීන්</li>
              </ul>
            </div>

            <!-- Unit 10: Applied Biology -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">10. ව්‍යවහාරික ජීව විද්‍යාව</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(8)</span>
              </div>
              <ul class="subtopics">
                <li>ජලජීවී වගාව</li>
                <li>මත්ස්‍ය වගාව</li>
                <li>මිරිදිය රෝග</li>
                <li>තවාන් කළමනාකරණය</li>
                <li>ආහාර පරිරක්ෂණය</li>
                <li>අස්වනු හානිය</li>
                <li>ඩෙංගු සහ බරවා</li>
                <li>නැනෝ තාක්ෂණය</li>
              </ul>
            </div>
        </div>

        <!-- Physics Units -->
        <div id="physics-units" class="subject-units hidden">
            <h3 class="text-xl md:text-2xl font-bold text-blue-700 mb-4">භෞතික විද්‍යා ඒකක</h3>
            <!-- Unit 01: Measurement -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">01. මිනුම</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(4)</span>
              </div>
              <ul class="subtopics">
                <li>භෞතික රාශි</li>
                <li>මාන</li>
                <li>මිනුම් උපකරණ</li>
                <li>අදිග රාශි සහ දෛශික රාශි</li>
              </ul>
            </div>

            <!-- Unit 02: Mechanics -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">02. යාන්ත්‍ර විද්‍යාව</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(8)</span>
              </div>
              <ul class="subtopics">
                <li>ප්‍රගති විද්‍යාව</li>
                <li>ඒකතල බල පද්ධතියක සම්ප්‍රයුක්තය</li>
                <li>බලය හා චලිතය</li>
                <li>බල සමතුලිතාව</li>
                <li>කාර්යය, ශක්තිය සහ ජවය</li>
                <li>භ්‍රමණ චලිතය හා වෘත්තාකාර චලිතය</li>
                <li>ද්‍රවස්ථිති විද්‍යාව</li>
                <li>තරල ගති විද්‍යාව</li>
              </ul>
            </div>

            <!-- Unit 03: Oscillations and Waves -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">03. දෝලන හා තරංග</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(10)</span>
              </div>
              <ul class="subtopics">
                <li>තරංග චලිතය</li>
                <li>තරංගවල ගුණ</li>
                <li>ඇදි තන්තුවල ඇති වන ස්ථාවර තරංග</li>
                <li>වායු තුළින් ධ්වනි සම්ප්‍රේෂණය</li>
                <li>ඩොප්ලර් ආචරණය</li>
                <li>ධ්වනියේ ස්වභාවය</li>
                <li>විද්‍යුත් චුම්බක තරංග</li>
                <li>ජ්‍යාමිතික ප්‍රකාශ විද්‍යාව</li>
                <li>මිනිස් ඇස හා අක්‍ෂි දෝෂ</li>
                <li>ප්‍රකාශ උපකරණ</li>
              </ul>
            </div>

            <!-- Unit 04: Thermodynamics -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">04. තාපගති විද්‍යාව</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(8)</span>
              </div>
              <ul class="subtopics">
                <li>උෂ්ණත්වය</li>
                <li>ඝන සහ ද්‍රව ප්‍රසාරණය</li>
                <li>වායු නියම</li>
                <li>වායු පිළිබඳ චාලක අණුක වාදය</li>
                <li>තාප හුවමාරුව අවස්ථා විපර්යාස</li>
                <li>වාෂ්ප සහ ආර්ද්‍රතාව</li>
                <li>තාපගති විද්‍යාව</li>
                <li>තාප සංක්‍රාමණය</li>
              </ul>
            </div>

            <!-- Unit 05: Gravitational Field -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">05. ගුරුත්වාකර්ෂණ ක්ෂේත්‍රය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(2)</span>
              </div>
              <ul class="subtopics">
                <li>ගුරුත්වාකර්ෂණ බල ක්ෂේත්‍රය</li>
                <li>පෘථිවි ගුරුත්වාකර්ෂණ ක්ෂේත්‍රය</li>
              </ul>
            </div>

            <!-- Unit 06: Electrostatic Field -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">06. ස්ථිති විද්‍යුත් ක්ෂේත්‍රය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(7)</span>
              </div>
              <ul class="subtopics">
                <li>පළමු වන පරිච්ඡේදය</li>
                <li>දෙවන පරිච්ඡේදය</li>
                <li>තුන්වන පරිච්ඡේදය</li>
                <li>හතර වන පරිච්ඡේදය</li>
                <li>ස්ථිති විද්‍යුත් බලය</li>
                <li>ස්ථිති විද්‍යුත් ක්ෂේත්‍රයක ස්‍රාව ආකෘතිය</li>
                <li>ස්ථිති විද්‍යුත් විභවය</li>
              </ul>
            </div>

            <!-- Unit 07: Magnetic Field -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">07. චුම්බක ක්ෂේත්‍රය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(4)</span>
              </div>
              <ul class="subtopics">
                <li>විද්‍යුත් ධාරිතාව (ධාරණාව)</li>
                <li>පළමු වන පරිච්ඡේදය - චුම්බක බලය</li>
                <li>දෙවන පරිච්ඡේදය - චුම්බක බල ක්ෂේත්‍රය</li>
                <li>තුන්වන පරිච්ඡේදය - ධාරා පුඩුවක් මත ක්‍රියාත්මක වන ව්‍යාවර්තය</li>
              </ul>
            </div>

            <!-- Unit 08: Current Electricity -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">08. ධාරා විද්‍යුතය</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(6)</span>
              </div>
              <ul class="subtopics">
                <li>ධාරා විද්‍යුතයේ මූලික සංකල්පය</li>
                <li>විද්‍යුත් ශක්තිය හා ජවය</li>
                <li>දෙවන පරිච්ඡේදය</li>
                <li>තුන්වන පරිච්ඡේදය - විද්‍යුත්ගාමක බලය</li>
                <li>හතරවන පරිච්ඡේදය - විද්‍යුත් පරිපථ : කචොෆ් නියම</li>
                <li>පස්වන පරිච්ඡේදය - විද්‍යුත් ධාරාව සහ විභව අන්තරය මැනීම</li>
                <li>හයවන පරිච්ඡේදය - විද්‍යුත් චුම්බක ප්‍රේරණය</li>
              </ul>
            </div>

            <!-- Unit 09: Electronics -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">09. ඉලෙක්ට්‍රොනික්</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(4)</span>
              </div>
              <ul class="subtopics">
                <li>අර්ධ සන්නායක හා ඩයෝඩවල භාවිත</li>
                <li>ට්‍රාන්සිස්ටර</li>
                <li>සංගෘහිත පරිපථ සහ කාරකාත්මක වර්ධක</li>
                <li>සංඛ්‍යාංක ඉලෙක්ට්‍රොනික විද්‍යාව</li>
              </ul>
            </div>

            <!-- Unit 10: Mechanical Properties of Matter -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">10. පදාර්ථයේ යාන්ත්‍රික ගුණ</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(2)</span>
              </div>
              <ul class="subtopics">
                <li>ප්‍රත්‍යාස්ථතාව</li>
                <li>දුස්ස්‍රාවිතාව</li>
              </ul>
            </div>

            <!-- Unit 11: Matter and Radiation -->
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4 cursor-pointer hover:bg-blue-50 transition-all duration-300 ease-in-out" onclick="openSubtopicsModal(this)">
              <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                <span class="flex-grow min-w-0">11. පදාර්ථය හා විකරණ</span>
                <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(7)</span>
              </div>
              <ul class="subtopics">
                <li>විකිරණයේ ක්වොන්ටම් ස්වාභාව</li>
                <li>ප්‍රකාශ විද්‍යුත් ආචරණය</li>
                <li>පදාර්ථයේ තරංග ස්වභාවය</li>
                <li>X කිරණ</li>
                <li>විකිරශීලීතාවය</li>
                <li>න්‍යෂ්ටික ශක්තිය හා එහි භාවිත</li>
                <li>පදාර්ථයේ මුලික සංඝටක හා ඒවායේ අන්තර්ක්‍රියා</li>
              </ul>
            </div>
        </div>

        <!-- Chemistry Units (Initially hidden) -->
        <div id="chemistry-units" class="subject-units hidden">
            <h3 class="text-xl md:text-2xl font-bold text-blue-700 mb-4">Chemistry Units (Placeholder)</h3>
            <div class="unit bg-white rounded-xl shadow-md mb-4 p-4">
                <div class="unit-title flex justify-between items-center text-xl md:text-2xl font-semibold text-blue-700 border-b border-dotted border-gray-300 pb-2 mb-2">
                    <span class="flex-grow min-w-0">Chemistry Unit 01</span>
                    <span class="text-green-600 text-base md:text-lg w-12 text-right flex-shrink-0">(0)</span>
                </div>
                <ul class="subtopics">
                    <li>Chemistry Subtopic 1.1</li>
                    <li>Chemistry Subtopic 1.2</li>
                </ul>
            </div>
            <!-- Add more Chemistry units here -->
        </div>
    </div>


    <!-- Summary Section -->
    <div class="summary mt-10 bg-green-50 border-l-8 border-green-500 p-4 md:p-6 text-base md:text-xl rounded-lg text-green-800">
      🔢 <strong class="font-bold">Total Units:</strong> <span id="total-units-display"></span><br>
      🟩 <strong class="font-bold">Total Subtopics:</strong> <span id="total-subtopics-display"></span>
    </div>
</div>

<!-- Subtopic Modal Structure -->
<div id="subtopicModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
  <div class="bg-gray-50 rounded-2xl shadow-2xl p-6 md:p-8 w-11/12 md:w-2/3 lg:w-1/2 relative border border-gray-200 ring-4 ring-blue-200 ring-opacity-50">
    <button id="closeModal" class="absolute top-2 right-2 md:top-4 md:right-4 text-gray-700 hover:text-gray-900 bg-gray-100 hover:bg-gray-200 rounded-full p-1 md:p-2 transition-colors duration-200 ease-in-out text-3xl md:text-4xl font-bold">&times;</button>
    <h3 id="modalTitle" class="text-2xl md:text-3xl font-bold text-blue-800 mb-4"></h3>
    <ul id="modalSubtopics" class="list-none text-gray-700 space-y-2 md:space-y-3 leading-relaxed text-sm md:text-base">
      <!-- Subtopics will be dynamically added here -->
    </ul>
    <!-- Reminder Message Display - MOVED INSIDE MODAL CONTENT -->
    <div id="reminderMessage"></div>
  </div>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Your web app's Firebase configuration (provided by the user)
  const firebaseConfig = {
    apiKey: "AIzaSyApLfVQ6hv0IAAN5ZkFlOQ-y5KXK-x1Q_M",
    authDomain: "reminderapp-d84e9.firebaseapp.com",
    databaseURL: "https://reminderapp-d84e9-default-rtdb.firebaseio.com",
    projectId: "reminderapp-d84e9",
    storageBucket: "reminderapp-d84e9.firebasestorage.app",
    messagingSenderId: "312145339940",
    appId: "1:312145339940:web:ade59de4d6de6cec221ab1"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Global variables
  let userId = null;
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  // Updated structure for completedSubtopicsState to support multiple subjects
  let completedSubtopicsState = {}; // Stores { "SubjectName": { "Unit Title": { total: N, subtopics: { "Subtopic Text": true/false, ... } } } }
  let unsubscribeSnapshot = null; // To store the unsubscribe function for Firestore listener
  let isAuthReady = false; // New flag to indicate if auth and initial data load are complete
  let currentSubject = "Biology"; // Default subject

  // UI Elements
  const authSection = document.getElementById('auth-section');
  const mainContent = document.getElementById('main-content');
  const authErrorDiv = document.getElementById('auth-error');
  const emailInput = document.getElementById('email-input');
  const passwordInput = document.getElementById('password-input');
  const signInEmailBtn = document.getElementById('signin-email-btn');
  const signUpEmailBtn = document.getElementById('signup-email-btn');
  const signInGoogleBtn = document.getElementById('signin-google-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const userIdDisplay = document.getElementById('user-id-display');
  const loadingSpinner = document.getElementById('loading-spinner');
  // Removed subjectSelect
  const unitsContainer = document.getElementById('units-container');
  const totalUnitsDisplay = document.getElementById('total-units-display');
  const totalSubtopicsDisplay = document.getElementById('total-subtopics-display');

  // New UI Elements for subject buttons
  const biologyBtn = document.getElementById('biology-btn');
  const physicsBtn = document.getElementById('physics-btn');
  const chemistryBtn = document.getElementById('chemistry-btn');


  // Data for each subject
  const subjectData = {
    "Biology": {
      totalUnits: 10,
      totalSubtopics: 85,
      unitsHtmlId: 'biology-units'
    },
    "Physics": {
      totalUnits: 11, // Updated total units for Physics
      totalSubtopics: 62, // Updated total subtopics for Physics
      unitsHtmlId: 'physics-units'
    },
    "Chemistry": {
      totalUnits: 0, // Placeholder, will be updated by user input
      totalSubtopics: 0, // Placeholder, will be updated by user input
      unitsHtmlId: 'chemistry-units'
    }
  };


  // Function to display authentication errors
  function showAuthError(message) {
    authErrorDiv.textContent = message;
    authErrorDiv.classList.remove('hidden');
  }

  // Function to hide authentication errors
  function hideAuthError() {
    authErrorDiv.classList.add('hidden');
    authErrorDiv.textContent = '';
  }

  // Function to show the reminder message with a delay
  function showReminderMessage(message) {
    console.log("showReminderMessage function called with message:", message); // Debugging log
    reminderMessageDiv.textContent = message;
    // Add a small delay before showing the message
    setTimeout(() => {
      reminderMessageDiv.classList.add('show');
    }, 300); // 300ms delay
  }

  // Handle Google Sign-In
  signInGoogleBtn.addEventListener('click', async () => {
    hideAuthError();
    try {
      await signInWithPopup(auth, new GoogleAuthProvider());
    } catch (error) {
      console.error("Google Sign-In Error:", error);
      showAuthError(error.message);
    }
  });

  // Handle Email/Password Sign-Up
  signUpEmailBtn.addEventListener('click', async () => {
    hideAuthError();
    const email = emailInput.value;
    const password = passwordInput.value;
    if (!email || !password) {
      showAuthError("Please enter both email and password.");
      return;
    }
    try {
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error("Email Sign-Up Error:", error);
      showAuthError(error.message);
    }
  });

  // Handle Email/Password Sign-In
  signInEmailBtn.addEventListener('click', async () => {
    hideAuthError();
    const email = emailInput.value;
    const password = passwordInput.value; // Corrected variable name
    if (!email || !password) {
      showAuthError("Please enter both email and password.");
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error("Email Sign-In Error:", error);
      showAuthError(error.message);
    }
  });

  // Handle Logout
  logoutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
    } catch (error) {
      console.error("Logout Error:", error);
      showAuthError("Failed to log out."); // Display error if logout fails
    }
  });

  // Function to update the count on the main unit button
  function updateUnitCompletionDisplay(unitElement) {
    const unitTitleText = unitElement.querySelector('.unit-title span:first-child').textContent;
    const totalSubtopicsSpan = unitElement.querySelector('.unit-title span:last-child');

    let completedCount = 0;
    const unitData = completedSubtopicsState[currentSubject] && completedSubtopicsState[currentSubject][unitTitleText];

    if (unitData && unitData.subtopics) {
      for (const subtopicText in unitData.subtopics) {
        if (unitData.subtopics[subtopicText]) {
          completedCount++;
        }
      }
      // Use the stored total from unitData
      totalSubtopicsSpan.textContent = `(${completedCount}/${unitData.total})`;
    } else {
      // Fallback if data is not yet initialized for some reason
      totalSubtopicsSpan.textContent = `(0/${parseInt(totalSubtopicsSpan.textContent.replace(/[()]/g, '')) || 0})`;
    }
  }

  // Function to initialize unit completion displays for the current subject
  function initializeUnitDisplaysForCurrentSubject() {
    let currentTotalUnits = 0;
    let currentTotalSubtopics = 0;

    // Hide all subject unit containers first
    document.querySelectorAll('.subject-units').forEach(container => {
      container.classList.add('hidden');
    });

    // Show the container for the current subject
    const currentSubjectUnitsContainer = document.getElementById(subjectData[currentSubject].unitsHtmlId);
    if (currentSubjectUnitsContainer) {
      currentSubjectUnitsContainer.classList.remove('hidden');
    }

    document.querySelectorAll(`#${subjectData[currentSubject].unitsHtmlId} .unit`).forEach(unitElement => {
      currentTotalUnits++;
      const unitTitleText = unitElement.querySelector('.unit-title span:first-child').textContent;
      const subtopicsList = unitElement.querySelector('.subtopics');
      const totalSubtopicsSpan = unitElement.querySelector('.unit-title span:last-child');
      const initialTotalSubtopics = parseInt(totalSubtopicsSpan.textContent.replace(/[()]/g, ''));

      currentTotalSubtopics += initialTotalSubtopics;

      // Ensure the subject and unit entries exist in completedSubtopicsState
      if (!completedSubtopicsState[currentSubject]) {
        completedSubtopicsState[currentSubject] = {};
      }
      if (!completedSubtopicsState[currentSubject][unitTitleText]) {
        completedSubtopicsState[currentSubject][unitTitleText] = {
          total: initialTotalSubtopics,
          subtopics: {}
        };
      } else if (typeof completedSubtopicsState[currentSubject][unitTitleText].total === 'undefined' || isNaN(completedSubtopicsState[currentSubject][unitTitleText].total)) {
        completedSubtopicsState[currentSubject][unitTitleText].total = initialTotalSubtopics;
      }

      // Initialize subtopics within the state if they don't exist
      Array.from(subtopicsList.children).forEach(subtopic => {
        const subtopicText = subtopic.textContent;
        if (typeof completedSubtopicsState[currentSubject][unitTitleText].subtopics[subtopicText] === 'undefined') {
          completedSubtopicsState[currentSubject][unitTitleText].subtopics[subtopicText] = false;
        }
      });
      // Update display to reflect current state or (0/Total)
      updateUnitCompletionDisplay(unitElement);
    });

    // Update the summary section totals
    totalUnitsDisplay.textContent = currentTotalUnits;
    totalSubtopicsDisplay.textContent = currentTotalSubtopics;

    // Update active button styling
    document.querySelectorAll('.subject-button').forEach(button => {
        if (button.id === `${currentSubject.toLowerCase()}-btn`) {
            button.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            button.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
        } else {
            button.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        }
    });
  }


  // Function to open the subtopics modal
  window.openSubtopicsModal = async (unitElement) => { // Added 'async' here as it calls async functions
    console.log("openSubtopicsModal called. isAuthReady:", isAuthReady); // Debugging log
    // Prevent modal from opening if authentication and data loading are not ready
    if (!isAuthReady) {
      showAuthError("Please wait, loading your data or sign in to track your progress.");
      return;
    }
    hideAuthError(); // Hide any previous auth errors

    const unitTitleText = unitElement.querySelector('.unit-title span:first-child').textContent;
    const subtopicsList = unitElement.querySelector('.subtopics');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtopics = document.getElementById('modalSubtopics');
    const subtopicModal = document.getElementById('subtopicModal');
    const reminderMessageDiv = document.getElementById('reminderMessage');

    console.log("Subtopics list children count:", subtopicsList.children.length); // Debugging log

    // Set modal title
    modalTitle.textContent = unitTitleText;

    // Clear previous subtopics
    modalSubtopics.innerHTML = '';

    const unitData = completedSubtopicsState[currentSubject] && completedSubtopicsState[currentSubject][unitTitleText];

    // Populate modal with subtopics and add tick circles
    Array.from(subtopicsList.children).forEach(subtopic => {
      const li = document.createElement('li');
      li.classList.add('flex', 'items-center', 'gap-3');

      const tickCircle = document.createElement('span');
      tickCircle.classList.add('tick-circle');

      const subtopicTextContent = subtopic.textContent;

      // Set initial state of tick circle from global state
      if (unitData && unitData.subtopics && unitData.subtopics[subtopicTextContent]) {
        tickCircle.classList.add('checked');
        tickCircle.innerHTML = '&#10003;';
      } else {
        tickCircle.innerHTML = '';
      }

      // Add click event listener to toggle checked state
      tickCircle.addEventListener('click', async () => {
        tickCircle.classList.toggle('checked');
        const isChecked = tickCircle.classList.contains('checked');
        tickCircle.innerHTML = isChecked ? '&#10003;' : '';

        // Update global state
        if (!completedSubtopicsState[currentSubject]) {
            completedSubtopicsState[currentSubject] = {};
        }
        if (!completedSubtopicsState[currentSubject][unitTitleText]) {
            completedSubtopicsState[currentSubject][unitTitleText] = { total: 0, subtopics: {} };
        }
        if (!completedSubtopicsState[currentSubject][unitTitleText].subtopics) {
            completedSubtopicsState[currentSubject][unitTitleText].subtopics = {};
        }
        completedSubtopicsState[currentSubject][unitTitleText].subtopics[subtopicTextContent] = isChecked;

        // Update the count on the main unit button
        updateUnitCompletionDisplay(unitElement);

        // Save to Firestore
        if (userId) {
          try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/userData/${currentSubject}`);
            // Save the entire completedSubtopicsState object for the current subject
            await setDoc(userDocRef, { data: JSON.stringify(completedSubtopicsState[currentSubject]) }, { merge: true });
            console.log("Subtopic state saved to Firestore for", currentSubject);
          } catch (e) {
            console.error("Error saving document: ", e);
            showAuthError("Error saving progress. Please try again.");
          }
        }

        // Show reminder message if ticked
        if (isChecked) {
          console.log("Subtopic ticked. Attempting to show reminder message."); // Debugging log
          showReminderMessage(`[${subtopicTextContent}] සඳහා මතක් කිරීමක් එක් කරන්න`);
        } else {
          // If unticked, hide the reminder message if it's currently showing for this subtopic
          if (reminderMessageDiv.textContent.includes(subtopicTextContent)) {
            hideReminderMessage();
          }
        }
      });

      const subtopicDisplay = document.createElement('span');
      subtopicDisplay.textContent = subtopicTextContent;
      subtopicDisplay.classList.add('flex-grow');

      li.appendChild(tickCircle);
      li.appendChild(subtopicDisplay);
      modalSubtopics.appendChild(li);
    });

    console.log("Removing hidden class from modal."); // Debugging log
    // Show the modal overlay
    subtopicModal.classList.remove('hidden');

    // Force a reflow to ensure the 'display' change is rendered before applying 'is-active'
    subtopicModal.offsetWidth;

    console.log("Adding is-active class to modal."); // Debugging log
    // Add 'is-active' class to trigger the pop-in animation
    subtopicModal.classList.add('is-active');
    subtopicModal.classList.remove('is-closing'); // Ensure closing animation class is removed
  }; // End of window.openSubtopicsModal definition

  // Get modal elements (these are global for the modal)
  const subtopicModal = document.getElementById('subtopicModal');
  const closeModalButton = document.getElementById('closeModal');
  const reminderMessageDiv = document.getElementById('reminderMessage');

  // Add event listener to the reminder message div to open the URL
  reminderMessageDiv.addEventListener('click', () => {
    window.open('https://alstudy063.github.io/my-reminder-app/Unsaved%20Document%202.html', '_blank');
  });

  // Function to hide the reminder message
  function hideReminderMessage() {
    reminderMessageDiv.classList.remove('show');
  }

  // Function to close the modal with animation
  function closeSubtopicModal() {
    // Add 'is-closing' class to trigger the pop-out animation
    subtopicModal.classList.add('is-closing');
    subtopicModal.classList.remove('is-active'); // Remove active class for overlay fade

    hideReminderMessage(); // Hide reminder when modal closes

    // Hide the modal completely after the animation ends
    subtopicModal.querySelector('div').addEventListener('animationend', function handler() {
      subtopicModal.classList.add('hidden');
      subtopicModal.classList.remove('is-closing'); // Clean up the closing class
      this.removeEventListener('animationend', handler); // Remove listener
    }, { once: true }); // Ensure the listener is called only once
  }

  // Close modal when close button is clicked
  closeModalButton.addEventListener('click', closeSubtopicModal);

  // Close modal when clicking outside the modal content
  subtopicModal.addEventListener('click', (event) => {
    if (event.target === subtopicModal) {
      closeSubtopicModal();
    }
  });

  // Function to load data for the selected subject
  async function loadSubjectData(subject) {
    if (!userId) {
      console.warn("User not logged in, cannot load subject data.");
      return;
    }

    // Unsubscribe from previous snapshot listener if it exists
    if (unsubscribeSnapshot) {
      unsubscribeSnapshot();
      unsubscribeSnapshot = null;
    }

    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/userData/${subject}`);
    unsubscribeSnapshot = onSnapshot(userDocRef, (docSnap) => {
      // Create a temporary state based on initial HTML structure for the current subject
      const tempSubjectState = {};
      document.querySelectorAll(`#${subjectData[subject].unitsHtmlId} .unit`).forEach(unitElement => {
          const unitTitleText = unitElement.querySelector('.unit-title span:first-child').textContent;
          const totalSubtopicsSpan = unitElement.querySelector('.unit-title span:last-child');
          const initialTotalSubtopics = parseInt(totalSubtopicsSpan.textContent.replace(/[()]/g, ''));
          const subtopicsList = unitElement.querySelector('.subtopics');

          tempSubjectState[unitTitleText] = {
              total: initialTotalSubtopics,
              subtopics: {}
          };
          Array.from(subtopicsList.children).forEach(subtopic => {
              tempSubjectState[unitTitleText].subtopics[subtopic.textContent] = false;
          });
      });

      if (docSnap.exists() && docSnap.data().data) {
        try {
          const loadedData = JSON.parse(docSnap.data().data);
          // Merge loaded data into the temporary state for the current subject
          for (const unitTitle in tempSubjectState) {
              if (loadedData[unitTitle] && loadedData[unitTitle].subtopics) {
                  for (const subtopicText in tempSubjectState[unitTitle].subtopics) {
                      if (typeof loadedData[unitTitle].subtopics[subtopicText] !== 'undefined') {
                          tempSubjectState[unitTitle].subtopics[subtopicText] = loadedData[unitTitle].subtopics[subtopicText];
                      }
                  }
              }
          }
          completedSubtopicsState[subject] = tempSubjectState; // Assign the merged state for this subject
          console.log("Loaded and merged completed subtopics for", subject, ":", completedSubtopicsState[subject]);
        } catch (e) {
          console.error("Error parsing Firestore data for", subject, ":", e);
          completedSubtopicsState[subject] = tempSubjectState; // Fallback to initial HTML structure
        }
      } else {
        console.log("No completed subtopics found for", subject, ", initializing empty state from HTML.");
        completedSubtopicsState[subject] = tempSubjectState; // Use initial HTML structure
      }
      initializeUnitDisplaysForCurrentSubject(); // Update UI with loaded or re-initialized data
      isAuthReady = true; // Set flag to true after data is loaded and UI updated
      console.log("isAuthReady set to true after data load for", subject); // Debugging log
    }, (error) => {
      console.error("Error listening to Firestore for", subject, ":", error);
      showAuthError("Error loading user data for " + subject);
      isAuthReady = true; // Still set to true, even on error, to allow interaction (though data might be missing)
      console.log("isAuthReady set to true after Firestore error for", subject); // Debugging log
    });
  }

  // Event listeners for subject buttons
  biologyBtn.addEventListener('click', () => {
    currentSubject = "Biology";
    console.log("Subject changed to:", currentSubject);
    if (userId) {
      loadSubjectData(currentSubject);
    } else {
      initializeUnitDisplaysForCurrentSubject();
    }
  });

  physicsBtn.addEventListener('click', () => {
    currentSubject = "Physics";
    console.log("Subject changed to:", currentSubject);
    if (userId) {
      loadSubjectData(currentSubject);
    } else {
      initializeUnitDisplaysForCurrentSubject();
    }
  });

  chemistryBtn.addEventListener('click', () => {
    currentSubject = "Chemistry";
    console.log("Subject changed to:", currentSubject);
    if (userId) {
      loadSubjectData(currentSubject);
    } else {
      initializeUnitDisplaysForCurrentSubject();
    }
  });


  // Firebase Auth State Listener
  onAuthStateChanged(auth, async (user) => {
    loadingSpinner.classList.add('hidden'); // Always hide spinner once auth state is determined
    if (user) {
      // User is signed in
      userId = user.uid;
      userIdDisplay.textContent = `User ID: ${userId}`;
      authSection.classList.add('hidden');
      mainContent.classList.remove('hidden'); // Show main content
      hideAuthError(); // Hide any auth errors once logged in

      // Initialize UI for the current subject immediately after showing main content
      // This ensures the correct subject's units are displayed even before Firestore data loads
      initializeUnitDisplaysForCurrentSubject();

      // Load data for the current subject (default or last selected)
      loadSubjectData(currentSubject);

    } else {
      // User is signed out
      userId = null;
      userIdDisplay.textContent = '';
      authSection.classList.remove('hidden'); // Show auth section
      mainContent.classList.add('hidden'); // Ensure main content is hidden
      completedSubtopicsState = {}; // Clear state on logout
      initializeUnitDisplaysForCurrentSubject(); // Reset UI counts to 0 for current subject
      isAuthReady = false; // Reset flag when logged out
      console.log("isAuthReady set to false after logout."); // Debugging log

      // Unsubscribe from snapshot listener when user logs out
      if (unsubscribeSnapshot) {
        unsubscribeSnapshot();
        unsubscribeSnapshot = null;
      }
    }
  });

  // Initial anonymous sign-in or custom token sign-in
  document.addEventListener('DOMContentLoaded', async () => {
    loadingSpinner.classList.remove('hidden'); // Show spinner immediately on DOMContentLoaded
    // Do not try to sign in here. Let onAuthStateChanged handle the initial state.
    // The onAuthStateChanged listener will fire immediately if a session is persisted.
    // If no session, it will fire with user=null, and then the auth section will show.
    // Explicitly call signInAnonymously if no token is provided.
    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        // Firebase automatically handles custom token sign-in if a token is provided
        // and onAuthStateChanged will reflect the result.
        // No explicit signInWithCustomToken call needed here if onAuthStateChanged is the primary handler.
        // If you *must* force a sign-in attempt here, ensure it's awaited and its outcome
        // is handled to hide the spinner and show correct UI.
        // For now, relying solely on onAuthStateChanged to manage initial UI state.
    } else {
        // If no initial token, attempt anonymous sign-in.
        try {
            await signInAnonymously(auth);
            console.log("Attempted anonymous sign-in on DOMContentLoaded.");
        } catch (error) {
            console.error("Anonymous sign-in failed on DOMContentLoaded:", error);
            // If anonymous sign-in fails, onAuthStateChanged will still handle showing auth section
        }
    }
  });
</script>

</body>
</html>
