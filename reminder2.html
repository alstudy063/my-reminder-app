<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Subject Study Reminder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General body styling for font, background, and centering */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0; /* Removed default padding to allow container to stretch fully */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center content vertically and horizontally */
            min-height: 100vh; /* Ensure body takes full viewport height */
            width: 100vw; /* Ensure body takes full viewport width */
            overflow: hidden; /* Hide overflow initially, container will handle scrolling */
        }

        /* Container for the main application content */
        .container {
            background-color: #fff;
            padding: 30px; /* Default padding for content inside */
            border-radius: 10px; /* Default border-radius for mobile */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Default shadow for mobile */
            width: 100%;
            max-width: 800px; /* Default max-width for mobile */
            height: auto; /* Default height for mobile */
            box-sizing: border-box;
            margin-bottom: 20px; /* Default margin for mobile */
            position: relative; /* Added for positioning settings button */
            display: none; /* Hidden by default until authenticated */
            overflow-y: auto; /* Enable vertical scrolling for content within container */
        }

        /* Media query for desktop/larger screens: Make the container fill the screen */
        @media (min-width: 768px) {
            body {
                overflow: hidden; /* Prevent body scrollbars on desktop */
            }
            .container {
                max-width: 100vw; /* Take full viewport width */
                width: 100vw; /* Ensure it spans full width */
                height: 100vh; /* Take full viewport height */
                margin: 0; /* Remove any margins */
                border-radius: 0; /* No border radius for true full screen */
                box-shadow: none; /* No shadow for true full screen */
            }
        }

        /* Media query for mobile/small screens: Re-apply body padding and container styling */
        @media (max-width: 767px) {
            body {
                padding: 20px; /* Reintroduce padding for mobile */
                overflow-y: auto; /* Allow body scrolling on mobile */
            }
            .container {
                margin-bottom: 20px; /* Restore margin-bottom */
                border-radius: 10px; /* Restore border-radius */
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Restore shadow */
            }
        }

        /* Styling for the main heading */
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        /* Styling for section headings (e.g., Today's Reminders) */
        h2 {
            color: #34495e;
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
        }

        /* New Add Reminder Button Section - Adjusted for centering */
        .add-new-reminder-section {
            width: 100%; /* Ensures it takes full width of its parent */
            display: flex; /* Use flexbox for alignment */
            justify-content: center; /* Align content to the center */
            margin-bottom: 30px;
            box-sizing: border-box; /* Include padding in width calculation */
            gap: 15px; /* Gap between the two buttons */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        .add-new-reminder-button {
            padding: 12px 25px;
            background-image: linear-gradient(to right, #007bff, #0056b3); /* Blue gradient */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .add-new-reminder-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.15); /* Subtle overlay for hover */
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: -1;
        }
        .add-new-reminder-button:hover::before {
            transform: translateX(0);
        }
        .add-new-reminder-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .add-new-reminder-button svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* Styling for the new SVG button */
        .svg-action-button {
            background-color: #f0f2f5; /* Light background for the SVG button */
            border: 1px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            padding: 8px; /* Padding to make it clickable */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        .svg-action-button:hover {
            background-color: #e0e2e5; /* Slightly darker on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .svg-action-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .svg-action-button svg {
            width: 32px; /* Make the SVG slightly larger for prominence */
            height: 32px;
            /* Fill is defined by the SVG itself, so no generic fill here */
        }


        /* Styling for form groups (label + input/select) in modals */
        .form-group {
            flex: 1; /* Allows form groups to grow and shrink */
            min-width: 200px; /* Minimum width before wrapping */
        }

        .form-group label {
            display: block; /* Makes label take full width */
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea { /* Added textarea for custom intervals */
            width: 100%; /* Inputs take full width of their container */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; /* Includes padding and border in the element's total width and height */
            background-color: white; /* Ensure select has a background */
        }

        .form-group textarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 60px;
        }

        /* New container for filter and action buttons */
        .filter-and-action-controls {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            justify-content: space-between; /* Distribute items with space between them */
            align-items: center;
            margin-bottom: 20px;
            gap: 15px; /* Gap between filter and button section */
        }

        /* Styling for the subject filter dropdown */
        .subject-filter {
            display: flex; /* Use flexbox to align label and select */
            align-items: center;
            gap: 10px; /* Space between label and select */
            flex-grow: 1; /* Allows it to grow within the parent container */
            min-width: 280px; /* Ensure it doesn't get too small */
        }

        .subject-filter label {
            font-weight: bold;
            color: #555;
            white-space: nowrap; /* Prevent label from wrapping */
        }

        .subject-filter select {
            flex-grow: 1; /* Allow select to take available space */
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            background-color: white;
        }

        /* New section for action buttons (Incomplete, Progress) */
        .action-buttons-section {
            display: flex;
            justify-content: center; /* Center the buttons within their section */
            gap: 10px; /* Space between buttons */
            flex-wrap: wrap; /* Allow wrapping on small screens */
            flex-shrink: 0; /* Prevent buttons section from shrinking too much */
        }

        .action-button {
            padding: 10px; /* Reduced padding for icon-only */
            background-color: #6c757d; /* Grey */
            color: white; /* Keep color for consistency with SVG fill */
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center icon within button */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            width: 40px; /* Fixed width for icon-only button */
            height: 40px; /* Fixed height for icon-only button */
        }

        .action-button:hover {
            background-color: #5a6268;
        }
        .action-button.active { /* Style for active incomplete button */
            background-color: #28a745; /* Green to indicate active filter */
        }
        .action-button.active:hover {
            background-color: #218838;
        }


        .action-button svg {
            fill: white;
            width: 20px;
            height: 20px;
        }

        /* Updated Styling for the unordered list of reminders - now a grid */
        .reminder-list {
            list-style: none;
            padding: 0;
            display: grid; /* Changed to grid */
            gap: 20px; /* Space between cards */
            justify-content: center; /* Center the grid if items don't fill a row perfectly */
            align-items: stretch; /* Ensures all cards in a row have the same height */
            /* grid-template-columns is now dynamically set by JavaScript */
        }

        /* Styling for individual reminder items (mini cards) */
        .reminder-item {
            background-color: #ecf0f1; /* Light grey */
            border: 1px solid #ddd;
            border-left: 5px solid #3498db; /* Blue accent for general reminders */
            padding: 15px;
            border-radius: 8px;
            display: flex; /* Changed to flex */
            flex-direction: column; /* Stack content vertically */
            justify-content: space-between; /* Space out content and action button */
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* Smooth hover effects */
            min-height: 160px; /* Minimum height for consistency */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Enhanced initial shadow */
        }

        /* Specific styling for reminders due today */
        .reminder-item.today {
            border-left-color: #e74c3c; /* Red accent for today's reminders */
            background-color: #ffebeb; /* Lighter red background */
        }

        .reminder-item:hover {
            transform: translateY(-3px); /* Lifts the item slightly on hover */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); /* More prominent shadow on hover */
        }

        /* Details section within a reminder item */
        .reminder-details {
            flex-grow: 1; /* Allows details to take up available space, pushing actions down */
            margin-bottom: 10px; /* Space between details and actions */
        }

        .reminder-details strong {
            font-size: 1.1em;
            color: #2c3e50;
        }

        .reminder-details span {
            display: block; /* Each detail on its own line */
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 3px;
        }

        /* Actions section (e.g., Mark Reviewed button) within a reminder item */
        .reminder-actions {
            width: 100%; /* Make actions section take full width of card */
            display: flex; /* Use flex for button alignment */
            justify-content: center; /* Center the button within the card */
            margin-top: auto; /* Pushes the actions to the bottom of the card */
        }

        /* Modernized Mark Reviewed Button Style */
        .reminder-actions button.mark-reviewed-button {
            padding: 10px 20px; /* Adjusted padding */
            background-image: linear-gradient(to right, #28a745, #218838); /* Green gradient */
            color: white;
            border: none;
            border-radius: 8px; /* Consistent rounded corners */
            cursor: pointer;
            font-size: 1em; /* Adjusted font size */
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); /* Similar shadow to other modern buttons */
            width: auto; /* Let content determine width, or set specific width if needed */
            flex-grow: 1; /* Allow to grow within reminder-actions */
            max-width: 180px; /* Prevent it from becoming too wide in a narrow card */
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .reminder-actions button.mark-reviewed-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.15); /* Subtle overlay for hover */
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: -1;
        }
        .reminder-actions button.mark-reviewed-button:hover::before {
            transform: translateX(0);
        }
        .reminder-actions button.mark-reviewed-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }


        /* Settings button specific styling */
        .settings-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-button:hover {
            background-color: #e0e0e0;
        }

        .settings-button svg {
            width: 20px;
            height: 20px;
            fill: #7f8c8d; /* Grey color for icon */
        }

        /* Styling for messages when reminder lists are empty */
        .empty-message {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            margin-top: 15px;
            background-color: #f9f9f9;
            /* Make empty message span full grid width */
            grid-column: 1 / -1;
        }

        /* --- Modal Styles (common for all modals) --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Default z-index for most modals */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.6); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            padding: 20px; /* Add some padding for small screens */
            box-sizing: border-box;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: fadeIn 0.3s ease-out; /* Ensured fadeIn animation is present */
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }

        .modal-body .form-group {
            margin-bottom: 15px;
        }

        .modal-body .form-group label {
            margin-bottom: 8px;
        }

        /* Buttons within modals (Save, Cancel, Delete, Reset) */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            border-top: 1px solid #eee;
            padding-top: 20px;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }

        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px; /* Slightly more rounded */
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease; /* Smooth transition for all properties */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); /* More prominent shadow */
            position: relative;
            overflow: hidden; /* For pseudo-element effects */
            z-index: 1;
        }

        .modal-footer button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.15); /* Subtle overlay for hover */
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: -1;
        }

        .modal-footer button:hover::before {
            transform: translateX(0);
        }

        .modal-footer button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Smaller shadow on press */
        }

        /* Modernized Button Styles for Settings Modal */
        .modal-footer .save-button {
            background-image: linear-gradient(to right, #22c55e, #16a34a); /* Tailwind green-500 to green-600 */
            color: white;
        }
        .modal-footer .save-button:hover {
            background-image: linear-gradient(to right, #16a34a, #15803d); /* Slightly darker green */
        }

        .modal-footer .cancel-button {
            background-image: linear-gradient(to right, #6b7280, #4b5563); /* Tailwind gray-500 to gray-600 */
            color: white;
        }
        .modal-footer .cancel-button:hover {
            background-image: linear-gradient(to right, #4b5563, #374151); /* Slightly darker gray */
        }

        .modal-footer .delete-button {
            background-image: linear-gradient(to right, #ef4444, #dc2626); /* Tailwind red-500 to red-600 */
            color: white;
            margin-right: auto; /* Pushes other buttons to the right */
        }
        .modal-footer .delete-button:hover {
            background-image: linear-gradient(to right, #dc2626, #b91c1c); /* Slightly darker red */
        }

        .modal-footer .reset-pattern-button {
            background-image: linear-gradient(to right, #facc15, #eab308); /* Tailwind yellow-400 to yellow-500 */
            color: #333; /* Darker text for better contrast on light background */
        }
        .modal-footer .reset-pattern-button:hover {
            background-image: linear-gradient(to right, #eab308, #d97706); /* Slightly darker yellow/orange */
        }


        /* Custom CSS for Circular Progress Bars from user's provided code */
        /* IMPORTANT: This section uses specific styling for the progress circles */
        #myProgressModal .modal-content {
            background-color: #0d1117; /* Dark background similar to the image for the progress modal */
            color: #ffffff; /* White text for readability in the modal */
            max-width: 1100px; /* Increased max-width for even longer display */
            width: 95%; /* Ensure it uses 95% of available width up to max */
            padding: 15px 30px; /* Reduced vertical padding further, maintaining horizontal */
        }

        #myProgressModal h3 {
            color: #ffffff; /* White heading in the progress modal */
        }

        #myProgressModal .close-button {
            color: #ffffff; /* White close button */
        }

        /* Progress Circle styles as provided by user */
        .progress-circle {
            position: relative;
            width: 180px; /* Diameter of the circle */
            height: 180px; /* Diameter of the circle */
            border-radius: 50%;
            display: flex;
            flex-direction: column; /* Arrange content vertically inside */
            justify-content: center;
            align-items: center;
            /* Initial conic-gradient, will be updated by JS */
            background: conic-gradient(transparent 0deg, transparent 0deg);
            margin: 1.5rem; /* Default spacing between circles */
            /* Outer border with subject-specific color and subtle glow */
            box-shadow: 0 0 0 3px var(--color), 0 0 15px rgba(0, 0, 0, 0.5);
            flex-shrink: 0; /* Prevent shrinking on small screens */
        }

        .progress-circle::before {
            content: '';
            position: absolute;
            /* Increased cutout to make the progress bar ring itself thicker */
            width: calc(100% - 40px); /* Adjusted from 24px to 40px */
            height: calc(100% - 40px); /* Adjusted from 24px to 40px */
            background-color: #0d1117; /* Same as modal background to create the inner dark circle */
            border-radius: 50%;
            z-index: 1; /* Ensure inner circle is above the gradient */
            /* This creates the inner border of the progress ring */
            border: 2px solid rgba(255, 255, 255, 0.1); /* Subtle white inner border */
        }

        .progress-content {
            position: relative;
            z-index: 2; /* Ensure content is above the inner circle */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; /* Take full height of the parent flex container */
            width: 100%; /* Take full width */
        }

        .progress-percentage {
            font-size: 2.5rem; /* Font size as per provided code */
            font-weight: 700;
            color: #ffffff; /* White text for readability */
            margin-bottom: 0.25rem; /* Small gap between percentage and label */
        }

        .label {
            font-size: 1rem; /* Smaller font size for label inside the circle as per provided code */
            font-weight: 600;
            color: #ffffff; /* White text for labels */
            text-align: center;
        }

        /* Specific colors for each bar (glow handled by box-shadow) */
        .progress-biology {
            --color: #00ff00; /* Green */
        }
        .progress-physics {
            --color: #ff0066; /* Pink */
        }
        .progress-chemistry {
            --color: #00ffff; /* Cyan */
        }

        /* The .glow class is re-added, though JS explicitly removes filter */
        .glow {
            filter: drop-shadow(0 0 8px var(--color)) drop-shadow(0 0 20px var(--color));
        }

        /* Animation for percentage update */
        @keyframes fillProgress {
            from {
                background: conic-gradient(transparent 0deg, transparent 0deg);
            }
            to {
                background: conic-gradient(var(--color) calc(var(--percentage) * 3.6deg), transparent calc(var(--percentage) * 3.6deg));
            }
        }

        /* Progress Circles Container: Default (Desktop) Styling */
        #myProgressModal .modal-body .progress-circles-container {
            display: flex;
            flex-direction: row; /* Horizontal on desktop */
            justify-content: center;
            align-items: center;
            gap: 3rem; /* Spacing between circles on desktop */
            padding: 1rem 0; /* Some padding for the container */
            flex-wrap: wrap; /* Allow wrapping if space is tight horizontally */
        }

        /* Responsive adjustments for progress circles */
        @media (max-width: 640px) {
            /* Adjust individual circle size for very small screens if needed */
            .progress-circle {
                width: 150px;
                height: 150px;
                /* Reset margins and rely on container gap for vertical spacing */
                margin: 0 auto; /* Horizontal auto-margin for centering each circle */
            }
            .progress-circle::before {
                width: calc(100% - 30px);
                height: calc(100% - 30px);
            }
            .progress-percentage {
                font-size: 2rem;
            }
            .label {
                font-size: 0.9rem;
            }
            /* Force vertical stacking on small screens */
            #myProgressModal .modal-body .progress-circles-container {
                 flex-direction: column; /* Stack vertically */
                 align-items: center; /* Ensures items are centered in the column */
                 gap: 1.5rem; /* Add vertical gap between stacked circles */
            }
        }

        /* Custom alert/confirmation modal */
        #customAlertModal {
            z-index: 1015; /* Higher than profile and name edit modals */
        }
        #customAlertModal .modal-content {
            max-width: 400px;
            text-align: center;
        }
        #customAlertModal .modal-body {
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        #customAlertModal .modal-footer {
            justify-content: center;
        }

        /* New styles for settings dropdown */
        .settings-dropdown-container {
            position: absolute;
            top: 20px; /* Adjust as needed */
            right: 20px; /* Adjust as needed */
            z-index: 1010; /* Above other modals if possible */
        }

        .settings-dropdown-button {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        .settings-dropdown-button:hover {
            background-color: #5a6268;
        }

        .settings-dropdown-button svg {
            fill: white;
            width: 24px;
            height: 24px;
        }

        .settings-menu {
            display: none; /* Hidden by default */
            position: absolute;
            top: 50px; /* Below the button */
            right: 0;
            background-color: #fff;
            border-radius: 8鸣px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            overflow: hidden;
            z-index: 1000; /* Ensure it's above normal content */
        }

        .settings-menu.show {
            display: block;
        }

        .settings-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .settings-menu li button {
            width: 100%;
            text-align: left;
            padding: 12px 20px;
            background: none;
            border: none;
            color: #333;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-menu li button:hover {
            background-color: #f0f0f0;
        }

        .settings-menu li button svg {
            width: 20px;
            height: 20px;
            fill: #333;
        }

        /* Error message box style (global) */
        .error-message-box {
            display: none; /* Hidden by default */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffebeb; /* Light red background */
            border: 2px solid #e74c3c; /* Red border */
            color: #c0392b; /* Darker red text */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            z-index: 1020; /* Ensure it's on top of everything */
            max-width: 90%; /* Responsive width */
            box-sizing: border-box;
        }

        /* New style for the settings card (will be used in the new modal) */
        .settings-card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .settings-card h4 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Added loading indicator styles */
        #loadingOverlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1030;
            font-size: 1.5em;
            color: #333;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Modal Specific Styles */
        #loginModal {
            background-color: rgba(0, 0, 0, 0.7); /* Darker overlay for login */
            z-index: 1040; /* Highest z-index to be on top of loading overlay */
        }

        .login-content {
            background-color: #fefefe;
            padding: 40px; /* Increased padding */
            border-radius: 15px; /* More rounded corners */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            width: 90%;
            max-width: 480px; /* Slightly adjusted max-width */
            animation: fadeIn 0.4s ease-out; /* Slightly longer animation */
        }

        .error-message {
            color: #ef4444; /* Tailwind red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
        .input-error {
            border-color: #ef4444 !important; /* Ensure red border on error */
        }
        .input-error:focus {
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5); /* Red ring on focus for error */
        }

        /* Custom gradient for modern button */
        .btn-primary-modern {
            background-image: linear-gradient(to right, #4F46E5, #6366F1); /* From indigo-600 to indigo-500 */
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary-modern:hover {
            background-image: linear-gradient(to right, #4338CA, #4F46E5); /* Slightly darker on hover */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* Profile Modal Styles */
        #profileModal {
            z-index: 1005; /* Lower than customAlertModal, higher than general modals */
        }
        #profileModal .modal-content {
            background-color: white;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Stronger, softer shadow */
            display: flex;
            flex-direction: column;
            max-width: 900px; /* Max width for desktop */
            width: 100%; /* Default to full width */
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05); /* Subtle border */
            padding: 0; /* Reset padding to be controlled by inner sections */
            position: relative; /* For positioning close button */
        }

        @media (min-width: 768px) {
            #profileModal .modal-content {
                flex-direction: row; /* Side-by-side on desktop */
                width: 90%; /* Responsive width on desktop */
                height: auto; /* Height adapts to content */
                max-height: 90vh; /* Max height to prevent overflow on larger profiles */
            }
        }
        /* Mobile Full Screen for Profile Modal */
        @media (max-width: 767px) {
            #profileModal .modal-overlay {
                padding: 0; /* Remove padding from overlay for full screen effect */
            }
            #profileModal .modal-content {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border-radius: 0; /* No rounded corners for full screen */
                padding: 20px; /* Add some padding back for content */
                overflow-y: auto; /* Enable scrolling if content overflows */
            }
            #profileModal .modal-header {
                padding: 15px 0; /* Adjust padding for mobile full screen header */
                margin-bottom: 10px;
            }
        }

        /* Close button for Profile Modal */
        #closeProfileModalButton {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            color: #777;
            cursor: pointer;
            z-index: 10;
        }
        #closeProfileModalButton:hover {
            color: #333;
        }

        /* Profile sections within the modal */
        .profile-left-section {
            flex-none;
            width: 100%; /* Full width on mobile */
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05); /* Border on bottom for mobile */
            border-radius: 1.5rem 1.5rem 0 0; /* Rounded top for mobile */
        }

        .profile-right-section {
            flex-grow: 1;
            width: 100%; /* Full width on mobile */
            padding: 2rem;
            background-color: #f9fafb; /* Light grey background */
            border-radius: 0 0 1.5rem 1.5rem; /* Rounded bottom for mobile */
        }

        @media (min-width: 768px) {
            .profile-left-section {
                width: 33.333333%; /* 1/3 width on desktop */
                border-right: 1px solid rgba(0, 0, 0, 0.05); /* Border on right for desktop */
                border-bottom: none; /* No bottom border on desktop */
                border-radius: 1.5rem 0 0 1.5rem; /* Rounded left for desktop */
            }
            .profile-right-section {
                width: 66.666667%; /* 2/3 width on desktop */
                border-radius: 0 1.5rem 1.5rem 0; /* Rounded right for desktop */
            }
        }

        /* Profile Card elements from user's code */
        .profile-image {
            width: 128px;
            height: 128px;
            border-radius: 9999px; /* Tailwind `rounded-full` */
            overflow: hidden;
            margin-bottom: 1rem; /* Tailwind `mb-4` */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Tailwind `shadow-xl` */
            border: 4px solid white; /* Tailwind `border-4 border-white` */
            outline: 2px solid #60a5fa; /* Tailwind `ring-2 ring-blue-400` */
        }
        .profile-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 1.5rem; /* Tailwind `text-2xl` */
            font-weight: 700; /* Tailwind `font-bold` */
            color: #1f2937; /* Tailwind `text-gray-800` */
            margin-bottom: 0.25rem; /* Tailwind `mb-1` */
        }
        .profile-email {
            color: #4b5563; /* Tailwind `text-gray-600` */
            font-size: 0.875rem; /* Tailwind `text-sm` */
            margin-bottom: 0.25rem; /* Tailwind `mb-1` */
        }
        .email-verified-badge {
            margin-left: 0.5rem; /* Tailwind `ml-2` */
            display: inline-flex;
            align-items: center;
            padding-left: 0.625rem; /* Tailwind `px-2.5` */
            padding-right: 0.625rem;
            padding-top: 0.125rem; /* Tailwind `py-0.5` */
            padding-bottom: 0.125rem;
            border-radius: 9999px; /* Tailwind `rounded-full` */
            font-size: 0.75rem; /* Tailwind `text-xs` */
            font-weight: 500; /* Tailwind `font-medium` */
            background-color: #d1fae5; /* Tailwind `bg-green-100` */
            color: #065f46; /* Tailwind `text-green-800` */
        }
        .email-verified-badge svg {
            margin-left: -0.125rem; /* Tailwind `-ml-0.5` */
            margin-right: 0.375rem; /* Tailwind `mr-1.5` */
            height: 0.5rem; /* Tailwind `h-2` */
            width: 0.5rem; /* Tailwind `w-2` */
            color: #34d399; /* Tailwind `text-green-400` */
        }
        .profile-location {
            color: #6b7280; /* Tailwind `text-gray-500` */
            font-size: 0.875rem; /* Tailwind `text-sm` */
        }
        .user-id-container {
            color: #9ca3af; /* Tailwind `text-gray-400` */
            font-size: 0.75rem; /* Tailwind `text-xs` */
            margin-top: 0.5rem; /* Tailwind `mt-2` */
            cursor: pointer;
        }

        /* Profile Info Rows */
        .info-row {
            display: flex;
            align-items: center;
            padding: 0.75rem; /* Tailwind `p-3` */
            border-radius: 0.5rem; /* Tailwind `rounded-lg` */
            transition-property: background-color; /* Tailwind `transition-colors` */
            transition-duration: 200ms; /* Tailwind `duration-200` */
        }
        .info-row:hover {
            background-color: #f3f4f6; /* Tailwind `hover:bg-gray-100` */
        }
        .info-row.highlighted { /* For Email row */
            background-color: #eff6ff; /* Tailwind `bg-gray-100` */
        }
        .info-row.highlighted:hover {
            background-color: #e5e7eb; /* Tailwind `hover:bg-gray-200` */
        }

        .info-label {
            width: 50%; /* Tailwind `w-1/2` */
            color: #374151; /* Tailwind `text-gray-700` */
            font-weight: 500; /* Tailwind `font-medium` */
        }
        .info-separator {
            color: #374151; /* Tailwind `text-gray-700` */
            margin: 0 0.5rem; /* Tailwind `mx-2` */
        }
        .info-value {
            width: 50%; /* Tailwind `w-1/2` */
            color: #1f2937; /* Tailwind `text-gray-900` */
            font-weight: 600; /* Tailwind `font-semibold` */
        }
        .info-value.editable {
            flex-grow: 1;
            cursor: pointer;
            text-decoration-line: underline; /* Tailwind `hover:underline` */
            text-decoration-color: transparent; /* Initially transparent */
            transition: text-decoration-color 0.2s ease;
        }
        .info-value.editable:hover {
             text-decoration-color: currentColor; /* Underline on hover */
        }
        .info-value.status-active {
            color: #16a34a; /* Tailwind `text-green-600` */
        }
        .info-value.status-inactive {
            color: #dc2626; /* Tailwind `text-red-600` */
        }
        .info-value.email-pending {
            color: #f97316; /* Tailwind `text-orange-500` */
        }
        .info-value.email-verified {
            color: #16a34a; /* Tailwind `text-green-600` */
        }

        /* Sign Out Button animation and glow */
        #signOutProfileButton { /* Renamed for clarity within profile modal */
            opacity: 0;
            transform: translateY(10px); /* Starts 10px down for a more subtle 'up' animation */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out; /* Add box-shadow and border-color to transition */
            pointer-events: none; /* Prevents interaction when hidden */
            box-shadow: 0 0 0 rgba(0,0,0,0); /* Initial no shadow */
        }
        #signOutProfileButton.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto; /* Allows interaction when visible */
        }
        /* New hover/focus styles for glow */
        #signOutProfileButton:hover, #signOutProfileButton:focus {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); /* Red glow effect */
            border-color: rgba(239, 68, 68, 0.7); /* Slightly stronger border on hover/focus */
        }

        /* Profile Info Container animation */
        #profile-info-container-left { /* Renamed for clarity */
            position: relative; /* Needed for transform */
            transition: transform 0.3s ease-out; /* Smooth transition for shifting up */
        }
        #profile-info-container-left.shift-up {
            transform: translateY(-10px); /* Shift up by 10px when sign out button is shown */
        }

        /* Name Edit Modal (within Profile Modal's JS) */
        #name-edit-modal-overlay { /* Using same overlay class but specific ID for clarity */
            z-index: 1010; /* Above profile modal, below customAlertModal */
        }
        #name-edit-modal-content {
            padding: 30px;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
        }
        #modal-edit-name-input {
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #d1d5db;
            color: #1f2937;
            transition: border-color 0.2s ease;
        }
        #modal-edit-name-input:focus {
            border-color: #3b82f6; /* blue-500 */
        }
        #modal-save-name-btn {
            background-image: linear-gradient(to right, #3b82f6, #2563eb); /* blue-500 to blue-600 */
            transition: all 0.2s ease;
        }
        #modal-save-name-btn:hover {
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        /* Chatbot specific styles */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Typing Indicator Animation - 3 Dots */
        .typing-dots {
            display: flex;
            align-items: center;
            height: 10px;
        }
        .typing-dots .dot {
            width: 7px;
            height: 7px;
            background-color: #9CA3AF;
            border-radius: 50%;
            margin: 0 2px;
            opacity: 0;
            animation: pulse-dot 1.4s infinite ease-in-out;
        }
        .typing-dots .dot:nth-child(1) { animation-delay: 0s; }
        .typing-dots .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse-dot {
            0%, 80%, 100% { opacity: 0; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }

        /* Header Status Smooth Transition */
        #status-display-area,
        #header-typing-indicator {
            position: absolute;
            width: auto;
            white-space: nowrap;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
        }
        #status-display-area.hide,
        #header-typing-indicator.hide {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #status-display-area.show,
        #header-typing-indicator.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* Adjust parent for absolute positioning */
        #online-status-container {
            position: relative;
            height: 1.5rem;
            width: 100%;
            overflow: hidden;
            display: block;
        }

        /* Ensure the chat widget itself can be resized */
        #chat-widget {
            resize: both; /* Allow resizing horizontally and vertically */
            overflow: auto;
            min-width: 300px;
            min-height: 400px;
            max-width: 90vw; /* Adjust max width for responsiveness */
            max-height: 90vh; /* Adjust max height for responsiveness */
            margin: auto; /* Center the chat widget within the modal */
        }

        /* Styles for attached files in messages */
        .attached-file {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out; /* For hover/tap effect */
        }
        .attached-file-icon {
            margin-right: 0.5rem;
            font-size: 1.25rem;
        }
        .attached-file-link {
            flex-grow: 1;
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .attached-file-link:hover {
            text-decoration: underline;
        }
        .attached-image-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: block;
            object-fit: contain;
        }
        .attached-image-container {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out; /* For hover/tap effect */
        }

        /* Attachment Preview Hover/Tap Effect */
        .attached-file:hover, .attached-file:active,
        .attached-image-container:hover, .attached-image-container:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            cursor: pointer;
        }


        .math-inline {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            padding: 0 2px;
            border-radius: 3px;
            background-color: rgba(0,0,0,0.05);
        }
        .math-block {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(0,0,0,0.05);
            border-left: 3px solid #ccc;
            font-family: 'Times New Roman', serif;
            white-space: pre-wrap;
        }

        /* Refresh Button Rotate Animation */
        @keyframes rotate-360 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .rotate-on-tap {
            animation: rotate-360 0.5s ease-out forwards;
        }
        .message-timestamp {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            margin-top: 0.25rem;
        }
        .message-timestamp.ai {
            color: rgba(0, 0, 0, 0.5);
            text-align: left;
        }

        /* Spinner CSS */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Spinner for attachment upload */
        .attachment-spinner {
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top: 2px solid #3B82F6; /* blue-500 */
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        /* Message Entry/Exit Animations */
        @keyframes fade-in-slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter-animation {
            animation: fade-in-slide-up 0.3s ease-out forwards;
        }

        @keyframes fade-out-slide-down {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        .message-exit-animation {
            animation: fade-out-slide-down 0.3s ease-in forwards;
        }

        /* Message Bubble Subtle Pop on Creation */
        @keyframes message-pop-in {
            0% { transform: scale(0.98); opacity: 0; }
            50% { transform: scale(1.01); opacity: 1; }
            100% { transform: scale(1); }
        }
        .message-bubble-pop {
            animation: message-pop-in 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* Elastic effect */
        }


        /* Send Button Press Effect */
        @keyframes press-effect {
            0% { transform: scale(1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
            50% { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
            100% { transform: scale(1); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        }
        .send-button-pressed {
            animation: press-effect 0.2s ease-out forwards;
        }

        /* Attachment Button Pulse Highlight */
        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.7); } /* blue-500 */
            70% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0); }
        }
        .attachment-button-pulse {
            animation: pulse-highlight 0.5s ease-out forwards;
        }

        /* Input Field Focus Transition (already handled well by Tailwind, adding a touch more) */
        #message-input {
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #message-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* blue-500 with opacity */
        }

        /* Input Field Placeholder Pulse */
        @keyframes placeholder-fade {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }
        #message-input::placeholder {
            animation: placeholder-fade 2s ease-in-out infinite;
        }

        /* Chat Widget Entry/Exit Animation */
        @keyframes chat-widget-fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes chat-widget-fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        .chat-widget-enter {
            animation: chat-widget-fade-in 0.5s ease-out forwards;
        }
        .chat-widget-exit {
            animation: chat-widget-fade-out 0.5s ease-in forwards;
        }

        /* New Chat Started Indicator (Temporary message) */
        @keyframes new-chat-indicator-fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .new-chat-indicator {
            animation: new-chat-indicator-fade-in 0.4s ease-out forwards;
        }

        /* AI Message Actions Container */
        #ai-message-actions {
            position: absolute;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            z-index: 20; /* Ensure it's above messages */
        }
        #ai-message-actions.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #ai-message-actions button {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: #E5E7EB; /* gray-200 */
            color: #4B5563; /* gray-700 */
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            display: flex; /* For icon+text if needed */
            align-items: center;
            gap: 0.25rem;
        }
        #ai-message-actions button:hover {
            background-color: #DBEAFE; /* blue-100 */
            color: #2563EB; /* blue-600 */
        }
        #ai-message-actions button.active-feedback {
            background-color: #BFDBFE; /* blue-200 */
            color: #2563EB; /* blue-600 */
        }
         #ai-message-actions button.active-feedback.dislike {
            background-color: #FECACA; /* red-200 */
            color: #DC2626; /* red-600 */
        }
    </style>
</head>
<body>
    <!-- Login Modal Structure (hidden by default) -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content login-content">
            <p class="text-gray-500 text-base mb-1 font-medium" id="loginHeaderSubtitle">Please enter your details</p>
            <h2 class="text-4xl font-extrabold text-gray-900 mb-8" id="loginHeaderTitle">Welcome back</h2>

            <div class="mb-5">
                <input type="email" id="emailInputLogin" placeholder="Email address" class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out">
                <p id="emailErrorLogin" class="error-message hidden"></p>
            </div>
            <div class="mb-5">
                <input type="password" id="passwordInputLogin" placeholder="Password" class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out">
                <p id="passwordErrorLogin" class="error-message hidden"></p>
            </div>

            <div class="flex items-center justify-between mb-8">
                <label class="flex items-center text-sm text-gray-700 cursor-pointer">
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500">
                    <span class="ml-2">Remember for 30 days</span>
                </label>
                <a href="#" class="text-sm text-indigo-600 hover:underline font-medium" id="forgotPasswordLink">Forgot password?</a>
            </div>

            <button id="authActionButton" class="w-full text-white py-3 rounded-xl font-semibold btn-primary-modern mb-4">
                Sign In
            </button>

            <div class="relative flex items-center justify-center text-sm font-medium text-gray-600 my-6">
                <span class="absolute left-0 w-full border-t border-gray-300"></span>
                <span class="relative z-10 bg-white px-3">OR</span>
            </div>

            <button id="googleSignInButton" class="w-full flex items-center justify-center border border-gray-300 py-3 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition duration-200 ease-in-out shadow-sm">
                <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-5 h-5 mr-3">
                Sign in with Google
            </button>

            <p class="text-center text-sm text-gray-700 mt-8">
                Don't have an account?
                <a href="#" class="text-indigo-600 hover:underline font-semibold" id="toggleAuthMode">Sign up</a>
            </p>
            <div id="authLoadingIndicator" class="hidden text-center mt-4 text-blue-500">
                <div class="spinner mx-auto"></div>
                Authenticating...
            </div>
            <p id="authErrorMessage" class="error-message text-center mt-4 hidden"></p>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        Loading Reminders...
    </div>

    <div class="container" id="mainAppContainer">
        <h1>Multi-Subject Study Reminder</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 text-center mb-4"></p>

        <!-- Settings Button and Dropdown Menu -->
        <div class="settings-dropdown-container">
            <button id="settingsDropdownButton" class="settings-dropdown-button">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M0 0h24v24H0V0z" fill="none"/>
                    <path d="M19.43 12.98c.04-.32.07-.64.07-.98 0-.34-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.09-.76-1.71-1.05l-.34-2.51c-.05-.24-.24-.41-.48-.41h-4c-.24 0-.43.17-.48.41l-.34 2.51c-.62.29-1.19.65-1.71 1.05l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.12.22-.07.49-.12.64l2.11 1.65c-.04.32-.07.64-.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.09.76 1.71 1.05l.34 2.51c.05.24.24.41.48.41h4c.24 0 .43-.17.48-.41l-.34 2.51c.62-.29 1.19-.65 1.71-1.05l2.49 1c.22.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12.64l-2.11-1.65zm-1.93-1.78c.05.18.08.36.08.54s-.03.36-.08.54l-.24 1.78 1.45 1.13-.88 1.52-1.77-.71-.47.24c-.25.13-.48.29-.7.46l-1.09.84-.71 1.77-1.52.88-1.13-1.45-.24.47c-.25-.13-.48-.29-.46-.7l-.84-1.09-1.77.71-1.52.88-1.13 1.45.88 1.52 1.77-.71-.47-.24c-.25-.13-.48-.29-.7-.46l-1.09-.84zM12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
            </button>
            <div id="settingsMenu" class="settings-menu">
                <ul>
                    <li>
                        <button id="backupDataButton">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.83 2.81-7.14 6.41C1.67 10.87 0 13.82 0 17c0 3.87 3.13 7 7 7h12c3.87 0 7-3.13 7-7 0-3.87-3.13-7-7-7zM12 22c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm-1-10V9c0-.55-.45-1-1-1s-1 .45-1 1v3H8.5c-.38 0-.62.4-.45.75l2.5 4c.2.32.65.32.85 0l2.5-4c.18-.35-.06-.75-.45-.75H13z"/>
                            </svg>
                            Backup (CSV)
                        </button>
                    </li>
                    <li>
                        <button id="exportDataButton">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Export (CSV)
                        </button>
                    </li>
                    <li>
                        <button id="importDataButton">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M19 12h-2V7h-4V3H9v4H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Import (CSV)
                        </button>
                    </li>
                    <li>
                        <button id="openChangeSubjectsModalButton">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M3 17.25V21h3.75L18.75 9.75l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            Change Subjects
                        </button>
                    </li>
                    <li>
                        <button id="migrateLocalStorageButton">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Migrate Local Data
                        </button>
                    </li>
                    <li>
                        <button id="myProfileButton"> <!-- Replaced Logout with My Profile -->
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            My Profile
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- New section for the Add New Reminder button -->
        <div class="add-new-reminder-section">
            <button id="openAddReminderModalButton" class="add-new-reminder-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF">
                    <path d="M0 0h24v24H0V0z" fill="none"/>
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Add New Reminder
            </button>
            <!-- New SVG icon button -->
            <button id="svgActionButton" class="svg-action-button">
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 48 48">
                    <defs>
                        <linearGradient id="Gg7MCsovHB8vJnbPNxva7a_JFJ1boRErP2w_gr1" x1="32.63" x2="8.63" y1="8.98" y2="30.77" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#6560fe"></stop>
                            <stop offset=".03" stop-color="#6e69fe"></stop>
                            <stop offset=".2" stop-color="#9a97fe"></stop>
                            <stop offset=".36" stop-color="#bebcfe"></stop>
                            <stop offset=".53" stop-color="#dad9fe"></stop>
                            <stop offset=".69" stop-color="#eeeefe"></stop>
                            <stop offset=".85" stop-color="#fafafe"></stop>
                            <stop offset="1" stop-color="#fff"></stop>
                        </linearGradient>
                        <linearGradient id="Gg7MCsovHB8vJnbPNxva7b_JFJ1boRErP2w_gr2" x1="41.78" x2="30.83" y1="30.35" y2="41.6" xlink:href="#Gg7MCsovHB8vJnbPNxva7a"></linearGradient>
                    </defs>
                    <path fill="url(#Gg7MCsovHB8vJnbPNxva7a_JFJ1boRErP2w_gr1)" d="M23.47,30.13l-1.47,3.36c-.56,1.29-2.35,1.29-2.92,0l-1.47-3.36c-1.31-2.99-3.66-5.37-6.59-6.67l-4.04-1.79c-1.28-.57-1.28-2.44,0-3.01l3.91-1.74c3.01-1.33,5.4-3.8,6.68-6.9l1.49-3.58c.55-1.33,2.39-1.33,2.94,0l1.49,3.58c1.28,3.09,3.68,5.56,6.68,6.9l3.91,1.74c1.28.57,1.28,2.44,0,3.01l-4.04,1.79c-2.93,1.3-5.28,3.68-6.59,6.67Z"></path>
                    <path fill="url(#Gg7MCsovHB8vJnbPNxva7b_JFJ1boRErP2w_gr2)" d="M37.24,41.32l-.41.94c-.3.69-1.25.69-1.55,0l-.41-.94c-.73-1.67-2.04-3-3.68-3.73l-1.26-.56c-.68-.3-.68-1.29,0-1.6l1.19-.53c1.68-.75,3.02-2.13,3.73-3.85l.42-1.01c.29-.71,1.27-.71,1.56,0l.42,1.01c.72,1.73,2.05,3.11,3.73,3.85l1.19.53c.68.3.68,1.29,0,1.6l-1.26.56c-1.64.73-2.95,2.06-3.68,3.73Z"></path>
                    <path fill="none" stroke="#8251fe" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M26.5,26.17c-1.23,1.2-2.23,2.65-2.94,4.26l-1.51,3.46c-.58,1.33-2.42,1.33-3,0l-1.51-3.46c-1.35-3.08-3.77-5.54-6.79-6.88l-4.16-1.85c-1.32-.59-1.32-2.51,0-3.1l4.03-1.79c1.41-.63,2.69-1.5,3.79-2.56"></path>
                    <path fill="none" stroke="#8251fe" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17.5,9.72l1.53-3.69c.57-1.37,2.46-1.37,3.03,0l1.53,3.69c1.32,3.19,3.79,5.73,6.89,7.11l4.03,1.79c1.32.59,1.32,2.51,0,3.1l-4.16,1.85"></path>
                    <path fill="none" stroke="#8251fe" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M31.39,37.53l-1.21-.54c-.65-.29-.65-1.24,0-1.53l1.14-.51c1.61-.72,2.89-2.04,3.58-3.7l.4-.97c.28-.68,1.22-.68,1.5,0l.4.97c.69,1.66,1.97,2.98,3.58,3.7l1.14.51c.65.29.65,1.24,0,1.53l-1.21.54c-1.57.7-2.83,1.97-3.53,3.58l-.39.9c-.29.66-1.2.66-1.48,0l-.39-.9"></path>
                </svg>
            </button>
        </div>
        
        <!-- New container for filter and action buttons -->
        <div class="filter-and-action-controls">
            <!-- Subject filter for viewing reminders -->
            <div class="subject-filter">
                <label for="filterSubject">View Reminders For:</label>
                <select id="filterSubject">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- New section for action buttons (Incomplete, Progress) -->
            <div class="action-buttons-section">
                <button id="incompleteTopicsButton" class="action-button">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px">
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                </button>
                <button id="myProgressButton" class="action-button">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px">
                        <path d="M0 0h24v24H0V0z" fill="none"/><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Section for reminders due today (initially visible, hidden by incomplete filter) -->
        <section id="todayRemindersSection">
            <h2>Today's Reminders</h2>
            <ul id="todayReminders" class="reminder-list">
                <li class="empty-message">No topics due today! Keep up the good work.</li>
            </ul>
        </section>

        <!-- Section for upcoming reminders (initially visible, hidden by incomplete filter) -->
        <section id="upcomingRemindersSection">
            <h2>Upcoming Reminders</h2>
            <ul id="upcomingReminders" class="reminder-list">
                <li class="empty-message">No upcoming reminders for now.</li>
            </ul>
        </section>

        <!-- New section for Incomplete & Overdue Topics (initially hidden) -->
        <section id="incompleteTopicsSection" style="display: none;">
            <h2>Incomplete & Overdue Topics</h2>
            <ul id="incompleteRemindersList" class="reminder-list">
                <li class="empty-message">Great job! All caught up on your incomplete topics.</li>
            </ul>
        </section>
    </div>

    <!-- Error message box (initially hidden) -->
    <div id="errorMessage" class="error-message-box"></div>

    <!-- ADD REMINDER MODAL STRUCTURE -->
    <div id="addReminderModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Study Reminder</h3>
                <span class="close-button" id="closeAddReminderModalButton">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Original Add Topic Form moved here -->
                <form id="addTopicForm" class="add-topic-form">
                    <div class="form-group">
                        <label for="topicName">Topic Name:</label>
                        <input type="text" id="topicName" placeholder="e.g., Cell Structure" required>
                    </div>
                    <div class="form-group">
                        <label for="subjectSelect">Subject:</label>
                        <select id="subjectSelect" required>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <button type="submit" class="save-button">Add Reminder</button>
                </form>
            </div>
        </div>
    </div>


    <!-- EDIT REMINDER SETTINGS MODAL STRUCTURE -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Reminder Settings</h3>
                <span class="close-button" id="closeModalButton">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalReminderId">
                <div class="form-group">
                    <label for="modalTopicName">Topic Name:</label>
                    <input type="text" id="modalTopicName">
                </div>
                <div class="form-group">
                    <label for="modalSubjectSelect">Subject:</label>
                    <select id="modalSubjectSelect">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalNextReviewDate">Manually Set Next Review Date:</label>
                    <input type="date" id="modalNextReviewDate">
                </div>
                <div class="form-group">
                    <label for="modalCustomIntervals">Custom Intervals (comma-separated, e.g., 2,5,10,15):</label>
                    <textarea id="modalCustomIntervals" rows="3" placeholder="Leave empty for default spaced repetition."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="delete-button" id="deleteReminderButton">Delete Reminder</button>
                <button class="reset-pattern-button" id="resetPatternButton">Reset Spaced Repetition</button>
                <button class="cancel-button" id="cancelModalButton">Cancel</button>
                <button class="save-button" id="saveModalButton">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- CHANGE SUBJECTS MODAL STRUCTURE (NEW) -->
    <div id="changeSubjectsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Subject Display Names</h3>
                <span class="close-button" id="closeChangeSubjectsModalButton">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-card" style="margin-top: 0; padding: 15px;">
                    <h4>Reminders:</h4> 
                    <p class="text-sm text-gray-600 mb-4">Customize the names of your core subjects. These changes will be reflected throughout the app.</p>
                    <div class="form-group">
                        <label for="changeDisplayNameBiology">Slot1 Name:</label>
                        <input type="text" id="changeDisplayNameBiology" placeholder="Biology">
                    </div>
                    <div class="form-group">
                        <label for="changeDisplayNamePhysics">Slot2 Name:</label>
                        <input type="text" id="changeDisplayNamePhysics" placeholder="Physics">
                    </div>
                    <div class="form-group">
                        <label for="changeDisplayNameChemistry">Slot3 Name:</label>
                        <input type="text" id="changeDisplayNameChemistry" placeholder="Chemistry">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-button" id="cancelChangeSubjectsButton">Cancel</button>
                <button class="save-button" id="saveChangeSubjectsButton">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- MY PROGRESS MODAL STRUCTURE -->
    <div id="myProgressModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>My Study Progress</h3>
                <span class="close-button" id="closeMyProgressModalButton">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Container for progress circles. Flex properties handled in CSS now. -->
                <div class="progress-circles-container">
                    <!-- Biology Progress Bar -->
                    <div class="flex flex-col items-center">
                        <div class="progress-circle progress-biology">
                            <div class="progress-content">
                                <span class="progress-percentage" id="biologyPercentage">0%</span>
                                <span class="label">Biology</span>
                            </div>
                        </div>
                    </div>

                    <!-- Physics Progress Bar -->
                    <div class="flex flex-col items-center">
                        <div class="progress-circle progress-physics">
                            <div class="progress-content">
                                <span class="progress-percentage" id="physicsPercentage">0%</span>
                                <span class="label">Physics</span>
                            </div>
                        </div>
                    </div>

                    <!-- Chemistry Progress Bar -->
                    <div class="flex flex-col items-center">
                        <div class="progress-circle progress-chemistry">
                            <div class="progress-content">
                                <span class="progress-percentage" id="chemistryPercentage">0%</span>
                                <span class="label">Chemistry</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-button" id="closeProgressModalFooterButton">Close</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM ALERT/CONFIRMATION MODAL -->
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customAlertTitle">Notification</h3>
                <span class="close-button" id="closeCustomAlertButton">&times;</span>
            </div>
            <div class="modal-body">
                <p id="customAlertMessage"></p>
            </div>
            <div class="modal-footer" id="customAlertFooter">
                <button class="save-button" id="customAlertOkButton">OK</button>
                <button class="cancel-button" id="customAlertCancelButton" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MY PROFILE MODAL STRUCTURE -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" id="closeProfileModalButton">&times;</button>
            <!-- Left Section: Profile Picture and Basic Info -->
            <div id="profile-info-container-left" class="profile-left-section">
                <!-- Profile Image -->
                <div class="profile-image">
                    <img id="profile-image" src="https://placehold.co/128x128/D1D5DB/4B5563?text=User" alt="Profile Picture">
                </div>
                <!-- Name -->
                <h2 id="display-name" class="profile-name">Loading...</h2>
                <!-- Email -->
                <p id="display-email" class="profile-email">Loading...
                    <!-- Verified Badge for Email (optional) -->
                    <span id="email-verified-badge" class="email-verified-badge hidden">
                        <!-- Checkmark SVG icon -->
                        <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Verified
                    </span>
                </p>
                <!-- Location -->
                <p id="display-location" class="profile-location">United States</p>
                <!-- User ID Display (for multi-user app context) -->
                <p class="user-id-container" id="user-id-container">User ID: <span id="display-user-id">Not Available</span></p>
                <!-- Sign Out Button -->
                <button id="signOutProfileButton" class="mt-4 px-4 py-2 bg-transparent text-red-500 border border-red-500 font-semibold rounded-lg focus:outline-none focus:ring-2 focus:ring-red-300 focus:ring-offset-2 transition duration-200 ease-in-out text-sm">Sign Out</button>
            </div>

            <!-- Right Section: Detailed Information -->
            <div class="profile-right-section">
                <div class="space-y-4">
                    <!-- Name Row (Editable on Tap) -->
                    <div class="info-row">
                        <div class="info-label">Name</div>
                        <div class="info-separator">:</div>
                        <div class="info-value flex items-center">
                            <span id="display-name-editable" class="info-value editable">Loading...</span>
                        </div>
                    </div>

                    <!-- Role Row -->
                    <div class="info-row">
                        <div class="info-label">Role</div>
                        <div class="info-separator">:</div>
                        <div id="display-role" class="info-value">User</div>
                    </div>

                    <!-- Email Row -->
                    <div class="info-row highlighted">
                        <div class="info-label">Email</div>
                        <div class="info-separator">:</div>
                        <div id="display-email-detailed" class="info-value">Loading...</div>
                    </div>

                    <!-- Email Verification Row -->
                    <div class="info-row">
                        <div class="info-label">Email Verification</div>
                        <div class="info-separator">:</div>
                        <div id="display-email-verification" class="info-value email-pending">Loading...</div>
                    </div>

                    <!-- Status Row -->
                    <div class="info-row">
                        <div class="info-label">Status</div>
                        <div class="info-separator">:</div>
                        <div id="display-status" class="info-value status-active">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Name Edit Modal -->
    <div id="name-edit-modal-overlay" class="modal-overlay">
        <div id="name-edit-modal-content" class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Name</h3>
            <!-- Modernized Edit Name Input -->
            <input type="text" id="modal-edit-name-input" class="w-full p-3 mb-4 bg-transparent border-b-2 border-gray-300 text-gray-900 placeholder-gray-400 focus:outline-none focus:border-blue-500 focus:ring-0 transition-colors duration-200" placeholder="Enter new name">
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-5 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">Cancel</button>
                <button id="modal-save-name-btn" class="px-5 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Save</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal Structure -->
    <div id="chatModal" class="modal-overlay" style="z-index: 1050;">
        <div id="chat-widget" class="relative bg-white rounded-3xl shadow-xl flex flex-col w-full min-w-[300px] h-[80vh]">
            <!-- Header -->
            <div class="bg-white text-gray-800 p-4 flex items-center justify-between rounded-t-3xl shadow-md border-b border-gray-100">
                <div class="flex items-center">
                    <img
                        src="https://iili.io/FTEtNXp.md.png"
                        alt="Chatbot Icon"
                        class="w-10 h-10 object-contain"
                    />
                    <div class="ml-3 relative" id="online-status-container-wrapper" style="flex-grow: 1;">
                        <h3 class="text-lg font-normal text-gray-800">Study Reminder</h3>
                        <p class="text-sm flex items-center" id="online-status-container">
                            <span id="status-display-area" class="flex items-center text-gray-600 show">
                                <span id="status-dot" class="relative flex h-2 w-2 mr-1">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                </span>
                                <span id="status-text">We're online</span>
                            </span>
                            <span id="header-typing-indicator" class="hide flex items-center text-gray-600">
                                <span class="text-sm mr-1">Typing...</span>
                            </span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button
                        id="chat-refresh-button"
                        class="p-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600 hover:text-gray-800"
                        aria-label="Chat Refresh"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M 3.5 2 C 3.372 2 3.2444844 2.0494844 3.1464844 2.1464844 C 2.9514844 2.3414844 2.9514844 2.6585156 3.1464844 2.8535156 L 5.09375 4.8007812 C 3.1950225 6.6199194 2 9.1685121 2 12 C 2 17.511334 6.4886661 22 12 22 C 17.511334 22 22 17.511334 22 12 C 22 6.864114 18.106486 2.6175896 13.109375 2.0644531 A 1.0001 1.0001 0 0 0 13.009766 2.0585938 A 1.0001 1.0001 0 0 0 12.890625 4.0527344 C 16.891514 4.4955979 20 7.871886 20 12 C 20 16.430666 16.430666 20 12 20 C 7.5693339 20 4 16.430666 4 12 C 4 9.7105359 4.967513 7.6643975 6.5039062 6.2109375 L 8.1464844 7.8535156 C 8.3414844 8.0485156 8.6585156 8.0485156 8.8535156 7.8535156 C 8.9515156 7.7565156 9 7.628 9 7.5 L 9 3 A 1 1 0 0 0 8 2 L 3.5 2 z"></path>
                        </svg>
                    </button>
                    <button
                        id="chat-close-button"
                        class="p-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600 hover:text-gray-800"
                        aria-label="Close Widget"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Chat History -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-4 bg-gray-50 hide-scrollbar relative max-h-[calc(100%-12rem)]">
                <!-- Messages will be appended here by JavaScript -->
            </div>

            <!-- Typing Indicator (for main chat area) -->
            <div id="main-typing-indicator" class="hidden flex justify-start ml-4 mb-2">
                <div class="max-w-[70%] px-4 py-2 rounded-xl shadow bg-gray-200 text-gray-800 rounded-bl-none flex items-center space-x-2">
                    <div class="typing-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            </div>

            <!-- Pending Attachments Display -->
            <div id="pending-attachments-display" class="hidden p-2 bg-blue-100 text-blue-800 text-sm rounded-lg mx-4 mb-2 flex items-center justify-between">
                <span id="pending-attachments-text" class="flex items-center">
                    <span id="attached-files-icon">📎</span>
                    <span id="attached-files-count">0</span>
                    <span id="attached-files-label">files ready to send</span>
                    <div id="attachment-spinner" class="attachment-spinner hidden"></div>
                </span>
                <button id="clear-attachments-button" class="text-blue-600 hover:text-blue-900 ml-2" aria-label="Clear attachments">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Message Input -->
            <form id="chat-form" class="p-4 bg-white border-t border-gray-100 flex items-center space-x-2">
                <button
                    type="button"
                    id="attachment-button"
                    class="p-2 mr-2 text-gray-400 hover:text-blue-500 transition-colors rounded-full"
                    aria-label="Attachments"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13.5"></path></svg>
                </button>
                <input
                    type="text"
                    id="message-input"
                    placeholder="Enter message..."
                    class="flex-1 p-3 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-gray-800 shadow-sm"
                    autocomplete="off"
                />
                <button
                    type="submit"
                    id="send-button"
                    class="relative p-3 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    disabled
                    aria-label="Send Message"
                >
                    <span id="send-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" id="Outline" viewBox="0 0 24 24" width="24" height="24">
                            <path fill="currentColor" d="M23.119.882a2.966,2.966,0,0,0-2.8-.8l-16,3.37a4.995,4.995,0,0,0-2.853,8.481L3.184,13.65a1,1,0,0,1,.293.708v3.168a2.965,2.965,0,0,0,.3,1.285l-.008.007.026.026A3,3,0,0,0,5.157,20.2l.026.026.007-.008a2.965,2.965,0,0,0,1.285.3H9.643a1,1,0,0,1,.707.292l1.717,1.717A4.963,4.963,0,0,0,15.587,24a5.049,5.049,0,0,0,1.605-.264,4.933,4.933,0,0,0,3.344-3.986L23.911,3.715A2.975,2.975,0,0,0,23.119.882ZM4.6,12.238,2.881,10.521a2.94,2.94,0,0,1-.722-3.074,2.978,2.978,0,0,1,2.5-2.026L20.5,2.086,5.475,17.113V14.358A2.978,2.978,0,0,0,4.6,12.238Zm13.971,7.17a3,3,0,0,1-5.089,1.712L11.762,19.4a2.978,2.978,0,0,0-2.119-.878H6.888L21.915,3.5Z"/>
                        </svg>
                    </span>
                    <div id="send-spinner" class="spinner absolute hidden"></div>
                </button>
            </form>

            <!-- Hidden file input for attachments -->
            <input type="file" id="file-input" class="hidden" multiple accept="image/*,video/*,.pdf,.doc,.docx,.txt">

            <!-- AI Message Actions Container -->
            <div id="ai-message-actions" class="hidden">
                <button id="copy-button" aria-label="Copy message">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-4 5h-2a2 2 0 00-2 2v2m0 0h2a2 2 0 002-2v-2m0 0h2a2 2 0 012 2v2"></path></svg>
                    Copy
                </button>
                <button id="regenerate-button" aria-label="Regenerate response">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0020 13a8 8 0 01-15.356 2m0 0v5h.581m15.356-5a8.001 8.001 0 00-15.356-2"></path></svg>
                    Regenerate
                </button>
                <button id="like-button" aria-label="Like message">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3v-2a7 7 0 0114-6h.063c.091.794.673 1.45 1.406 1.768"></path></svg>
                    Like
                </button>
                <button id="dislike-button" aria-label="Dislike message">
                    <svg class="w-4 h-4 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21H3v-2a7 7 0 0114-6h.063c.091.794.673 1.45 1.406 1.768"></path></svg>
                    Dislike
                </button>
            </div>

            <!-- User ID Display -->
            <div id="chat-user-id-display" class="p-2 text-xs text-center text-gray-400 bg-white border-t border-gray-100">
                <!-- User ID will be displayed here -->
            </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword, /* Added for email/password sign-up */
            signInWithEmailAndPassword,     /* Added for email/password sign-in */
            GoogleAuthProvider,             /* Added for Google sign-in */
            signInWithPopup,                /* Added for Google sign-in */
            signOut                         /* Added for logout */
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, setDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Your web app's Firebase configuration (provided by user)
        const userFirebaseConfig = {
            apiKey: "AIzaSyApLfVQ6hv0IAAN5ZkFlOQ-y5KXK-x1Q_M", // Updated API Key
            authDomain: "reminderapp-d84e9.firebaseapp.com",
            projectId: "reminderapp-d84e9",
            storageBucket: "reminderapp-d84e9.firebaseapp.com",
            messagingSenderId: "312145339940",
            appId: "1:312145339940:web:ade59de4d6de6cec221ab1"
        };

        // Global variables provided by the Canvas environment (MUST BE USED)
        // If running outside Canvas, these will be undefined, so provide fallbacks.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-reminder-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // Global API key from Canvas environment.
        const canvasApiKey = typeof __api_key !== 'undefined' ? __api_key : '';

        let app;
        let db;
        let auth;
        let storage; // Declare storage here
        let userId = null;
        let isFirebaseReady = false; // Flag to indicate Firebase is initialized and user is authenticated

        // Get references to HTML elements
        // Main App Container
        const mainAppContainer = document.getElementById('mainAppContainer'); // The entire main app content

        // Add Reminder Modal elements
        const openAddReminderModalButton = document.getElementById('openAddReminderModalButton');
        const addReminderModal = document.getElementById('addReminderModal');
        const closeAddReminderModalButton = document.getElementById('closeAddReminderModalButton');
        const svgActionButton = document.getElementById('svgActionButton'); // NEW: Reference to the new SVG button

        // Original form elements, now inside the Add Reminder Modal
        const addTopicForm = document.getElementById('addTopicForm'); // This is the form INSIDE the new modal
        const topicNameInput = document.getElementById('topicName');
        const addSubjectSelect = document.getElementById('subjectSelect');
        const startDateInput = document.getElementById('startDate');


        const filterSubjectSelect = document.getElementById('filterSubject'); // Subject select for filtering

        // Main Reminder Sections
        const todayRemindersSection = document.getElementById('todayRemindersSection');
        const todayRemindersList = document.getElementById('todayReminders');
        const upcomingRemindersSection = document.getElementById('upcomingRemindersSection');
        const upcomingRemindersList = document.getElementById('upcomingReminders');
        // Dedicated Incomplete Section
        const incompleteTopicsSection = document.getElementById('incompleteTopicsSection');
        const incompleteRemindersList = document.getElementById('incompleteRemindersList');


        // New Action Buttons
        const incompleteTopicsButton = document.getElementById('incompleteTopicsButton');
        const myProgressButton = document.getElementById('myProgressButton');


        // Edit Reminder Settings Modal elements
        const settingsModal = document.getElementById('settingsModal');
        const closeModalButton = document.getElementById('closeModalButton'); // Close button for settings modal
        const cancelModalButton = document.getElementById('cancelModalButton'); // Cancel button for settings modal
        const saveModalButton = document.getElementById('saveModalButton'); // Save button for settings modal
        const deleteReminderButton = document.getElementById('deleteReminderButton');
        const resetPatternButton = document.getElementById('resetPatternButton');

        const modalReminderId = document.getElementById('modalReminderId');
        const modalTopicNameInput = document.getElementById('modalTopicName');
        const modalSubjectSelect = document.getElementById('modalSubjectSelect');
        const modalNextReviewDateInput = document.getElementById('modalNextReviewDate');
        const modalCustomIntervalsInput = document.getElementById('modalCustomIntervals');
        
        // NEW: Change Subjects Modal elements
        const changeSubjectsModal = document.getElementById('changeSubjectsModal');
        const closeChangeSubjectsModalButton = document.getElementById('closeChangeSubjectsModalButton');
        const cancelChangeSubjectsButton = document.getElementById('cancelChangeSubjectsButton');
        const saveChangeSubjectsButton = document.getElementById('saveChangeSubjectsButton');
        const changeDisplayNameBiologyInput = document.getElementById('changeDisplayNameBiology');
        const changeDisplayNamePhysicsInput = document.getElementById('changeDisplayNamePhysics');
        const changeDisplayNameChemistryInput = document.getElementById('changeDisplayNameChemistry');


        // My Progress Modal elements
        const myProgressModal = document.getElementById('myProgressModal');
        const closeMyProgressModalButton = document.getElementById('closeMyProgressModalButton');
        const closeProgressModalFooterButton = document.getElementById('closeProgressModalFooterButton');

        // Custom Alert Modal elements
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOkButton = document.getElementById('customAlertOkButton');
        const customAlertCancelButton = document.getElementById('customAlertCancelButton');
        const closeCustomAlertButton = document.getElementById('closeCustomAlertButton');

        // New Settings Dropdown elements
        const settingsDropdownButton = document.getElementById('settingsDropdownButton');
        const settingsMenu = document.getElementById('settingsMenu');
        const backupDataButton = document.getElementById('backupDataButton');
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataButton = document.getElementById('importDataButton');
        const openChangeSubjectsModalButton = document.getElementById('openChangeSubjectsModalButton'); // NEW
        const migrateLocalStorageButton = document.getElementById('migrateLocalStorageButton'); // NEW: For migrating local storage
        const myProfileButton = document.getElementById('myProfileButton'); // NEW: My Profile button

        const errorMessage = document.getElementById('errorMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const appUserIdDisplay = document.getElementById('userIdDisplay'); // To display userId for the main app

        // Login Modal elements
        const loginModal = document.getElementById('loginModal');
        const emailInputLogin = document.getElementById('emailInputLogin');
        const passwordInputLogin = document.getElementById('passwordInputLogin');
        const emailErrorLogin = document.getElementById('emailErrorLogin');
        const passwordErrorLogin = document.getElementById('passwordErrorLogin');
        const authActionButton = document.getElementById('authActionButton'); // Sign In / Sign Up button
        const googleSignInButton = document.getElementById('googleSignInButton');
        const toggleAuthModeLink = document.getElementById('toggleAuthMode');
        const loginHeaderTitle = document.getElementById('loginHeaderTitle');
        const loginHeaderSubtitle = document.getElementById('loginHeaderSubtitle');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const authLoadingIndicator = document.getElementById('authLoadingIndicator');
        const authErrorMessage = document.getElementById('authErrorMessage');

        let isSignInMode = true; // State for login modal: true for Sign In, false for Sign Up

        // Profile Modal elements
        const profileModal = document.getElementById('profileModal');
        const closeProfileModalButton = document.getElementById('closeProfileModalButton');
        const profileImage = document.getElementById('profile-image');
        const displayName = document.getElementById('display-name');
        const displayEmail = document.getElementById('display-email');
        const emailVerifiedBadge = document.getElementById('email-verified-badge');
        const displayLocation = document.getElementById('display-location');
        const displayUserId = document.getElementById('display-user-id');
        const signOutProfileButton = document.getElementById('signOutProfileButton'); // Logout button inside profile modal
        const displayNameEditable = document.getElementById('display-name-editable');
        const displayRole = document.getElementById('display-role');
        const displayEmailDetailed = document.getElementById('display-email-detailed');
        const displayEmailVerification = document.getElementById('display-email-verification');
        const displayStatus = document.getElementById('display-status');
        const userIdContainer = document.getElementById('user-id-container');
        const profileInfoContainerLeft = document.getElementById('profile-info-container-left'); // Left section container

        // Name Edit Modal elements (within profile modal)
        const nameEditModalOverlay = document.getElementById('name-edit-modal-overlay');
        const modalEditNameInput = document.getElementById('modal-edit-name-input');
        const modalSaveNameButton = document.getElementById('modal-save-name-btn');
        const modalCancelButton = document.getElementById('modal-cancel-btn');


        // Global variable to store all reminders across all subjects
        let allReminders = [];
        // Tracks the currently selected subject for display
        let currentFilterSubject = 'Biology'; // Default to Biology (canonical name)
        // New state for toggling incomplete topics view
        let showOnlyIncomplete = false;

        // Canonical subject names (used internally for data, fixed)
        const CANONICAL_SUBJECTS = ['Biology', 'Physics', 'Chemistry', 'Other'];
        // Subjects that have dedicated progress bars (canonical names)
        const SUBJECT_ORDER_FOR_CHART = ['Biology', 'Physics', 'Chemistry'];

        // Global object to store user's custom display names for canonical subjects
        let subjectDisplayNames = {
            'Biology': 'Biology',
            'Physics': 'Physics',
            'Chemistry': 'Chemistry',
            'Other': 'Other'
        };

        // Constants for progress calculation and chart
        const MAX_REVIEWS_FOR_MASTERY = 5; // A topic is considered 'mastered' after 5 reviews
        // SUBJECT_COLORS remain tied to canonical names for consistent styling
        const SUBJECT_COLORS = {
            'Biology': '#00ff00',    // Green
            'Physics': '#ff0066',    // Pink
            'Chemistry': '#00ffff',  // Cyan
            'Other': '#9b59b6'       // Purple
        };

        // Store references to progress bar elements and their current/target percentages
        const subjectProgressData = {
            'biology': {
                circleElement: null,
                percentageTextElement: null,
                labelElement: null,
                color: SUBJECT_COLORS['Biology'],
                targetPercentage: 0,
                animationFrame: null
            },
            'physics': {
                circleElement: null,
                percentageTextElement: null,
                labelElement: null,
                color: SUBJECT_COLORS['Physics'],
                targetPercentage: 0,
                animationFrame: null
            },
            'chemistry': {
                circleElement: null,
                percentageTextElement: null,
                labelElement: null,
                color: SUBJECT_COLORS['Chemistry'],
                targetPercentage: 0,
                animationFrame: null
            }
        };

        let errorMessageTimeout; // To store the timeout ID for the error message

        // --- Chatbot Global Variables (moved from chatbot.html) ---
        const chatModal = document.getElementById('chatModal');
        const chatHistoryDiv = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatForm = document.getElementById('chat-form');
        const chatCloseButton = document.getElementById('chat-close-button'); // Renamed to avoid conflict with main close button
        const chatRefreshButton = document.getElementById('chat-refresh-button');
        const chatWidget = document.getElementById('chat-widget');
        const chatUserIdDisplay = document.getElementById('chat-user-id-display'); // Renamed to avoid conflict
        const mainTypingIndicator = document.getElementById('main-typing-indicator');
        const statusDisplayArea = document.getElementById('status-display-area'); 
        const onlineStatusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const headerTypingIndicator = document.getElementById('header-typing-indicator');
        const attachmentButton = document.getElementById('attachment-button');
        const fileInput = document.getElementById('file-input');
        const pendingAttachmentsDisplay = document.getElementById('pending-attachments-display');
        const attachedFilesCount = document.getElementById('attached-files-count');
        const attachedFilesLabel = document.getElementById('attached-files-label');
        const attachedFilesIcon = document.getElementById('attached-files-icon');
        const attachmentSpinner = document.getElementById('attachment-spinner');
        const clearAttachmentsButton = document.getElementById('clear-attachments-button');
        const sendIcon = document.getElementById('send-icon');
        const sendSpinner = document.getElementById('send-spinner');

        // AI Message Actions
        const aiMessageActions = document.getElementById('ai-message-actions');
        const copyButton = document.getElementById('copy-button');
        const regenerateButton = document.getElementById('regenerate-button');
        const likeButton = document.getElementById('like-button');
        const dislikeButton = document.getElementById('dislike-button');
        let activeAiMessageId = null; // Stores the ID of the currently selected AI message
        let activeAiMessageElement = null; // Stores the DOM element of the currently selected AI message

        // Store messages including user ones for regeneration context and AI feedback
        const messagesData = []; 
        let pendingAttachments = [];

        // --- Helper Functions ---

        /**
         * Shows a temporary error message in the center of the screen.
         * @param {string} message - The error message to display.
         */
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            clearTimeout(errorMessageTimeout);
            errorMessageTimeout = setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        /**
         * Hides the error message.
         */
        function hideErrorMessage() {
            errorMessage.style.display = 'none';
            clearTimeout(errorMessageTimeout);
        }

        /**
         * Custom Alert/Confirmation Dialog
         * @param {string} message - The message to display.
         * @param {string} [title='Notification'] - The title of the modal.
         * @param {boolean} [isConfirm=false] - If true, shows OK and Cancel buttons for confirmation.
         * @returns {Promise<boolean>} Resolves to true if OK is clicked, false if Cancel is clicked.
         */
        function customAlert(message, title = 'Notification', isConfirm = false) {
            return new Promise((resolve) => {
                customAlertTitle.textContent = title;
                customAlertMessage.textContent = message;
                customAlertModal.style.display = 'flex'; // Use flex to center

                // Bring custom alert to front
                customAlertModal.style.zIndex = '1015'; // Ensure it's on top of all other modals

                customAlertOkButton.style.display = 'inline-block';
                customAlertCancelButton.style.display = isConfirm ? 'inline-block' : 'none';

                const handleOk = () => {
                    customAlertModal.style.display = 'none';
                    customAlertOkButton.removeEventListener('click', handleOk);
                    customAlertCancelButton.removeEventListener('click', handleCancel);
                    closeCustomAlertButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    customAlertModal.style.display = 'none';
                    customAlertOkButton.removeEventListener('click', handleOk);
                    customAlertCancelButton.removeEventListener('click', handleCancel);
                    closeCustomAlertButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                customAlertOkButton.addEventListener('click', handleOk);
                customAlertCancelButton.addEventListener('click', handleCancel);
                closeCustomAlertButton.addEventListener('click', handleCancel);
                customAlertModal.addEventListener('click', (e) => {
                    if (e.target === customAlertModal) {
                        handleCancel();
                    }
                }, { once: true });
            });
        }


        /**
         * Formats a Date object into a thereunder-MM-DD string.
         * Useful for input[type="date"] and storing dates consistently.
         * @param {Date} date - The date object to format.
         * @returns {string} The formatted date string.
         */
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Parses a thereunder-MM-DD date string into a Date object, set to the start of the day.
         * @param {string | Date} dateValue - The date string or Firestore Timestamp to parse.
         * @returns {Date} The parsed Date object.
         */
        function parseDate(dateValue) {
            if (dateValue instanceof Date) {
                return dateValue;
            }
            // Check if it's a Firestore Timestamp object
            if (typeof dateValue === 'object' && dateValue !== null && typeof dateValue.toDate === 'function') {
                return dateValue.toDate();
            }
            // Assume it's a thereunder-MM-DD string
            const [year, month, day] = String(dateValue).split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        /**
         * Calculates the next spaced repetition interval based on the reminder's properties.
         * @param {object} reminder - The reminder object for which to calculate the next interval.
         * @returns {number} The length of the next interval in days.
         */
        function calculateNextInterval(reminder) {
            const customIntervals = reminder.customIntervalsArray;
            const reviewCount = reminder.reviewCount;

            if (customIntervals && customIntervals.length > 0 && reviewCount < customIntervals.length) {
                return customIntervals[reviewCount];
            } else {
                if (reviewCount === 0) {
                    return 3;
                } else if (reviewCount === 1) {
                    return 7;
                } else {
                    const increment = reviewCount + 3;
                    return reminder.lastInterval + increment;
                }
            }
        }

        // --- Firebase Initialization and Auth ---

        /**
         * Initializes Firebase and sets up authentication listener.
         * Connects to Firestore and starts real-time data listeners once authenticated.
         */
        async function initializeFirebaseAndAuth() {
            loadingOverlay.style.display = 'flex'; // Show global loading overlay
            mainAppContainer.style.display = 'none'; // Ensure main app is hidden initially
            chatModal.style.display = 'none'; // Ensure chat modal is hidden initially

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Initialize storage here

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        appUserIdDisplay.textContent = `User ID: ${userId}`; // Display userId on UI for main app
                        chatUserIdDisplay.textContent = `User ID: ${userId}`; // Display userId on UI for chat app
                        console.log("Firebase user authenticated:", userId);
                        isFirebaseReady = true;
                        loginModal.style.display = 'none'; // Hide login modal
                        mainAppContainer.style.display = 'block'; // Show main app container
                        // Now that user is authenticated, set up real-time listeners for reminders and settings
                        setupRealtimeListeners();
                        setupChatFirestoreListener(); // Setup chat listener after main Firebase setup
                        updateOnlineStatusDisplay(); // Update chat's online status
                        loadingOverlay.style.display = 'none'; // Hide global loading overlay
                    } else {
                        // User is signed out or not authenticated
                        userId = null; // Clear userId
                        appUserIdDisplay.textContent = `User ID: Not Logged In`;
                        chatUserIdDisplay.textContent = `User ID: Not Logged In`;
                        isFirebaseReady = false; // Firebase not ready for user-specific data
                        allReminders = []; // Clear reminders
                        messagesData.length = 0; // Clear chat messages
                        renderReminders(); // Clear reminder UI
                        chatHistoryDiv.innerHTML = ''; // Clear chat UI
                        loadingOverlay.style.display = 'none'; // Hide global loading overlay
                        mainAppContainer.style.display = 'none'; // Hide main app container
                        chatModal.style.display = 'none'; // Hide chat modal
                        showLoginModal(); // Show login modal
                        
                        // Try anonymous sign-in or custom token if not explicitly signed out by user
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.error("Error during custom token sign-in:", error);
                                authErrorMessage.textContent = "Failed to auto-authenticate. Please log in.";
                                authErrorMessage.classList.remove('hidden');
                            }
                        } else {
                            // If no initial token, allow anonymous sign-in if needed or just wait for user login
                            try {
                                // signInAnonymously(auth); // Commented out to force explicit login
                            } catch (error) {
                                console.error("Error during anonymous sign-in:", error);
                            }
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showErrorMessage("Failed to initialize Firebase. Check console for details.");
                loadingOverlay.style.display = 'none'; // Hide global loading overlay on init error
                mainAppContainer.style.display = 'none';
                chatModal.style.display = 'none';
                showLoginModal(); // Still show login modal if Firebase init fails
            }
        }

        /**
         * Sets up real-time listeners for reminders and subject display names from Firestore.
         */
        function setupRealtimeListeners() {
            if (!isFirebaseReady || !userId) {
                console.warn("Firebase not ready or userId not available for setting up listeners. Skipping real-time listeners.");
                return;
            }

            // Listener for Reminders
            const remindersCollectionRef = collection(db, "artifacts", appId, "users", userId, "reminders");
            const qReminders = query(remindersCollectionRef, orderBy("nextReviewDate", "asc"));

            onSnapshot(qReminders, (snapshot) => {
                allReminders = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Convert Firestore Timestamps to JavaScript Date objects
                    return {
                        id: doc.id, // Use Firestore doc.id as the unique identifier
                        name: data.name,
                        subject: data.subject,
                        startDate: parseDate(data.startDate),
                        lastReviewDate: parseDate(data.lastReviewDate),
                        nextReviewDate: parseDate(data.nextReviewDate),
                        lastInterval: data.lastInterval,
                        reviewCount: data.reviewCount,
                        customIntervalsArray: data.customIntervalsArray || []
                    };
                });
                console.log("Reminders updated from Firestore:", allReminders);
                renderReminders(); // Re-render the UI with the latest data
            }, (error) => {
                console.error("Error listening to reminders:", error);
                showErrorMessage("Error fetching reminders: " + error.message);
            });

            // Listener for Subject Display Names
            const subjectSettingsDocRef = doc(db, "artifacts", appId, "users", userId, "settings", "displayNames");
            onSnapshot(subjectSettingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    subjectDisplayNames = { ...subjectDisplayNames, ...data }; // Merge with defaults
                    console.log("Subject display names updated from Firestore:", subjectDisplayNames);
                } else {
                    console.log("No custom subject display names found in Firestore, using defaults.");
                    // Optionally, save default names to Firestore if they don't exist
                    // saveCustomSubjectDisplayNames(); // This could cause a loop if not careful
                }
                updateSubjectDropdowns(); // Update all dropdowns
                renderReminders(); // Re-render reminders to reflect new names
                renderProgressChart(); // Re-render progress chart with new names
            }, (error) => {
                console.error("Error listening to subject display names:", error);
                showErrorMessage("Error fetching subject names: " + error.message);
            });
        }


        /**
         * Migrates existing local storage data to Firebase Firestore.
         * This function should ideally be called once, e.g., when a user first logs in
         * and their Firestore data is empty, to transfer their old local data.
         */
        async function migrateLocalDataToFirestore() {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Please try again in a moment.");
                return;
            }

            const confirmMigration = await customAlert(
                "This will attempt to transfer your locally stored reminders to Firebase. This might create duplicate reminders if you've already added some to Firebase. Do you want to proceed?",
                "Confirm Data Migration", true
            );

            if (!confirmMigration) {
                return;
            }

            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = 'Migrating local data...';

            const localRemindersJSON = localStorage.getItem('allStudyReminders');
            const localDisplayNamesJSON = localStorage.getItem('subjectDisplayNames');
            let migratedCount = 0;

            try {
                // Migrate Reminders
                if (localRemindersJSON) {
                    const localReminders = JSON.parse(localRemindersJSON);
                    if (localReminders && localReminders.length > 0) {
                        for (const reminder of localReminders) {
                            try {
                                // Prepare data for Firestore: convert Date objects to strings/timestamps
                                const reminderData = {
                                    name: reminder.name || 'Untitled Topic',
                                    subject: CANONICAL_SUBJECTS.includes(reminder.subject) ? reminder.subject : 'Other',
                                    startDate: new Date(reminder.startDate),
                                    lastReviewDate: new Date(reminder.lastReviewDate),
                                    nextReviewDate: new Date(reminder.nextReviewDate),
                                    lastInterval: reminder.lastInterval || 0,
                                    reviewCount: reminder.reviewCount || 0,
                                    customIntervalsArray: reminder.customIntervalsArray || []
                                };
                                // Firestore will automatically create timestamps from Date objects
                                await addDoc(collection(db, "artifacts", appId, "users", userId, "reminders"), reminderData);
                                migratedCount++;
                            } catch (e) {
                                console.error("Error adding local reminder to Firestore: ", e);
                                showErrorMessage(`Failed to migrate some reminders: ${e.message}`);
                            }
                        }
                    }
                }

                // Migrate Subject Display Names
                if (localDisplayNamesJSON) {
                    const parsedNames = JSON.parse(localDisplayNamesJSON);
                    // Use setDoc with merge: true to avoid overwriting other settings
                    await setDoc(doc(db, "artifacts", appId, "users", userId, "settings", "displayNames"), parsedNames, { merge: true });
                }

                if (migratedCount > 0) {
                    customAlert(`Migration complete. ${migratedCount} reminders transferred from local storage to Firebase.`, 'Migration Success');
                    localStorage.removeItem('allStudyReminders'); // Clear local storage after successful migration
                    localStorage.removeItem('subjectDisplayNames');
                } else {
                    customAlert("No reminders found in local storage to migrate, or all failed.", "Migration Info");
                }
            } catch (e) {
                console.error("Overall migration error:", e);
                showErrorMessage("An error occurred during migration: " + e.message);
            } finally {
                loadingOverlay.style.display = 'none';
                loadingOverlay.textContent = 'Loading Reminders...'; // Reset text
            }
        }


        // --- Core Logic Functions (Adapted for Firebase) ---

        /**
         * Saves custom subject display names to Firestore.
         */
        async function saveCustomSubjectDisplayNames() {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot save settings.");
                return;
            }
            try {
                await setDoc(doc(db, "artifacts", appId, "users", userId, "settings", "displayNames"), subjectDisplayNames, { merge: true });
                console.log("Subject display names saved to Firestore.");
            } catch (e) {
                console.error("Error saving subject display names to Firestore:", e);
                showErrorMessage("Failed to save subject names: " + e.message);
            }
        }
        
        /**
         * Adds a new topic to Firestore.
         * @param {string} name - The name of the study topic.
         * @param {string} subject - The subject of the topic (e.g., 'Biology', 'Physics').
         * @param {string} startDateString - The start date string in thereunder-MM-DD format.
         */
        async function addTopic(name, subject, startDateString) {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot add reminder.");
                return;
            }
            try {
                const startDate = parseDate(startDateString);
                
                const initialInterval = calculateNextInterval({ reviewCount: 0, customIntervalsArray: [] });

                const nextReviewDate = new Date(startDate);
                nextReviewDate.setDate(startDate.getDate() + initialInterval);

                const newTopic = {
                    name: name,
                    subject: subject, // This will be the canonical subject name
                    startDate: startDate, // Firestore will convert Date objects to Timestamps
                    lastReviewDate: startDate,
                    nextReviewDate: nextReviewDate,
                    lastInterval: initialInterval,
                    reviewCount: 0,
                    customIntervalsArray: []
                };

                await addDoc(collection(db, "artifacts", appId, "users", userId, "reminders"), newTopic);
                customAlert('Reminder added successfully!', 'Success');
            } catch (e) {
                console.error("Error adding topic to Firestore:", e);
                showErrorMessage("Failed to add reminder: " + e.message);
            }
        }

        /**
         * Marks a topic as reviewed, calculates and schedules its next review date in Firestore.
         * @param {string} reminderId - The Firestore document ID of the reminder to mark as reviewed.
         */
        async function markAsReviewed(reminderId) {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot update reminder.");
                return;
            }
            try {
                const reminderRef = doc(db, "artifacts", appId, "users", userId, "reminders", reminderId);
                const reminder = allReminders.find(r => r.id === reminderId);

                if (reminder) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const updatedReviewCount = reminder.reviewCount + 1;
                    const nextInterval = calculateNextInterval({
                        reviewCount: reminder.reviewCount, // Use current count for calculation
                        lastInterval: reminder.lastInterval,
                        customIntervalsArray: reminder.customIntervalsArray
                    });
                    
                    const nextReviewDate = new Date(today);
                    nextReviewDate.setDate(today.getDate() + nextInterval);

                    await updateDoc(reminderRef, {
                        lastReviewDate: today,
                        reviewCount: updatedReviewCount,
                        nextReviewDate: nextReviewDate,
                        lastInterval: nextInterval
                    });
                    customAlert('Reminder marked as reviewed!', 'Success');
                }
            } catch (e) {
                console.error("Error marking reminder as reviewed in Firestore:", e);
                showErrorMessage("Failed to mark reminder reviewed: " + e.message);
            }
        }

        /**
         * Populates the subject dropdowns with custom display names.
         * @param {HTMLSelectElement} selectElement - The select element to populate.
         * @param {boolean} includeAllOption - Whether to include an "All Subjects" option.
         */
        function populateSubjectSelect(selectElement, includeAllOption) {
            selectElement.innerHTML = ''; // Clear existing options

            if (includeAllOption) {
                const allOption = document.createElement('option');
                allOption.value = 'All';
                allOption.textContent = 'All Subjects'; // Always "All Subjects"
                selectElement.appendChild(allOption);
            }

            CANONICAL_SUBJECTS.forEach(subjectKey => {
                if (subjectKey !== 'Other' || !includeAllOption) { // Avoid duplicating 'Other' or showing it in filter
                    const option = document.createElement('option');
                    option.value = subjectKey; // Store canonical key
                    option.textContent = subjectDisplayNames[subjectKey]; // Display custom name
                    selectElement.appendChild(option);
                }
            });

            // If it's the filter select, set its value back to currentFilterSubject after repopulating
            if (selectElement === filterSubjectSelect) {
                selectElement.value = currentFilterSubject;
            }
        }

        /**
         * Updates all subject dropdowns in the application.
         */
        function updateSubjectDropdowns() {
            populateSubjectSelect(addSubjectSelect, false); // No 'All' option for Add
            populateSubjectSelect(modalSubjectSelect, false); // No 'All' option for Edit
            populateSubjectSelect(filterSubjectSelect, true); // 'All' option for Filter
        }

        /**
         * Dynamically sets the grid-template-columns for a reminder list based on item count and screen size.
         * For desktop (>= 768px), it will try to fit between 1 and 5 columns,
         * stretching them to fill the width. For mobile (< 768px), it remains responsive
         * with 1 or 2 columns based on screen width.
         * @param {HTMLElement} listElement - The <ul> element (e.g., todayRemindersList).
         * @param {number} itemCount - The number of items in that list.
         */
        function setResponsiveGridColumns(listElement, itemCount) {
            const maxDesktopColumns = 5; // User's requested maximum displayed columns on desktop
            const currentWindowWidth = window.innerWidth;

            if (itemCount === 0) {
                // If no items, the empty message will span full grid width due to its CSS (grid-column: 1 / -1;).
                // The grid itself will simply be 1fr to ensure basic layout, not affecting the empty message's span.
                listElement.style.gridTemplateColumns = '1fr';
                return;
            }

            if (currentWindowWidth >= 768) { // Desktop and large tablets
                // Determine the number of columns:
                // - If 1 item, show 1 column.
                // - Otherwise, show up to maxDesktopColumns, but not more than itemCount.
                let columnsToDisplay;
                if (itemCount === 1) {
                    columnsToDisplay = 1;
                } else {
                    columnsToDisplay = Math.min(itemCount, maxDesktopColumns);
                }
                listElement.style.gridTemplateColumns = `repeat(${columnsToDisplay}, 1fr)`;
            } else if (currentWindowWidth >= 640) { // Smaller tablets (640px to 767px)
                // For tablets, default to 2 columns if there are 2 or more items, otherwise 1
                listElement.style.gridTemplateColumns = `repeat(${itemCount >= 2 ? 2 : 1}, 1fr)`;
            } else { // Mobile (less than 640px)
                // Force single column on mobile for better readability
                listElement.style.gridTemplateColumns = '1fr';
            }
        }

        /**
         * Renders all reminders based on filters (subject, incomplete mode).
         * Dynamically shows/hides sections and populates lists.
         */
        function renderReminders() {
            todayRemindersList.innerHTML = '';
            upcomingRemindersList.innerHTML = '';
            incompleteRemindersList.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let filteredBySubject = allReminders.filter(reminder => {
                // Filter using the canonical subject name
                return currentFilterSubject === 'All' || reminder.subject === currentFilterSubject;
            });

            if (showOnlyIncomplete) {
                todayRemindersSection.style.display = 'none';
                upcomingRemindersSection.style.display = 'none';
                incompleteTopicsSection.style.display = 'block';

                const incompleteList = filteredBySubject.filter(reminder => {
                    return reminder.nextReviewDate.getTime() <= today.getTime();
                });

                if (incompleteList.length === 0) {
                    incompleteRemindersList.innerHTML = `<li class="empty-message">Great job! All caught up on your incomplete topics.</li>`;
                } else {
                    incompleteList.sort((a, b) => a.nextReviewDate.getTime() - b.nextReviewDate.getTime());
                    incompleteList.forEach(reminder => {
                        const reminderItem = document.createElement('li');
                        reminderItem.classList.add('reminder-item', 'today');

                        const nextReviewDateFormatted = formatDate(reminder.nextReviewDate);
                        const lastReviewDateFormatted = reminder.lastReviewDate ? formatDate(reminder.lastReviewDate) : 'N/A';

                        reminderItem.innerHTML = `
                            <button class="settings-button" data-id="${reminder.id}">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                            </button>
                            <div class="reminder-details">
                                <strong>${reminder.name} (${subjectDisplayNames[reminder.subject]})</strong>
                                <span>Next Review: ${nextReviewDateFormatted}</span>
                                <span>Last Reviewed: ${lastReviewDateFormatted}</span>
                                <span>Review Count: ${reminder.reviewCount}</span>
                                <span>Next Interval: ${reminder.lastInterval} days</span>
                            </div>
                            <div class="reminder-actions">
                                <button data-id="${reminder.id}" class="mark-reviewed-button">Mark Reviewed</button>
                            </div>
                        `;
                        incompleteRemindersList.appendChild(reminderItem);
                    });
                }
                setResponsiveGridColumns(incompleteRemindersList, incompleteList.length);

            } else {
                todayRemindersSection.style.display = 'block';
                upcomingRemindersSection.style.display = 'block';
                incompleteTopicsSection.style.display = 'none';

                const remindersDueToday = filteredBySubject.filter(reminder => {
                    return reminder.nextReviewDate.getTime() <= today.getTime();
                });
                const upcomingReminders = filteredBySubject.filter(reminder => {
                    return reminder.nextReviewDate.getTime() > today.getTime();
                });

                remindersDueToday.sort((a, b) => a.nextReviewDate.getTime() - b.nextReviewDate.getTime());
                upcomingReminders.sort((a, b) => a.nextReviewDate.getTime() - b.nextReviewDate.getTime());

                if (remindersDueToday.length === 0) {
                    todayRemindersList.innerHTML = `<li class="empty-message">No topics due today! Keep up the good work.</li>`;
                } else {
                    remindersDueToday.forEach(reminder => {
                        const reminderItem = document.createElement('li');
                        reminderItem.classList.add('reminder-item', 'today');
                        
                        const nextReviewDateFormatted = formatDate(reminder.nextReviewDate);
                        const lastReviewDateFormatted = reminder.lastReviewDate ? formatDate(reminder.lastReviewDate) : 'N/A';

                        reminderItem.innerHTML = `
                            <button class="settings-button" data-id="${reminder.id}">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                            </button>
                            <div class="reminder-details">
                                <strong>${reminder.name} (${subjectDisplayNames[reminder.subject]})</strong>
                                <span>Next Review: ${nextReviewDateFormatted}</span>
                                <span>Last Reviewed: ${lastReviewDateFormatted}</span>
                                <span>Review Count: ${reminder.reviewCount}</span>
                                <span>Next Interval: ${reminder.lastInterval} days</span>
                            </div>
                            <div class="reminder-actions">
                                <button data-id="${reminder.id}" class="mark-reviewed-button">Mark Reviewed</button>
                            </div>
                        `;
                        todayRemindersList.appendChild(reminderItem);
                    });
                }
                setResponsiveGridColumns(todayRemindersList, remindersDueToday.length);


                if (upcomingReminders.length === 0) {
                    upcomingRemindersList.innerHTML = `<li class="empty-message">No upcoming reminders for now.</li>`;
                } else {
                    upcomingReminders.forEach(reminder => {
                        const reminderItem = document.createElement('li');
                        reminderItem.classList.add('reminder-item');
                        
                        const nextReviewDateFormatted = formatDate(reminder.nextReviewDate);
                        const lastReviewDateFormatted = reminder.lastReviewDate ? formatDate(reminder.lastReviewDate) : 'N/A';

                        reminderItem.innerHTML = `
                            <button class="settings-button" data-id="${reminder.id}">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                            </button>
                            <div class="reminder-details">
                                <strong>${reminder.name} (${subjectDisplayNames[reminder.subject]})</strong>
                                <span>Next Review: ${nextReviewDateFormatted}</span>
                                <span>Last Reviewed: ${lastReviewDateFormatted}</span>
                                <span>Review Count: ${reminder.reviewCount}</span>
                                <span>Next Interval: ${reminder.lastInterval} days</span>
                            </div>
                            <div class="reminder-actions">
                                <!-- Mark Reviewed button removed here -->
                            </div>
                        `;
                        upcomingRemindersList.appendChild(reminderItem);
                    });
                }
                setResponsiveGridColumns(upcomingRemindersList, upcomingReminders.length);
            }
        }

        // --- Modals Control Functions ---

        /**
         * Opens the "Add New Reminder" modal.
         */
        function openAddReminderModal() {
            addReminderModal.style.display = 'flex';
            topicNameInput.value = '';
            // Set default subject using custom display name (canonical value is used as option value)
            addSubjectSelect.value = 'Biology';
            startDateInput.value = formatDate(new Date());
        }

        /**
         * Hides the "Add New Reminder" modal.
         */
        function closeAddReminderModal() {
            addReminderModal.style.display = 'none';
        }

        /**
         * Opens the "Edit Reminder Settings" modal for a specific reminder.
         * Populates modal fields with the reminder's current data.
         * @param {string} id - The Firestore document ID of the reminder to edit.
         */
        function openSettingsModal(id) {
            const reminder = allReminders.find(r => r.id === id);
            if (reminder) {
                modalReminderId.value = reminder.id;
                modalTopicNameInput.value = reminder.name;
                modalSubjectSelect.value = reminder.subject; // Set using canonical subject name
                modalNextReviewDateInput.value = formatDate(reminder.nextReviewDate);
                modalCustomIntervalsInput.value = reminder.customIntervalsArray ? reminder.customIntervalsArray.join(',') : '';
                
                settingsModal.style.display = 'flex';
            }
        }

        /**
         * Hides the "Edit Reminder Settings" modal.
         */
        function closeSettingsModal() {
            settingsModal.style.display = 'none';
        }

        /**
         * Saves changes made in the reminder settings modal to Firestore.
         */
        async function saveReminderChanges() {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot save changes.");
                return;
            }
            try {
                const id = modalReminderId.value; // This is the Firestore doc ID
                const reminderRef = doc(db, "artifacts", appId, "users", userId, "reminders", id);
                
                const newTopicName = modalTopicNameInput.value.trim();
                const newSubject = modalSubjectSelect.value;
                const newNextReviewDateString = modalNextReviewDateInput.value;
                const newCustomIntervalsString = modalCustomIntervalsInput.value.trim();

                let updatedCustomIntervalsArray = [];
                if (newCustomIntervalsString) {
                    const parsedIntervals = newCustomIntervalsString.split(',')
                                            .map(s => parseInt(s.trim()))
                                            .filter(n => !isNaN(n) && n > 0);
                    if (parsedIntervals.length > 0) {
                        updatedCustomIntervalsArray = parsedIntervals;
                    } else {
                        console.warn('Invalid custom intervals entered. Using empty array.');
                    }
                }
                
                const updatedData = {
                    name: newTopicName,
                    subject: newSubject,
                    nextReviewDate: parseDate(newNextReviewDateString),
                    customIntervalsArray: updatedCustomIntervalsArray
                };

                await updateDoc(reminderRef, updatedData);
                closeSettingsModal();
                customAlert('Changes saved successfully!', 'Success');
            } catch (e) {
                console.error("Error saving reminder changes to Firestore:", e);
                showErrorMessage("Failed to save changes: " + e.message);
            }
        }

        /**
         * Deletes the currently selected reminder from Firestore.
         */
        async function deleteReminder() {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot delete reminder.");
                return;
            }
            const id = modalReminderId.value; // This is the Firestore doc ID
            const confirmed = await customAlert('Are you sure you want to delete this reminder? This action cannot be undone.', 'Confirm Delete', true);
            
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "artifacts", appId, "users", userId, "reminders", id));
                    closeSettingsModal();
                    customAlert('Reminder deleted successfully!', 'Success');
                } catch (e) {
                    console.error("Error deleting reminder from Firestore:", e);
                    showErrorMessage("Failed to delete reminder: " + e.message);
                }
            }
        }

        /**
         * Resets the spaced repetition pattern for the current reminder in Firestore.
         */
        async function resetSpacedRepetitionPattern() {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot reset pattern.");
                return;
            }
            try {
                const id = modalReminderId.value; // This is the Firestore doc ID
                const reminderRef = doc(db, "artifacts", appId, "users", userId, "reminders", id);
                const reminder = allReminders.find(r => r.id === id);

                if (reminder) {
                    const initialInterval = calculateNextInterval({ reviewCount: 0, customIntervalsArray: [] });
                    const newNextReviewDate = new Date(reminder.startDate); // Reset to start date
                    newNextReviewDate.setDate(reminder.startDate.getDate() + initialInterval);
                    
                    await updateDoc(reminderRef, {
                        customIntervalsArray: [],
                        reviewCount: 0,
                        lastInterval: initialInterval,
                        nextReviewDate: newNextReviewDate,
                        lastReviewDate: reminder.startDate // Reset last review date to start date
                    });
                    closeSettingsModal();
                    customAlert('Spaced repetition pattern reset for this topic. It will now follow the default intervals starting from its original start date.', 'Pattern Reset');
                }
            } catch (e) {
                console.error("Error resetting pattern in Firestore:", e);
                showErrorMessage("Failed to reset pattern: " + e.message);
            }
        }

        /**
         * Opens the "Change Subjects" modal.
         * Populates input fields with current custom display names.
         */
        function openChangeSubjectsModal() {
            changeDisplayNameBiologyInput.value = subjectDisplayNames['Biology'];
            changeDisplayNamePhysicsInput.value = subjectDisplayNames['Physics'];
            changeDisplayNameChemistryInput.value = subjectDisplayNames['Chemistry'];
            changeSubjectsModal.style.display = 'flex';
            settingsMenu.classList.remove('show'); // Close settings dropdown
        }

        /**
         * Hides the "Change Subjects" modal.
         */
        function closeChangeSubjectsModal() {
            changeSubjectsModal.style.display = 'none';
        }

        /**
         * Saves custom subject display names from the "Change Subjects" modal to Firestore.
         */
        async function saveSubjectDisplayNamesFromModal() {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot save subject names.");
                return;
            }
            const newDisplayNames = {
                'Biology': changeDisplayNameBiologyInput.value.trim() || 'Biology',
                'Physics': changeDisplayNamePhysicsInput.value.trim() || 'Physics',
                'Chemistry': changeDisplayNameChemistryInput.value.trim() || 'Chemistry'
            };
            // The 'Other' subject display name is not editable via this modal
            newDisplayNames['Other'] = subjectDisplayNames['Other'] || 'Other';

            subjectDisplayNames = newDisplayNames; // Update local state immediately
            await saveCustomSubjectDisplayNames(); // Save to Firestore
            
            // UI updates are handled by the onSnapshot listener for display names
            closeChangeSubjectsModal();
            customAlert('Subject display names saved successfully!', 'Success');
        }


        /**
         * UPDATED: Updates a single subject's progress bar visually with animation.
         * @param {string} subjectKey - The canonical subject key ('Biology', 'Physics', 'Chemistry').
         * @param {number} newPercentage - The target percentage for the progress bar (0-100).
         */
        function setSubjectProgress(subjectKey, newPercentage) {
            const dataKey = subjectKey.toLowerCase();
            const data = subjectProgressData[dataKey];

            if (!data || !data.circleElement || !data.percentageTextElement || !data.labelElement) {
                console.error(`Elements for subject ${subjectKey} not found or data is incomplete.`);
                return;
            }

            let parsedPercentage = parseInt(newPercentage, 10);
            if (isNaN(parsedPercentage) || parsedPercentage < 0) parsedPercentage = 0;
            if (parsedPercentage > 100) parsedPercentage = 100;

            data.targetPercentage = parsedPercentage;

            let currentPercentage = 0;
            const animationDuration = 1500;
            const intervalTime = 10;

            if (data.animationFrame) {
                cancelAnimationFrame(data.animationFrame);
            }

            const animateProgress = () => {
                const degrees = currentPercentage * 3.6;
                data.circleElement.style.background = `conic-gradient(${data.color} ${degrees}deg, transparent ${degrees}deg)`;
                data.percentageTextElement.textContent = `${Math.round(currentPercentage)}%`;
                data.circleElement.style.setProperty('--percentage', currentPercentage);

                // Use the custom display name for the label text
                data.labelElement.textContent = subjectDisplayNames[subjectKey];

                if (currentPercentage < data.targetPercentage) {
                    currentPercentage += (data.targetPercentage / (animationDuration / intervalTime));
                    if (currentPercentage > data.targetPercentage) {
                        currentPercentage = data.targetPercentage;
                    }
                    data.animationFrame = requestAnimationFrame(animateProgress);
                } else {
                    data.circleElement.style.background = `conic-gradient(${data.color} ${data.targetPercentage * 3.6}deg, transparent ${data.targetPercentage * 3.6}deg)`;
                    data.percentageTextElement.textContent = `${data.targetPercentage}%`;
                    data.animationFrame = null;
                }
            };

            animateProgress();
        }


        /**
         * Calculates progress for each subject and renders the circular charts.
         */
        function renderProgressChart() {
            // Re-initialize element references for progress bars on each render
            // This is safer if elements are dynamically re-rendered, though typically not needed for fixed elements.
            SUBJECT_ORDER_FOR_CHART.forEach(subjectKey => {
                const key = subjectKey.toLowerCase();
                subjectProgressData[key].circleElement = document.querySelector(`.progress-${key}`);
                subjectProgressData[key].percentageTextElement = document.querySelector(`#${key}Percentage`);
                subjectProgressData[key].labelElement = document.querySelector(`.progress-${key} .label`);

                // Ensure initial state is set for smooth animation
                if (subjectProgressData[key].circleElement) {
                    subjectProgressData[key].circleElement.style.background = `conic-gradient(${subjectProgressData[key].color} 0deg, transparent 0deg)`;
                    subjectProgressData[key].percentageTextElement.textContent = `0%`;
                }
                if (subjectProgressData[key].labelElement) {
                    subjectProgressData[key].labelElement.textContent = subjectDisplayNames[subjectKey];
                }
            });


            const subjectProgressCalculations = {};

            // Initialize calculations for all chart subjects
            SUBJECT_ORDER_FOR_CHART.forEach(subjectKey => {
                subjectProgressCalculations[subjectKey] = {
                    totalReviews: 0,
                    totalPossibleReviews: 0,
                    percentage: 0
                };
            });

            // Aggregate data for each subject (using canonical name)
            allReminders.forEach(reminder => {
                if (SUBJECT_ORDER_FOR_CHART.includes(reminder.subject)) {
                    subjectProgressCalculations[reminder.subject].totalReviews += reminder.reviewCount;
                    subjectProgressCalculations[reminder.subject].totalPossibleReviews += MAX_REVIEWS_FOR_MASTERY;
                }
            });

            SUBJECT_ORDER_FOR_CHART.forEach(subjectKey => {
                const data = subjectProgressCalculations[subjectKey];
                let percentage = 0;
                if (data && data.totalPossibleReviews > 0) {
                    // Cap individual review counts at MAX_REVIEWS_FOR_MASTERY for percentage calculation
                    const cappedTotalReviews = Math.min(data.totalReviews, data.totalPossibleReviews);
                    percentage = (cappedTotalReviews / data.totalPossibleReviews) * 100;
                }
                setSubjectProgress(subjectKey, percentage);
            });
        }


        // --- Chatbot Specific Functions (moved from chatbot.html) ---

        // Function to show/hide typing indicator in main chat area and header status
        const showTypingIndicator = (show) => {
            if (show) {
                mainTypingIndicator.classList.remove('hidden');
                statusDisplayArea.classList.remove('show');
                statusDisplayArea.classList.add('hide');
                headerTypingIndicator.classList.remove('hide');
                headerTypingIndicator.classList.add('show');
            } else {
                mainTypingIndicator.classList.add('hidden');
                statusDisplayArea.classList.remove('hide');
                statusDisplayArea.classList.add('show');
                headerTypingIndicator.classList.remove('show');
                headerTypingIndicator.classList.add('hide');
            }
            scrollToBottom();
        };

        // Function to update the online/offline status display
        const updateOnlineStatusDisplay = () => {
            if (navigator.onLine) {
                onlineStatusText.textContent = "We're online";
                statusDot.querySelector('.animate-ping').classList.remove('bg-red-400');
                statusDot.querySelector('.animate-ping').classList.add('bg-green-400');
                statusDot.querySelector('.relative').classList.remove('bg-red-500');
                statusDot.querySelector('.relative').classList.add('bg-green-500');
            } else {
                onlineStatusText.textContent = "You're offline";
                statusDot.querySelector('.animate-ping').classList.remove('bg-green-400');
                statusDot.querySelector('.animate-ping').classList.add('bg-red-400');
                statusDot.querySelector('.relative').classList.remove('bg-green-400');
                statusDot.querySelector('.relative').classList.add('bg-red-500');
            }
            if (mainTypingIndicator.classList.contains('hidden') && !chatModal.classList.contains('hidden')) { // Changed chatWidget to chatModal
                 statusDisplayArea.classList.remove('hide');
                 statusDisplayArea.classList.add('show');
            }
        };

        // Function to scroll to the bottom of the chat history
        const scrollToBottom = (behavior = 'smooth') => {
            chatHistoryDiv.scrollTo({
                top: chatHistoryDiv.scrollHeight,
                behavior: behavior
            });
        };

        // Function to format text with Markdown-like syntax
        const formatMessageText = (text) => {
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">$1</a>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/_(.*?)_/g, '<u>$1</u>');
            text = text.replace(/\$(.*?)\$/g, '<span class="math-inline">$$1</span>');
            text = text.replace(/\$\$(.*?)\$\$/g, '<div class="math-block">$$1</div>');
            return text;
        };

        // Function to format timestamp for display (e.g., "5 min ago", "Yesterday", "Oct 15, 2024")
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSeconds < 60) {
                return 'just now';
            } else if (diffMinutes < 60) {
                return `${diffMinutes} min${diffMinutes > 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        };

        // Function to get full timestamp for tooltip
        const getFullTimestamp = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: 'numeric', minute: 'numeric', second: 'numeric',
                hour12: true
            });
        };

        // Function to hide AI message actions
        const hideAiMessageActions = () => {
            aiMessageActions.classList.remove('visible');
            aiMessageActions.classList.add('hidden');
            activeAiMessageId = null;
            activeAiMessageElement = null;
        };

        // Function to render a new message in the chat history
        const renderMessage = (message) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', message.sender === 'user' ? 'justify-end' : 'justify-start', 'mb-2', 'message-bubble-pop');
            messageElement.setAttribute('data-message-id', message.id); // Set message ID
            
            let messageContentHtml = message.text ? `<p class="text-base">${formatMessageText(message.text)}</p>` : '';
            
            if (message.attachments && message.attachments.length > 0) {
                message.attachments.forEach(att => {
                    if (att.type && att.type.startsWith('image/')) {
                        messageContentHtml += `
                            <div class="attached-image-container ${message.sender === 'user' ? 'text-white' : 'text-gray-800'}">
                                <img src="${att.url}" alt="${att.name}" class="attached-image-preview" onerror="this.onerror=null; this.src='https://placehold.co/100x100/CCCCCC/000000?text=Image+Load+Error';" />
                                <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="attached-file-link ${message.sender === 'user' ? 'text-white hover:text-gray-100' : 'text-gray-800 hover:text-gray-600'}">
                                    ${att.name}
                                </a>
                            </div>
                        `;
                    } else {
                        let icon = '📎';
                        if (att.type && att.type.startsWith('video/')) {
                            icon = '🎥';
                        } else if (att.type && att.type.includes('pdf')) {
                            icon = '📄';
                        } else if (att.type && att.type.includes('audio/')) {
                             icon = '🔊';
                        }

                        messageContentHtml += `
                            <div class="attached-file ${message.sender === 'user' ? 'text-white' : 'text-gray-800'}">
                                <span class="attached-file-icon">${icon}</span>
                                <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="attached-file-link ${message.sender === 'user' ? 'text-white hover:text-gray-100' : 'text-gray-800 hover:text-gray-600'}">
                                    ${att.name}
                                </a>
                            </div>
                        `;
                    }
                });
            }

            const timestampText = formatTimestamp(message.timestamp);
            const fullTimestampText = getFullTimestamp(message.timestamp);
            messageContentHtml += `<div class="message-timestamp ${message.sender === 'ai' ? 'ai' : ''}" title="${fullTimestampText}">${timestampText}</div>`;

            messageElement.innerHTML = `
                <div class="max-w-[70%] px-4 py-2 rounded-xl shadow ${message.sender === 'user' ? 'bg-blue-400 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'}">
                    ${messageContentHtml}
                </div>
            `;
            chatHistoryDiv.appendChild(messageElement);

            // Add click listener for AI messages
            if (message.sender === 'ai') {
                // Select the inner message bubble for click event and positioning
                // Corrected selector by escaping square brackets
                const innerMessageBubble = messageElement.querySelector('.max-w-\\[70\\%\\]');
                if (innerMessageBubble) {
                    innerMessageBubble.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent document click from immediately closing
                        showAiMessageActions(message.id, innerMessageBubble, message.feedback);
                    });
                }
            }


            messageElement.addEventListener('animationend', () => {
                messageElement.classList.remove('message-bubble-pop');
            }, { once: true });

            scrollToBottom();
        };

        // Function to display AI message actions
        const showAiMessageActions = (messageId, messageElement, currentFeedback) => {
            // Hide any currently active actions first
            hideAiMessageActions();

            activeAiMessageId = messageId;
            activeAiMessageElement = messageElement;

            // Update like/dislike button states
            likeButton.classList.remove('active-feedback', 'dislike');
            dislikeButton.classList.remove('active-feedback', 'dislike');
            if (currentFeedback === 'liked') {
                likeButton.classList.add('active-feedback');
            } else if (currentFeedback === 'disliked') {
                dislikeButton.classList.add('active-feedback', 'dislike');
            }

            // Position the actions container
            const rect = messageElement.getBoundingClientRect();
            const chatHistoryRect = chatHistoryDiv.getBoundingClientRect();

            // Position relative to chatHistoryDiv
            aiMessageActions.style.left = `${rect.left - chatHistoryRect.left}px`;
            aiMessageActions.style.top = `${rect.bottom - chatHistoryRect.top + 10}px`; // 10px below message bubble

            aiMessageActions.classList.remove('hidden');
            aiMessageActions.classList.add('visible');
        };

        // Function to add a dynamic indicator message (e.g., "New Chat Started")
        const addIndicatorMessage = (text) => {
            const indicatorElement = document.createElement('div');
            indicatorElement.classList.add('text-center', 'text-gray-400', 'text-xs', 'my-4', 'new-chat-indicator');
            indicatorElement.textContent = text;
            chatHistoryDiv.appendChild(indicatorElement);
            scrollToBottom();
            setTimeout(() => {
                indicatorElement.classList.add('message-exit-animation');
                indicatorElement.addEventListener('animationend', () => {
                    indicatorElement.remove();
                }, { once: true });
            }, 3000);
        };


        // Function to upload file to Firebase Storage
        async function uploadFile(file) {
            const storageRefInstance = ref(storage, `chat_attachments/${userId}/${Date.now()}_${file.name}`);

            try {
                const snapshot = await uploadBytes(storageRefInstance, file);
                const fileURL = await getDownloadURL(snapshot.ref);
                return { url: fileURL, name: file.name, type: file.type };
            } catch (error) {
                console.error("Error uploading file:", error);
                throw error;
            }
        }

        // Setup Firestore listener for messages (Chatbot's version)
        const setupChatFirestoreListener = () => {
            if (!db || !userId || !isFirebaseReady) return;

            const messagesCollectionPath = `artifacts/${appId}/public/data/chat_messages`;

            const messagesColRef = collection(db, messagesCollectionPath);
            const q = query(messagesColRef, orderBy('timestamp'));

            onSnapshot(q, snapshot => {
                // Determine if a full refresh (clear) is needed based on changes
                const isInitialLoad = messagesData.length === 0 && snapshot.docs.length > 0;
                const isClearTriggeredExternally = snapshot.docChanges().some(change => change.type === 'removed' && snapshot.docs.length < messagesData.length);

                if (isInitialLoad || isClearTriggeredExternally) {
                    chatHistoryDiv.innerHTML = '';
                    messagesData.length = 0;
                }
                
                snapshot.docChanges().forEach(change => {
                    const message = { id: change.doc.id, ...change.doc.data() };
                    
                    if (change.type === "added") {
                        // Only add if not already in messagesData to prevent re-rendering existing messages
                        // This helps keep the "message-bubble-pop" animation for *new* messages only
                        if (!messagesData.some(m => m.id === message.id)) {
                            messagesData.push(message);
                            renderMessage(message);
                        }
                    } else if (change.type === "modified") {
                        // Find and update the existing message in messagesData and DOM
                        const index = messagesData.findIndex(m => m.id === message.id);
                        if (index !== -1) {
                            messagesData[index] = message;
                            // Re-render the specific message to update feedback state
                            const existingElement = chatHistoryDiv.querySelector(`[data-message-id="${message.id}"]`);
                            if (existingElement) {
                                // Temporarily remove animation class to prevent re-triggering pop on update
                                existingElement.classList.remove('message-bubble-pop');
                                const newElement = document.createElement('div');
                                newElement.classList.add('flex', message.sender === 'user' ? 'justify-end' : 'justify-start', 'mb-2'); // No pop for updates
                                newElement.setAttribute('data-message-id', message.id);
                                let messageContentHtml = message.text ? `<p class="text-base">${formatMessageText(message.text)}</p>` : '';
                                // Rebuild attachments and timestamp as renderMessage does
                                if (message.attachments && message.attachments.length > 0) {
                                    message.attachments.forEach(att => {
                                        if (att.type && att.type.startsWith('image/')) {
                                            messageContentHtml += `
                                                <div class="attached-image-container ${message.sender === 'user' ? 'text-white' : 'text-gray-800'}">
                                                    <img src="${att.url}" alt="${att.name}" class="attached-image-preview" onerror="this.onerror=null; this.src='https://placehold.co/100x100/CCCCCC/000000?text=Image+Load+Error';" />
                                                    <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="attached-file-link ${message.sender === 'user' ? 'text-white hover:text-gray-100' : 'text-gray-800 hover:text-gray-600'}">
                                                        ${att.name}
                                                    </a>
                                                </div>
                                            `;
                                        } else {
                                            let icon = '📎';
                                            if (att.type && att.type.startsWith('video/')) { icon = '🎥'; }
                                            else if (att.type && att.type.includes('pdf')) { icon = '📄'; }
                                            else if (att.type && att.type.includes('audio/')) { icon = '🔊'; }
                                            messageContentHtml += `
                                                <div class="attached-file ${message.sender === 'user' ? 'text-white' : 'text-gray-800'}">
                                                    <span class="attached-file-icon">${icon}</span>
                                                    <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="attached-file-link ${message.sender === 'user' ? 'text-white hover:text-gray-100' : 'text-gray-800 hover:text-gray-600'}">
                                                        ${att.name}
                                                    </a>
                                                </div>
                                            `;
                                        }
                                    });
                                }
                                const timestampText = formatTimestamp(message.timestamp);
                                const fullTimestampText = getFullTimestamp(message.timestamp);
                                messageContentHtml += `<div class="message-timestamp ${message.sender === 'ai' ? 'ai' : ''}" title="${fullTimestampText}">${timestampText}</div>`;

                                newElement.innerHTML = `<div class="max-w-[70%] px-4 py-2 rounded-xl shadow ${message.sender === 'user' ? 'bg-blue-400 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'}">
                                    ${messageContentHtml}
                                </div>`;
                                // Reattach click listener if it's an AI message
                                if (message.sender === 'ai') {
                                    const innerMessageBubble = newElement.querySelector('.max-w-\\[70\\%\\]');
                                    if (innerMessageBubble) {
                                        innerMessageBubble.addEventListener('click', (event) => {
                                            event.stopPropagation();
                                            showAiMessageActions(message.id, innerMessageBubble, message.feedback);
                                        });
                                    }
                                }
                                existingElement.replaceWith(newElement);
                            }
                        }
                    } else if (change.type === "removed") {
                        // Find and remove from messagesData
                        const index = messagesData.findIndex(m => m.id === message.id);
                        if (index !== -1) {
                            messagesData.splice(index, 1);
                        }
                        // DOM removal is handled by full clear on refresh
                    }
                });
                scrollToBottom();
            }, error => {
                console.error("Error fetching messages:", error);
            });
        };

        // Function to update send button state
        const updateSendButtonState = () => {
            const hasContent = messageInput.value.trim() || pendingAttachments.length > 0;
            sendButton.disabled = !hasContent;

            if (hasContent && sendSpinner.classList.contains('hidden')) {
                sendIcon.classList.remove('hidden');
                sendSpinner.classList.add('hidden');
            } else if (!hasContent && sendSpinner.classList.contains('hidden')) {
                 sendIcon.classList.remove('hidden');
            }
        };

        // Handles sending messages via the API and saving to Firestore
        const sendMessage = async (messageText) => {
            sendIcon.classList.add('hidden');
            sendSpinner.classList.remove('hidden');
            sendButton.disabled = true;
            hideAiMessageActions(); // Hide actions when new message is sent

            if (!messageText.trim() && pendingAttachments.length === 0) {
                sendIcon.classList.remove('hidden');
                sendSpinner.classList.add('hidden');
                sendButton.disabled = true;
                return;
            }

            const userMessage = {
                text: messageText.trim(),
                sender: 'user',
                timestamp: serverTimestamp(), // Use serverTimestamp
                userId: userId,
                attachments: pendingAttachments.length > 0 ? pendingAttachments : null
            };

            pendingAttachments = [];
            pendingAttachmentsDisplay.classList.add('hidden');
            attachedFilesCount.textContent = '0';
            attachedFilesLabel.textContent = 'files ready to send';
            attachedFilesIcon.classList.remove('hidden');
            attachmentSpinner.classList.add('hidden');


            const messagesCollectionPath = `artifacts/${appId}/public/data/chat_messages`;
            try {
                await addDoc(collection(db, messagesCollectionPath), userMessage);

                showTypingIndicator(true);

                // Prepare chat history for AI - always include actual message data
                const chatHistoryForAI = messagesData
                    .filter(msg => msg.timestamp)
                    .map(msg => {
                        let parts = [{ text: msg.text || '' }]; // Ensure text is string
                        if (msg.attachments && msg.attachments.length > 0) {
                            msg.attachments.forEach(att => {
                                if (att.type && att.type.startsWith('image/')) {
                                    // For image understanding, you'd send base64 data, not just URL text
                                    // This is a placeholder for now
                                    parts.push({ text: `[Image attachment: ${att.url}]` });
                                } else {
                                    parts.push({ text: `[File attachment: ${att.name}, URL: ${att.url}]` });
                                }
                            });
                        }
                        return { role: msg.sender === 'user' ? 'user' : 'model', parts: parts };
                    });

                const payload = { contents: chatHistoryForAI };
                // Using canvasApiKey directly to fix the 401 error
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${canvasApiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) { // Check if response was successful (status 2xx)
                    const errorText = await response.text();
                    console.error(`API Error: ${response.status} - ${response.statusText}`, errorText);
                    showTypingIndicator(false); // Hide typing indicator on API error
                    await addDoc(collection(db, messagesCollectionPath), {
                        text: `API request failed: ${response.status} ${response.statusText}. Please check your network or API key configuration.`,
                        sender: 'ai',
                        timestamp: serverTimestamp(),
                        userId: userId,
                        feedback: null
                    });
                    return; // Exit if the response was not OK
                }

                let result;
                try {
                    result = await response.json(); // Attempt to parse JSON
                } catch (jsonError) {
                    console.error("Error parsing AI response JSON:", jsonError);
                    console.error("API response text:", await response.text()); // Log raw response text for debugging
                    setTimeout(() => {
                        showTypingIndicator(false);
                    }, 200);
                    await addDoc(collection(db, messagesCollectionPath), {
                        text: "I'm having trouble processing the response from the AI. Please try again.",
                        sender: 'ai',
                        timestamp: serverTimestamp(),
                        userId: userId,
                        feedback: null
                    });
                    return; // Exit if JSON parsing fails
                }


                setTimeout(async () => {
                    showTypingIndicator(false);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponseText = result.candidates[0].content.parts[0].text;

                        const aiMessage = {
                            text: aiResponseText,
                            sender: 'ai',
                            timestamp: serverTimestamp(),
                            userId: userId,
                            feedback: null // Initialize feedback
                        };
                        await addDoc(collection(db, messagesCollectionPath), aiMessage);
                    } else {
                        console.error("AI response structure unexpected:", result);
                        await addDoc(collection(db, messagesCollectionPath), {
                            text: "I'm having trouble understanding. Could you please rephrase? (AI response structure unexpected)",
                            sender: 'ai',
                            timestamp: serverTimestamp(),
                            userId: userId,
                            feedback: null
                        });
                    }
                }, 500);

            } catch (error) {
                console.error("Error sending message or getting AI response:", error);
                setTimeout(() => {
                    showTypingIndicator(false);
                }, 200);
                await addDoc(collection(db, messagesCollectionPath), {
                    text: "An error occurred while communicating with the AI. Please try again.",
                    sender: 'ai',
                    timestamp: serverTimestamp(),
                    userId: userId,
                    feedback: null
                });
            } finally {
                sendIcon.classList.remove('hidden');
                sendSpinner.classList.add('hidden');
                updateSendButtonState();
            }
        };

        // Function to update message feedback
        const updateMessageFeedback = async (messageId, feedbackType) => {
            const messagesCollectionPath = `artifacts/${appId}/public/data/chat_messages`;
            const messageDocRef = doc(db, messagesCollectionPath, messageId);

            const currentMessage = messagesData.find(msg => msg.id === messageId);
            let newFeedback = null;

            if (currentMessage && currentMessage.feedback === feedbackType) {
                // If already liked/disliked, toggle off
                newFeedback = null;
            } else {
                // Set new feedback
                newFeedback = feedbackType;
            }

            try {
                await updateDoc(messageDocRef, { feedback: newFeedback });
                console.log(`Message ${messageId} feedback updated to: ${newFeedback}`);
            } catch (error) {
                console.error("Error updating message feedback:", error);
            }
        };

        // --- Chat Modal Control Functions ---
        function openChatModal() {
            chatModal.style.display = 'flex';
            chatWidget.classList.remove('hidden');
            chatWidget.classList.add('chat-widget-enter');
            chatWidget.addEventListener('animationend', () => {
                chatWidget.classList.remove('chat-widget-enter');
            }, { once: true });
            messageInput.focus();
            scrollToBottom('auto'); // Jump to bottom quickly on open
            updateOnlineStatusDisplay();
            hideAiMessageActions(); // Ensure actions are hidden when modal opens
        }

        function closeChatModal() {
            chatWidget.classList.add('chat-widget-exit');
            chatWidget.addEventListener('animationend', () => {
                chatModal.style.display = 'none';
                chatWidget.classList.add('hidden');
                chatWidget.classList.remove('chat-widget-exit');
            }, { once: true });
            showTypingIndicator(false);
            updateOnlineStatusDisplay();
            pendingAttachmentsDisplay.classList.add('hidden');
            hideAiMessageActions(); // Hide actions on close
        }


        // --- Event Listeners ---

        openAddReminderModalButton.addEventListener('click', openAddReminderModal);
        svgActionButton.addEventListener('click', openChatModal); // NEW: Event listener for the new SVG button to open chat

        addTopicForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const topicName = topicNameInput.value.trim();
            const subject = addSubjectSelect.value; // This is the canonical subject name
            const startDate = startDateInput.value;

            if (topicName && subject && startDate) {
                addTopic(topicName, subject, startDate);
                closeAddReminderModal();
            } else {
                console.warn('Please fill in all fields (topic name, subject, and start date).');
                customAlert('Please fill in all fields (topic name, subject, and start date).', 'Input Required');
            }
        });

        closeAddReminderModalButton.addEventListener('click', closeAddReminderModal);
        addReminderModal.addEventListener('click', (e) => {
            if (e.target === addReminderModal) {
                closeAddReminderModal();
            }
        });


        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('mark-reviewed-button')) {
                const id = e.target.dataset.id; // Firestore doc ID is string
                markAsReviewed(id);
            } else if (e.target.classList.contains('settings-button') || e.target.closest('.settings-button')) {
                const id = e.target.closest('.settings-button').dataset.id; // Firestore doc ID is string
                openSettingsModal(id);
            }
        });

        filterSubjectSelect.addEventListener('change', (e) => {
            currentFilterSubject = e.target.value; // This is the canonical subject name or 'All'
            showOnlyIncomplete = false;
            incompleteTopicsButton.classList.remove('active');
            renderReminders();
        });

        incompleteTopicsButton.addEventListener('click', () => {
            showOnlyIncomplete = !showOnlyIncomplete;
            if (showOnlyIncomplete) {
                incompleteTopicsButton.classList.add('active');
            } else {
                incompleteTopicsButton.classList.remove('active');
            }
            renderReminders();
        });

        myProgressButton.addEventListener('click', () => {
            myProgressModal.style.display = 'flex';
            renderProgressChart();
        });

        closeMyProgressModalButton.addEventListener('click', () => {
            myProgressModal.style.display = 'none';
        });
        closeProgressModalFooterButton.addEventListener('click', () => {
            myProgressModal.style.display = 'none';
        });
        myProgressModal.addEventListener('click', (e) => {
            if (e.target === myProgressModal) {
                myProgressModal.style.display = 'none';
            }
        });


        closeModalButton.addEventListener('click', closeSettingsModal);
        cancelModalButton.addEventListener('click', closeSettingsModal);
        saveModalButton.addEventListener('click', saveReminderChanges);
        deleteReminderButton.addEventListener('click', deleteReminder);
        resetPatternButton.addEventListener('click', resetSpacedRepetitionPattern);

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeSettingsModal();
            }
        });

        settingsDropdownButton.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsMenu.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            if (!settingsDropdownButton.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.remove('show');
            }
        });

        backupDataButton.addEventListener('click', () => {
            exportToCSV(allReminders, 'reminders_backup');
            settingsMenu.classList.remove('show');
            customAlert('All reminders backed up to a CSV file!', 'Backup Complete');
        });

        exportDataButton.addEventListener('click', () => {
            exportToCSV(allReminders, 'reminders_export');
            settingsMenu.classList.remove('show');
            customAlert('All reminders exported to a CSV file!', 'Export Complete');
        });

        importDataButton.addEventListener('click', () => {
            settingsMenu.classList.remove('show');
            importFromCSV();
        });

        // NEW: Event listeners for Change Subjects modal
        openChangeSubjectsModalButton.addEventListener('click', openChangeSubjectsModal);
        closeChangeSubjectsModalButton.addEventListener('click', closeChangeSubjectsModal);
        cancelChangeSubjectsButton.addEventListener('click', closeChangeSubjectsModal);
        saveChangeSubjectsButton.addEventListener('click', saveSubjectDisplayNamesFromModal);
        changeSubjectsModal.addEventListener('click', (e) => {
            if (e.target === changeSubjectsModal) {
                closeChangeSubjectsModal();
            }
        });

        // NEW: Event listener for Migrate Local Storage button
        migrateLocalStorageButton.addEventListener('click', migrateLocalDataToFirestore);

        /**
         * Exports the current reminders data to a CSV file.
         * @param {Array<Object>} data - The array of reminder objects to export.
         * @param {string} filenamePrefix - Prefix for the downloaded filename.
         */
        function exportToCSV(data, filenamePrefix) {
            if (data.length === 0) {
                customAlert('No reminders to export!', 'Export Empty');
                return;
            }

            const headers = [
                'id', 'name', 'subject', 'startDate', 'lastReviewDate', 
                'nextReviewDate', 'lastInterval', 'reviewCount', 'customIntervalsArray'
            ];

            const csvRows = [];
            csvRows.push(headers.join(','));

            data.forEach(reminder => {
                const values = headers.map(header => {
                    let value = reminder[header];
                    if (value instanceof Date) {
                        value = formatDate(value); // Format Date objects to thereunder-MM-DD
                    } else if (Array.isArray(value)) {
                        value = value.join(';'); // Join array elements with semicolon
                    }
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`; // Handle commas and quotes in strings
                    }
                    return value;
                    return value;
                });
                csvRows.push(values.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filenamePrefix}_${formatDate(new Date())}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Initiates the import process by opening a file input and handling the selected file.
         */
        function importFromCSV() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';

            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }

                if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                    showErrorMessage("Wrong file type - Please provide a .csv file containing the cases you want to import. It's recommended to use the case import template file as a starting point.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    parseAndImportCSV(event.target.result);
                };
                reader.onerror = () => {
                    showErrorMessage('Failed to read file. Please tryH again.');
                };
                reader.readAsText(file);
            };

            fileInput.click();
        }

        /**
         * Parses the CSV content and integrates it into the reminders data in Firestore.
         * Assumes the first row is headers. Existing reminders are updated by ID, new ones are added.
         * @param {string} csvText - The content of the CSV file.
         */
        async function parseAndImportCSV(csvText) {
            if (!isFirebaseReady) {
                showErrorMessage("Firebase not ready. Cannot import data.");
                return;
            }

            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 1) {
                showErrorMessage('CSV file is empty or invalid.');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const expectedHeaders = ['id', 'name', 'subject', 'startDate', 'lastReviewDate', 'nextReviewDate', 'lastInterval', 'reviewCount', 'customIntervalsArray'];

            if (!expectedHeaders.every(h => headers.includes(h))) {
                 showErrorMessage("Wrong file format. Please provide a .csv file with correct headers. Expected: " + expectedHeaders.join(', '));
                return;
            }

            const importedReminders = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Split by comma, respecting quotes
                const reminder = {};
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
                    continue;
                }

                headers.forEach((header, index) => {
                    let value = values[index].trim();
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1).replace(/""/g, '"');
                    }

                    if (header === 'id') {
                        // For import, we use original ID if it's a valid string, otherwise null to create new
                        reminder[header] = value; // Store as string (Firestore doc ID)
                    } else if (header === 'lastInterval' || header === 'reviewCount') {
                        reminder[header] = parseInt(value, 10);
                        if (isNaN(reminder[header])) {
                            reminder[header] = 0;
                        }
                    } else if (['startDate', 'lastReviewDate', 'nextReviewDate'].includes(header)) {
                        reminder[header] = parseDate(value); // Convert to Date object
                        if (isNaN(reminder[header].getTime())) {
                             reminder[header] = new Date(); // Fallback to current date
                        }
                    } else if (header === 'customIntervalsArray') {
                        reminder[header] = value ? value.split(';').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n > 0) : [];
                    } else {
                        // For subject, ensure it's a canonical subject. If not, default to 'Other'.
                        if (header === 'subject') {
                            reminder[header] = CANONICAL_SUBJECTS.includes(value) ? value : 'Other';
                        } else {
                            reminder[header] = value;
                        }
                    }
                });
                importedReminders.push(reminder);
            }

            if (importedReminders.length === 0) {
                showErrorMessage('No valid reminders found in the CSV file to import.');
                return;
            }

            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = 'Importing data...';

            let importedCount = 0;
            for (const importedReminder of importedReminders) {
                try {
                    const existingDocId = allReminders.find(r => r.id === importedReminder.id)?.id; // Check if ID matches existing Firestore doc
                    const reminderData = {
                        name: importedReminder.name,
                        subject: importedReminder.subject,
                        startDate: importedReminder.startDate,
                        lastReviewDate: importedReminder.lastReviewDate,
                        nextReviewDate: importedReminder.nextReviewDate,
                        lastInterval: importedReminder.lastInterval,
                        reviewCount: importedReminder.reviewCount,
                        customIntervalsArray: importedReminder.customIntervalsArray
                    };

                    if (existingDocId) {
                        // Update existing document
                        await setDoc(doc(db, "artifacts", appId, "users", userId, "reminders", existingDocId), reminderData);
                    } else {
                        // Add as a new document
                        await addDoc(collection(db, "artifacts", appId, "users", userId, "reminders"), reminderData);
                    }
                    importedCount++;
                } catch (e) {
                    console.error("Error importing reminder to Firestore:", e);
                    // Continue even if one fails, show a general error later
                }
            }

            customAlert(`Import complete. ${importedCount} reminders processed.`, 'Import Complete');
            hideErrorMessage();
            loadingOverlay.style.display = 'none';
            loadingOverlay.textContent = 'Loading Reminders...'; // Reset text
        }


        // --- Login Modal Functions ---

        /**
         * Shows the login modal and hides the main app content.
         */
        function showLoginModal() {
            loginModal.style.display = 'flex';
            mainAppContainer.style.display = 'none';
            chatModal.style.display = 'none'; // Ensure chat modal is hidden
            loadingOverlay.style.display = 'none';
            // Reset input fields and errors when showing
            emailInputLogin.value = '';
            passwordInputLogin.value = '';
            emailErrorLogin.classList.add('hidden');
            passwordErrorLogin.classList.add('hidden');
            authErrorMessage.classList.add('hidden');
            setAuthMode(true); // Default to sign-in mode
        }

        /**
         * Hides the login modal and shows the main app content.
         */
        function hideLoginModal() {
            loginModal.style.display = 'none';
            mainAppContainer.style.display = 'block';
            authLoadingIndicator.classList.add('hidden'); // Hide loading indicator
            authErrorMessage.classList.add('hidden'); // Hide any auth error messages
        }

        /**
         * Toggles between Sign In and Sign Up modes for the login form.
         * @param {boolean} signInMode - True for Sign In, false for Sign Up.
         */
        function setAuthMode(signInMode) {
            isSignInMode = signInMode;
            if (isSignInMode) {
                loginHeaderTitle.textContent = "Welcome back";
                loginHeaderSubtitle.textContent = "Please enter your details";
                authActionButton.textContent = "Sign In";
                toggleAuthModeLink.textContent = "Sign up";
                forgotPasswordLink.style.display = 'block';
            } else {
                loginHeaderTitle.textContent = "Create an account";
                loginHeaderSubtitle.textContent = "Join us to start managing your studies!";
                authActionButton.textContent = "Sign Up";
                toggleAuthModeLink.textContent = "Sign In";
                forgotPasswordLink.style.display = 'none'; // Hide for sign up
            }
            // Clear any previous input errors
            emailErrorLogin.classList.add('hidden');
            passwordErrorLogin.classList.add('hidden');
            emailInputLogin.classList.remove('input-error');
            passwordInputLogin.classList.remove('input-error');
            authErrorMessage.classList.add('hidden');
        }

        /**
         * Handles email/password authentication (Sign In or Sign Up).
         */
        async function handleEmailAuth() {
            const email = emailInputLogin.value.trim();
            const password = passwordInputLogin.value.trim();

            // Reset errors
            emailErrorLogin.classList.add('hidden');
            passwordErrorLogin.classList.add('hidden');
            emailInputLogin.classList.remove('input-error');
            passwordInputLogin.classList.remove('input-error');
            authErrorMessage.classList.add('hidden');

            let hasError = false;

            if (!email) {
                emailErrorLogin.textContent = "Email is required.";
                emailErrorLogin.classList.remove('hidden');
                emailInputLogin.classList.add('input-error');
                hasError = true;
            } else if (!email.includes('@')) {
                emailErrorLogin.textContent = "Please enter a valid email address.";
                emailErrorLogin.classList.remove('hidden');
                emailInputLogin.classList.add('input-error');
                hasError = true;
            }

            if (!password) {
                passwordErrorLogin.textContent = "Password is required.";
                passwordErrorLogin.classList.remove('hidden');
                passwordInputLogin.classList.add('input-error');
                hasError = true;
            } else if (password.length < 6) {
                passwordErrorLogin.textContent = "Password must be at least 6 characters long.";
                passwordErrorLogin.classList.remove('hidden');
                passwordInputLogin.classList.add('input-error');
                hasError = true;
            }

            if (hasError) return;

            authLoadingIndicator.classList.remove('hidden');

            try {
                if (isSignInMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("User signed in with email.");
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    console.log("User signed up with email.");
                    customAlert('Account created successfully! You are now logged in.', 'Success');
                }
                // onAuthStateChanged listener will handle hiding modal and showing app
            } catch (error) {
                console.error("Authentication error:", error.code, error.message);
                let displayMessage = "An unknown error occurred.";

                switch (error.code) {
                    case 'auth/invalid-email':
                        displayMessage = "Invalid email format.";
                        emailInputLogin.classList.add('input-error');
                        break;
                    case 'auth/user-disabled':
                        displayMessage = "Your account has been disabled.";
                        break;
                    case 'auth/user-not-found':
                        displayMessage = "No user found with this email. Please sign up.";
                        emailInputLogin.classList.add('input-error');
                        break;
                    case 'auth/wrong-password':
                        displayMessage = "Incorrect password.";
                        passwordInputLogin.classList.add('input-error');
                        break;
                    case 'auth/email-already-in-use':
                        displayMessage = "This email is already in use. Try signing in.";
                        emailInputLogin.classList.add('input-error');
                        break;
                    case 'auth/weak-password':
                        displayMessage = "Password is too weak. Please choose a stronger password.";
                        passwordInputLogin.classList.add('input-error');
                        break;
                    case 'auth/operation-not-allowed':
                        displayMessage = "Email/password login is not enabled. Contact support.";
                        break;
                    default:
                        displayMessage = error.message;
                        break;
                }
                authErrorMessage.textContent = displayMessage;
                authErrorMessage.classList.remove('hidden');
            } finally {
                authLoadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Handles Google Sign-In using a popup.
         */
        async function handleGoogleAuth() {
            authLoadingIndicator.classList.remove('hidden');
            authErrorMessage.classList.add('hidden'); // Hide previous errors
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                console.log("User signed in with Google.");
                // onAuthStateChanged listener will handle hiding modal and showing app
            } catch (error) {
                console.error("Google Sign-In error:", error.code, error.message);
                let displayMessage = "Failed to sign in with Google.";

                if (error.code === 'auth/popup-closed-by-user') {
                    displayMessage = "Google Sign-In popup was closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    displayMessage = "Another sign-in popup was already open.";
                } else if (error.code === 'auth/auth-domain-config-required') {
                    displayMessage = "Authentication domain configuration is missing.";
                } else if (error.code === 'auth/popup-blocked') { // Specific handling for popup-blocked
                    displayMessage = "Pop-up blocked by your browser. Please allow pop-ups for this site and try again.";
                } else {
                    displayMessage += ` (${error.message})`;
                }
                authErrorMessage.textContent = displayMessage;
                authErrorMessage.classList.remove('hidden');
            } finally {
                authLoadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Handles user logout.
         */
        async function handleSignOut() {
            const confirmed = await customAlert('Are you sure you want to log out?', 'Confirm Logout', true);
            if (confirmed) {
                try {
                    await signOut(auth);
                    console.log("User signed out.");
                    // onAuthStateChanged listener will handle showing login modal
                    settingsMenu.classList.remove('show'); // Close main settings dropdown
                    profileModal.style.display = 'none'; // Close profile modal if open
                    customAlert('You have been successfully logged out.', 'Logged Out');
                } catch (error) {
                    console.error("Error signing out:", error);
                    showErrorMessage("Failed to log out: " + error.message);
                }
            }
        }

        // --- Profile Modal Functions ---

        /**
         * Shows the My Profile modal.
         */
        async function openProfileModal() {
            profileModal.style.display = 'flex';
            settingsMenu.classList.remove('show'); // Close settings dropdown

            const user = auth.currentUser;
            if (user && db && userId) {
                const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'details');
                
                // Fetch current user data from Firebase Auth
                const userData = {
                    name: user.displayName,
                    email: user.email,
                    emailVerified: user.emailVerified,
                    photoURL: user.photoURL,
                    role: 'User', // Default role
                    status: 'Active' // Default status
                };

                // Listen for real-time updates from Firestore profile data
                onSnapshot(profileDocRef, (docSnap) => {
                    let firestoreData = {};
                    if (docSnap.exists()) {
                        firestoreData = docSnap.data();
                        console.log("Profile data fetched from Firestore:", firestoreData);
                    } else {
                        console.log("No custom profile data in Firestore. Using Firebase Auth defaults.");
                        // Create initial profile data in Firestore if it doesn't exist
                        setDoc(profileDocRef, userData, { merge: true })
                            .then(() => console.log("Initial profile document created in Firestore."))
                            .catch(error => console.error("Error creating initial profile document:", error));
                    }
                    
                    // Merge Firebase Auth data with Firestore data (Firestore overrides Auth)
                    const mergedData = { ...userData, ...firestoreData };
                    updateProfileUI(mergedData);
                }, (error) => {
                    console.error("Error listening to profile data:", error);
                    showErrorMessage("Error loading profile details: " + error.message);
                    // Fallback to only Firebase Auth data if Firestore listener fails
                    updateProfileUI(userData);
                });

            } else {
                // Handle case where no user is logged in (should be caught by onAuthStateChanged, but as fallback)
                updateProfileUI({
                    name: 'Guest User',
                    email: 'guest@example.com',
                    role: 'Guest',
                    emailVerified: false,
                    status: 'Inactive',
                    photoURL: 'https://placehold.co/128x128/D1D5DB/4B5563?text=User'
                });
            }
        }

        /**
         * Hides the My Profile modal.
         */
        function closeProfileModal() {
            profileModal.style.display = 'none';
        }

        /**
         * Updates the UI with user profile data.
         * @param {Object} userData - Object containing user data.
         */
        function updateProfileUI(userData) {
            profileImage.src = userData.photoURL || 'https://placehold.co/128x128/D1D5DB/4B5563?text=User';
            displayName.textContent = userData.name || 'N/A';
            displayNameEditable.textContent = userData.name || 'N/A'; // For tap to open modal
            modalEditNameInput.value = userData.name || ''; // Set modal input value

            displayEmail.textContent = userData.email || 'N/A';
            displayEmailDetailed.textContent = userData.email || 'N/A';
            displayRole.textContent = userData.role || 'User';
            displayLocation.textContent = userData.location || 'United States'; // Assuming a default location

            // Update Email Verification display and badge
            displayEmailVerification.textContent = userData.emailVerified ? 'Verified' : 'Pending';
            displayEmailVerification.classList.toggle('email-verified', userData.emailVerified);
            displayEmailVerification.classList.toggle('email-pending', !userData.emailVerified);

            if (emailVerifiedBadge) {
                emailVerifiedBadge.classList.toggle('hidden', !userData.emailVerified);
            }

            displayStatus.textContent = userData.status || 'Active';
            displayStatus.classList.toggle('status-active', userData.status === 'Active');
            displayStatus.classList.toggle('status-inactive', userData.status !== 'Active');
            
            // Display full User ID
            displayUserId.textContent = userId;

            // Show/hide sign out button based on if a user is authenticated (not anonymous)
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                signOutProfileButton.classList.add('show');
                profileInfoContainerLeft.classList.add('shift-up');
            } else {
                signOutProfileButton.classList.remove('show');
                profileInfoContainerLeft.classList.remove('shift-up');
            }
        }

        /**
         * Updates the user's name in Firestore.
         * @param {string} newName - The new name to set.
         */
        async function updateUserName(newName) {
            if (!db || !userId || !auth.currentUser) {
                showErrorMessage("You must be logged in to update your profile.", true);
                return;
            }

            const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'details');
            try {
                await setDoc(profileDocRef, { name: newName }, { merge: true });
                // Also update Firebase Auth profile if the user is not anonymous and has a providable name
                if (!auth.currentUser.isAnonymous && auth.currentUser.providerData.length > 0) {
                     // Check if a provider (like Google) is linked, then update display name
                    await auth.currentUser.updateProfile({ displayName: newName });
                }
                customAlert("Name updated successfully!");
                closeNameEditModal();
            } catch (error) {
                console.error("Error updating name:", error);
                showErrorMessage("Failed to update name: " + error.message, true);
            }
        }

        /**
         * Opens the name edit modal.
         */
        function openNameEditModal() {
            nameEditModalOverlay.style.display = 'flex'; // Use flex to center
            modalEditNameInput.value = displayNameEditable.textContent; // Pre-fill with current name
            modalEditNameInput.focus();
            modalEditNameInput.select();
        }

        /**
         * Closes the name edit modal.
         */
        function closeNameEditModal() {
            nameEditModalOverlay.style.display = 'none';
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseAndAuth(); // Start Firebase initialization and auth

            // Set filter subject to the canonical name and then populate dropdown
            filterSubjectSelect.value = currentFilterSubject;
            
            const today = new Date();
            startDateInput.value = formatDate(today);

            // Initializing element references for progress bars
            SUBJECT_ORDER_FOR_CHART.forEach(subjectKey => {
                const key = subjectKey.toLowerCase();
                subjectProgressData[key].circleElement = document.querySelector(`.progress-${key}`);
                subjectProgressData[key].percentageTextElement = document.querySelector(`#${key}Percentage`);
                subjectProgressData[key].labelElement = document.querySelector(`.progress-${key} .label`);

                if (subjectProgressData[key].percentageTextElement) {
                    subjectProgressData[key].percentageTextElement.style.color = '#ffffff';
                    subjectProgressData[key].percentageTextElement.style.filter = 'none';
                }
                if (subjectProgressData[key].labelElement) {
                    // Set initial label text using custom display name
                    subjectProgressData[key].labelElement.textContent = subjectDisplayNames[subjectKey];
                    subjectProgressData[key].labelElement.style.color = '#ffffff';
                    subjectProgressData[key].labelElement.style.filter = 'none';
                }
                if (subjectProgressData[key].circleElement) {
                    subjectProgressData[key].circleElement.style.background = `conic-gradient(${subjectProgressData[key].color} 0deg, transparent 0deg)`;
                    subjectProgressData[key].percentageTextElement.textContent = `0%`;
                }
            });

            // Add event listener for window resize to re-render reminders
            window.addEventListener('resize', renderReminders);

            // Login modal event listeners
            toggleAuthModeLink.addEventListener('click', (e) => {
                e.preventDefault();
                setAuthMode(!isSignInMode); // Toggle the mode
            });

            authActionButton.addEventListener('click', handleEmailAuth);
            googleSignInButton.addEventListener('click', handleGoogleAuth);
            
            // Replaced logoutButton with myProfileButton
            myProfileButton.addEventListener('click', openProfileModal);

            // Profile Modal Event Listeners
            closeProfileModalButton.addEventListener('click', closeProfileModal);
            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    closeProfileModal();
                }
            });
            signOutProfileButton.addEventListener('click', handleSignOut); // Logout now tied to button inside profile modal

            // Name Edit Modal Listeners (within Profile Modal's context)
            displayNameEditable.addEventListener('click', openNameEditModal); // Tap to edit name
            modalSaveNameButton.addEventListener('click', () => {
                const newName = modalEditNameInput.value.trim();
                if (newName) {
                    updateUserName(newName);
                } else {
                    showErrorMessage("Name cannot be empty.", true);
                }
            });
            modalCancelButton.addEventListener('click', closeNameEditModal);
            nameEditModalOverlay.addEventListener('click', (event) => {
                if (event.target === nameEditModalOverlay) {
                    closeNameEditModal();
                }
            });
            modalEditNameInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    modalSaveNameButton.click();
                }
            });

            // Clear login errors on input
            emailInputLogin.addEventListener('input', () => {
                emailErrorLogin.classList.add('hidden');
                emailInputLogin.classList.remove('input-error');
                authErrorMessage.classList.add('hidden');
            });
            passwordInputLogin.addEventListener('input', () => {
                passwordErrorLogin.classList.add('hidden');
                passwordInputLogin.classList.remove('input-error');
                authErrorMessage.classList.add('hidden');
            });

            // Prevent default form submission if login modal was a form
            if (loginModal.querySelector('form')) {
                loginModal.querySelector('form').addEventListener('submit', (e) => e.preventDefault());
            }

            // --- Chatbot Event Listeners (moved and adapted) ---
            messageInput.addEventListener('input', updateSendButtonState);

            sendButton.addEventListener('mousedown', () => {
                if (!sendButton.disabled) {
                    sendButton.classList.add('send-button-pressed');
                }
            });
            sendButton.addEventListener('mouseup', () => {
                sendButton.classList.remove('send-button-pressed');
            });
            sendButton.addEventListener('mouseleave', () => {
                sendButton.classList.remove('send-button-pressed');
            });
            sendButton.addEventListener('touchstart', () => {
                if (!sendButton.disabled) {
                    sendButton.classList.add('send-button-pressed');
                }
            });
            sendButton.addEventListener('touchend', () => {
                sendButton.classList.remove('send-button-pressed');
            });

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value;
                sendMessage(message);
                messageInput.value = '';
            });

            // Chat Widget Close Button
            chatCloseButton.addEventListener('click', closeChatModal);

            chatRefreshButton.addEventListener('click', async (event) => {
                const refreshButton = event.currentTarget;
                refreshButton.classList.add('rotate-on-tap');
                hideAiMessageActions(); // Hide actions on refresh

                const messages = chatHistoryDiv.querySelectorAll('.mb-2');
                if (messages.length > 0) {
                    messages.forEach(msg => {
                        msg.classList.add('message-exit-animation');
                    });
                    setTimeout(() => {
                        chatHistoryDiv.innerHTML = '';
                        messagesData.length = 0;
                        scrollToBottom('auto');
                        addIndicatorMessage("New Chat Started!");
                    }, 300);
                } else {
                    chatHistoryDiv.innerHTML = '';
                    messagesData.length = 0;
                    scrollToBottom('auto');
                    addIndicatorMessage("New Chat Started!");
                }
                
                showTypingIndicator(false);
                pendingAttachments = [];
                messageInput.value = '';
                pendingAttachmentsDisplay.classList.add('hidden');
                attachedFilesCount.textContent = '0';
                attachedFilesLabel.textContent = 'files ready to send';
                attachedFilesIcon.classList.remove('hidden');
                attachmentSpinner.classList.add('hidden');
                updateSendButtonState();
                console.log("Chat history refreshed.");
                updateOnlineStatusDisplay();

                refreshButton.addEventListener('animationend', () => {
                    refreshButton.classList.remove('rotate-on-tap');
                }, { once: true });
            });

            // Attachment functionality and Pulse Highlight
            attachmentButton.addEventListener('click', (event) => { 
                event.stopPropagation();
                attachmentButton.classList.add('attachment-button-pulse');
                attachmentButton.addEventListener('animationend', () => {
                    attachmentButton.classList.remove('attachment-button-pulse');
                }, { once: true });
                fileInput.click();
                hideAiMessageActions(); // Hide actions when opening file picker
            });

            fileInput.addEventListener('change', async (event) => {
                const files = event.target.files;
                if (files.length > 0) {
                    pendingAttachmentsDisplay.classList.remove('hidden');
                    attachedFilesIcon.classList.add('hidden');
                    attachedFilesCount.textContent = '';
                    attachedFilesLabel.textContent = 'Uploading files...';
                    attachmentSpinner.classList.remove('hidden');

                    messageInput.placeholder = `Uploading ${files.length} file(s)...`;
                    messageInput.disabled = true;
                    sendButton.disabled = true;
                    
                    pendingAttachments = [];

                    const uploadPromises = Array.from(files).map(async file => {
                        try {
                            const uploadedFileInfo = await uploadFile(file);
                            pendingAttachments.push(uploadedFileInfo);
                        } catch (error) {
                            console.error(`Failed to upload ${file.name}:`, error);
                        }
                    });

                    await Promise.all(uploadPromises);

                    messageInput.placeholder = "Enter message...";
                    messageInput.disabled = false;
                    
                    if (pendingAttachments.length > 0) {
                        attachedFilesCount.textContent = pendingAttachments.length;
                        attachedFilesLabel.textContent = 'files ready to send';
                        attachedFilesIcon.classList.remove('hidden');
                        pendingAttachmentsDisplay.classList.remove('hidden');
                    } else {
                        pendingAttachmentsDisplay.classList.add('hidden');
                        attachedFilesCount.textContent = '0';
                        attachedFilesLabel.textContent = 'files ready to send';
                        attachedFilesIcon.classList.remove('hidden');
                    }
                    attachmentSpinner.classList.add('hidden');
                    updateSendButtonState();
                    messageInput.focus();
                    fileInput.value = '';
                }
            });

            // Clear attachments button handler
            clearAttachmentsButton.addEventListener('click', () => {
                pendingAttachments = [];
                pendingAttachmentsDisplay.classList.add('hidden');
                attachedFilesCount.textContent = '0';
                attachedFilesLabel.textContent = 'files ready to send';
                attachedFilesIcon.classList.remove('hidden');
                attachmentSpinner.classList.add('hidden');
                updateSendButtonState();
                messageInput.focus();
                hideAiMessageActions(); // Hide actions on clearing attachments
            });

            // Event listeners for online/offline status
            window.addEventListener('online', updateOnlineStatusDisplay);
            window.addEventListener('offline', updateOnlineStatusDisplay);

            // Click outside to hide AI message actions
            document.addEventListener('click', (event) => {
                if (activeAiMessageElement && !activeAiMessageElement.contains(event.target) && !aiMessageActions.contains(event.target)) {
                    hideAiMessageActions();
                }
            });

            // Copy message to clipboard
            copyButton.addEventListener('click', () => {
                if (activeAiMessageElement) {
                    const textToCopy = activeAiMessageElement.querySelector('p').textContent; // Get the text content of the message
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = textToCopy;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    hideAiMessageActions(); // Hide actions after copy
                    console.log("Message copied to clipboard!");
                }
            });

            // Regenerate response
            regenerateButton.addEventListener('click', () => {
                hideAiMessageActions(); // Hide actions immediately

                // Find the last user message from messagesData to regenerate context
                const lastUserMessage = messagesData
                    .slice() // Create a shallow copy to reverse without affecting original
                    .reverse()
                    .find(msg => msg.sender === 'user');

                if (lastUserMessage && lastUserMessage.text) {
                    // Re-send the last user message's text
                    sendMessage(lastUserMessage.text);
                    messageInput.value = ''; // Clear input field
                    console.log("Regenerating response based on last user message.");
                } else {
                    console.log("No previous user message found to regenerate.");
                }
            });

            // Like/Dislike functionality
            likeButton.addEventListener('click', () => {
                if (activeAiMessageId) {
                    updateMessageFeedback(activeAiMessageId, 'liked');
                }
            });

            dislikeButton.addEventListener('click', () => {
                if (activeAiMessageId) {
                    updateMessageFeedback(activeAiMessageId, 'disliked');
                }
            });
        });
    </script>
</body>
</html>

